---
title: "Discount Elasticity Analysis for Cereals"
author: "Tanetpong"
date: "23/11/2021"
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../gen/analysis") })
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(dplyr) #for mutate factor level of brand
library(plyr) #for revalue function for brand
library(data.table) #for set DT checking brand
library(car) #testing differences in coefficients using frequentist way
library(lmtest) #testing for relevance of the variable using likelihood ratio
```

# Data Management

```{r read data, echo=FALSE}
df_scanner <- read.csv("../../data/df_scanner.csv")
categorydf <- "Soft drinks"
df <-subset(df_scanner,category == categorydf)
df <- df %>% mutate(brand=droplevels(brand)) #Because the subset function doesnt drop the factor per se
df <- df %>% mutate(vecka=droplevels(as.factor(vecka))) #In case some categories doesnt have full week like another
#for simplicity, we will drop online sales for now (due to small data)
df_online <- subset(df, saljkanal == 1)
message(paste("The total number of weekly online sold for this category:", dim(df_online)[1]))
df <- subset(df, saljkanal == 0)
remove(list=c("df_scanner", "df_online")) #remove unnecessary file to make environment clean
df_holiday <- read.csv("../../data/weeklyholiday.csv")
df_holiday$vecka <- as.factor(df_holiday$vecka)
storeformat <- c("hypermarket","convenience","supermarket")
distinctformat<-unique(as.factor(storeformat))

#df <- df[df$sales_volume>=1,] #there are 20 obs

#df <- df[!df$sales_volume%%1,]
#table(df$sales_volume) check if there is any decimal 
```

```{r Rename the brand of cereal for consistency, be careful of non-roman character, include=FALSE}
knitr::kable(table(df$brand),col.names = c('Brand','Frequency'))
df$brand<- revalue(df$brand, c(
              "COCA-COLA"="Coca-Cola",
              "COCA COLA"="Coca-Cola",
              "Coca-Cola life"="Coca-Cola",
              "FANTA" = "Fanta",
              "Fanta Zero" = "Fanta",
              "MOUNTAIN DEW" = "Mountain Dew",
              "PEPSI" = "Pepsi",
              "SAN PELLEGRINO"="San Pellegrino",
              "Sodastream EXTERN" = "Sodastream",
              "Sprite Zero"="Sprite",
              "Three Hearts"="THREE HEARTS"
              ))
knitr::kable(table(df$brand),col.names = c('Brand After Revalue','Frequency'))
```


```{r select the brand with every weekly sales in all formats regardless of sku, echo=FALSE}
#create a table of distinct week
distinctweek<-unique(df$vecka)
message(paste("The total number of week sold for this category:", length(distinctweek)))
#calculate the brand sales by week
distinctbrand<-unique(df$brand)
message(paste("The total number of brand for this category:", length(distinctbrand)))
brandsalecount<-setDT(df)[, .N, .(vecka,brand,format)]
brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand,format)]#we count if the brand got shown in the scanner data each week in each format
#select the brand that have complete week
brandcompleteweek<-subset(brandweeksalestime, N >= length(distinctweek))
brandcompleteweekformat <- setDT(brandcompleteweek)[, .N, .(brand)]
brandcomplete <- subset(brandcompleteweekformat, N >= 3) #have 3 format; hypermarket, supermarket and convenience
brandcomplete <- brandcomplete %>% mutate(brand=droplevels(brand))
distinctbrandcomplete<-unique(brandcomplete$brand)
message(paste("The total number of brand that has complete observation for this category:", dim(brandcomplete)[1]))

df_complete <- df[df$brand %in% brandcomplete$brand, ]
df_complete <- df_complete %>% mutate(brand=droplevels(brand))
message(paste("The number of observation before dropping non-complete brand:", dim(df)[1]))
message(paste("The number of observation after dropping non-complete brand:", dim(df_complete)[1]))

#remove used data
remove(list=c("brandsalecount", "brandweeksalestime","brandcompleteweek","brandcompleteweekformat","brandcomplete","df")) 
```



We want to compare between the *change in final price* vis a vis the *change in discount* and interesting to see the price before (now we will compare three aspects). Hence, we will create an aggregate price-related variable and line-length (aka assortment).

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}
#Number of unique SKUs sold by brand b in period t
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df_complete$pricebeforeperunit <- df_complete$spendingbeforedisc/df_complete$sales_volume
df_complete$finalpriceperunit <- df_complete$finalspending/df_complete$sales_volume
df_complete$discountperunit <- df_complete$totaldiscount/df_complete$sales_volume
#calculated weight
weeklysalesbybrand<-setDT(df_complete)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id)), .(vecka,brand,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df_complete,weeklysalesbybrand, by=c("vecka","brand","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount)), .(vecka,brand,format)]

#remove prior df
remove(list=c("weeklysalesbybrand", "df_weightcalc"))
```


We will create dataframe that measures category and brand discount characteristics across time (153 weeks) in each format.

**Brand level:** 

* (Static) Market Share: Average market share of category of each format across 153 weeks
* Brand Discount Frequency:The number of weeks in which negative price-promotion shocks are at least 5% of the brandâ€™s regular price (Srinivasan et al 2004)
* Brand Discount Breadth: Average Discount Breadth of each brand in each format across 153 weeks
* Brand Discount Depth: Average Discount Dept of each of each brand in each format across 153 weeks
 
Also, we need to calculate brand average sales and discount value to calculate *discount elasticities* later. 
 

```{r create brand level data frame for second-stage analysis, include=FALSE}
weeklymarketbyweek<-setDT(df_complete)[, .(totalformatsales=sum(sales_volume),totalformatLL=uniqueN(produkt_id)), .(vecka,format)] #this df will be used for category calculation
weeklymarketsharebybrand<-setDT(df_complete)[, .(totalsales=sum(sales_volume)), .(vecka,brand,format)] #Should return nbrand x nformat rows
weeklymarketsharemerge <- merge(weeklymarketsharebybrand,weeklymarketbyweek, by=c("vecka","format"))
brandmarketshareformat<-setDT(weeklymarketsharemerge)[, .(avgbrandweeksales=mean(totalsales),avgmarketshare=mean(totalsales/totalformatsales)), .(brand,format)]

df_bybrand_discount<-df_bybrand[df_bybrand$avgdiscount>0,] 
branddiscountdepth<-setDT(df_bybrand_discount)[, .(avgbranddiscount=mean(avgdiscount),avgbranddiscountdepth=mean(avgdiscount/avgpricebefore)), .(brand,format)] #Should return nbrand x nformat rows

df_complete_discount<-df_complete[df_complete$discountperunit>0,] 
LLdiscount<-setDT(df_complete_discount)[, .(LLdiscount=uniqueN(produkt_id)), .(vecka,brand,format)] 
LLdiscountmerge<-merge(LLdiscount,df_bybrand_discount, by=c("vecka","format","brand")) 
LLdiscountmerge$discountbreadth <- LLdiscountmerge$LLdiscount/LLdiscountmerge$LL 
branddiscountbreadth<-setDT(LLdiscountmerge)[, .(avgbranddiscountbreath=mean(LLdiscount/LL)), .(brand,format)] 

df_complete_highdiscount<-df_complete[(df_complete$discountperunit/df_complete$pricebeforeperunit>0.05),]
counthighdiscount<-setDT(df_complete_highdiscount)[, .(SKUdiscount=uniqueN(produkt_id)), .(vecka,brand,format)]
counthighdiscount$weekdisc<-1
branddiscountfrequency<-setDT(counthighdiscount)[, .(frequency=sum(weekdisc)), .(brand,format)] 
branddiscountfrequency$freqratio <- branddiscountfrequency$frequency/length(distinctweek)

brandcharacteristic_1 <-merge(brandmarketshareformat,branddiscountdepth, by=c("format","brand"))
brandcharacteristic_2 <-merge(brandcharacteristic_1,branddiscountbreadth, by=c("format","brand"))
brandcharacteristic <-merge(brandcharacteristic_2,branddiscountfrequency, by=c("format","brand"))

remove(list=c("brandcharacteristic_1","brandcharacteristic_2", "branddiscountdepth","branddiscountbreadth","branddiscountfrequency","brandmarketshareformat","counthighdiscount","df_bybrand_discount","df_complete_highdiscount","LLdiscount","LLdiscountmerge","weeklymarketsharebybrand","weeklymarketsharemerge"))
```
 
**Category level:**

* Storability & Impulsiveness
* Category Discount Breath: Average Discount Breadth of each format across 153 weeks (weeks that got promoted)
* Category Discount Depth: Average Discount Depth of each format across 153 weeks
* Competitive Structure: The variance in average shares across brands

```{r create category data frame for second-stage analysis, include=FALSE}
categorydepth <- setDT(df_complete_discount)[, .(avgcatediscdept=mean(discountperunit/pricebeforeperunit)), .(format)]  #Should return nformat rows

categorybreadthweek <- setDT(df_complete_discount)[, .(Ncatediscount=uniqueN(produkt_id)), .(vecka,format)]  #Should return nformat rows
categorybreadthweekmerge <- merge(categorybreadthweek,weeklymarketbyweek, by=c("vecka","format"))
categorybreadth<-setDT(categorybreadthweekmerge)[, .(avgcatediscbreath=mean(Ncatediscount/totalformatLL)), .(format)] 

categorycompstructure <- setDT(brandcharacteristic)[, .(varmarketshare=var(avgmarketshare)), .(format)]

categorycharacteristic_1 <-merge(categorydepth,categorybreadth, by=c("format"))
categorycharacteristic <-merge(categorycharacteristic_1,categorycompstructure, by=c("format"))

remove(list=c("categorycharacteristic_1", "categorydepth","categorybreadthweek","categorybreadthweekmerge","categorybreadth","categorycompstructure","df_complete_discount","weeklymarketbyweek"))
remove(list=c("df_complete"))
```



We also have to create competitor price and line-length and its lagged variable across brand and format. (**To create a function is still puzzle. Hence, I have just to run its separatedly by format (for now).**)
```{r write function to calculate competitor price, echo = FALSE, eval=FALSE}
#df_rep <- data.frame(matrix(NA, ncol = 13 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand
#for (i in 1:length(distinctformat)){
#  df_byformat= df_bybrand[df_bybrand$format == distinctformat[i],]
#  for(j in 1:length(distinctbrandcomplete)){
#df_competitor=df_byformat[df_byformat$brand != distinctbrandcomplete[j],]
#weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
#df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
#df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
#df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
#df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
#df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
#df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
#df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
#df_own=df_byformat[df_byformat$brand == distinctbrandcomplete[j],]
#df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
#df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
#df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[j])
#df_rep[(1+((i-1)*153)):(153+((i-1)*153)),3] <- toString(distinctformat[i])
#}}


#This code should work
#for (i in 1:length(distinctformat)){
#  for(j in 1:length(distinctbrandcomplete)){
#    print(distinctbrandcomplete[j])
#    print(distinctformat[i])
#  }}

```



```{r calculate the competitor price and lag variable, echo=FALSE}
nbrand<-length(distinctbrandcomplete)
nweek<-length(distinctweek)
nformat <- length(distinctformat)

lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
  #Calculate hypermarket
df_rep <- data.frame(matrix(NA, ncol = 13 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i]& df_bybrand$format == "hypermarket",]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvolume=sum(totalvolume)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvolume/df_competitorweightcalc$totalmarketvolume
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "hypermarket",]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),3] <- "hypermarket"
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_hyper_bybrand <- df_rep
#We have to sort the data in the way that we have the same brand and ascending order row before implementing lag
df_hyper_bybrand<-df_hyper_bybrand [order(df_hyper_bybrand$brand,df_hyper_bybrand$vecka),]
df_hyper_bybrand$totalvolume1 <- ave(df_hyper_bybrand$totalvolume, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$totalvalue1 <- ave(df_hyper_bybrand$totalvalue, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$LL1 <- ave(df_hyper_bybrand$LL, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgfinalprice1 <- ave(df_hyper_bybrand$avgfinalprice, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgpricebefore1 <- ave(df_hyper_bybrand$avgpricebefore, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgdiscount1 <- ave(df_hyper_bybrand$avgdiscount, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgcompLL1 <- ave(df_hyper_bybrand$avgcompLL, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgcompfinalprice1 <- ave(df_hyper_bybrand$avgfinalprice, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgcomppricebefore1 <- ave(df_hyper_bybrand$avgpricebefore, df_hyper_bybrand$brand, FUN= lag_1)
df_hyper_bybrand$avgcompdiscount1 <- ave(df_hyper_bybrand$avgdiscount, df_hyper_bybrand$brand, FUN= lag_1)

remove(list=c("df_competitor","weeklysalesbycompetingbrand", "df_competitorweightcalc","df_competitorinfo","df_own","df_rep"))

  #Calculate supermarket
df_rep <- data.frame(matrix(NA, ncol = 13 , nrow = ((nbrand)*(nweek)))) 
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i]& df_bybrand$format == "supermarket",]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvolume=sum(totalvolume)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvolume/df_competitorweightcalc$totalmarketvolume
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "supermarket",]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),3] <- "supermarket"
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_super_bybrand <- df_rep
df_super_bybrand<-df_super_bybrand [order(df_super_bybrand$brand,df_super_bybrand$vecka),]
df_super_bybrand$totalvolume1 <- ave(df_super_bybrand$totalvolume, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$totalvalue1 <- ave(df_super_bybrand$totalvalue, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$LL1 <- ave(df_super_bybrand$LL, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgfinalprice1 <- ave(df_super_bybrand$avgfinalprice, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgpricebefore1 <- ave(df_super_bybrand$avgpricebefore, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgdiscount1 <- ave(df_super_bybrand$avgdiscount, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgcompLL1 <- ave(df_super_bybrand$avgcompLL, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgcompfinalprice1 <- ave(df_super_bybrand$avgfinalprice, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgcomppricebefore1 <- ave(df_super_bybrand$avgpricebefore, df_super_bybrand$brand, FUN= lag_1)
df_super_bybrand$avgcompdiscount1 <- ave(df_super_bybrand$avgdiscount, df_super_bybrand$brand, FUN= lag_1)

remove(list=c("df_competitor","weeklysalesbycompetingbrand", "df_competitorweightcalc","df_competitorinfo","df_own","df_rep"))

  #Calculate convenient
df_rep <- data.frame(matrix(NA, ncol = 13 , nrow = ((nbrand)*(nweek)))) 
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i]& df_bybrand$format == "convenience",]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvolume=sum(totalvolume)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvolume/df_competitorweightcalc$totalmarketvolume
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "convenience",]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),3] <- "convenience"
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_convenience_bybrand <- df_rep
df_convenience_bybrand<-df_convenience_bybrand [order(df_convenience_bybrand$brand,df_convenience_bybrand$vecka),]
df_convenience_bybrand$totalvolume1 <- ave(df_convenience_bybrand$totalvolume, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$totalvalue1 <- ave(df_convenience_bybrand$totalvalue, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$LL1 <- ave(df_convenience_bybrand$LL, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgfinalprice1 <- ave(df_convenience_bybrand$avgfinalprice, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgpricebefore1 <- ave(df_convenience_bybrand$avgpricebefore, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgdiscount1 <- ave(df_convenience_bybrand$avgdiscount, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgcompLL1 <- ave(df_convenience_bybrand$avgcompLL, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgcompfinalprice1 <- ave(df_convenience_bybrand$avgfinalprice, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgcomppricebefore1 <- ave(df_convenience_bybrand$avgpricebefore, df_convenience_bybrand$brand, FUN= lag_1)
df_convenience_bybrand$avgcompdiscount1 <- ave(df_convenience_bybrand$avgdiscount, df_convenience_bybrand$brand, FUN= lag_1)


remove(list=c("df_competitor","weeklysalesbycompetingbrand", "df_competitorweightcalc","df_competitorinfo","df_own","df_rep"))

#merge all format together
df_bybrand <- rbind(df_hyper_bybrand,df_super_bybrand,df_convenience_bybrand)
```

Next, we want to see the difference term between time. Hence, we need to create lagged variable (by brand)

```{r create the first difference variables, include=FALSE}
#We drop week 0
df_bybrand <- na.omit(df_bybrand)
df_bybrand$dtotalvolume <- df_bybrand$totalvolume-df_bybrand$totalvolume1
df_bybrand$dtotalvalue <- df_bybrand$totalvalue-df_bybrand$totalvalue1
df_bybrand$davgfinalprice <- df_bybrand$avgfinalprice-df_bybrand$avgfinalprice1
df_bybrand$davgpricebefore <- df_bybrand$avgpricebefore-df_bybrand$avgpricebefore1
df_bybrand$davgdiscount <- df_bybrand$avgdiscount-df_bybrand$avgdiscount1

#calculate percentage change
df_bybrand$pdtotalvolume <- (df_bybrand$totalvolume-df_bybrand$totalvolume1)/df_bybrand$totalvolume1
df_bybrand$pdtotalvalue <- (df_bybrand$totalvalue-df_bybrand$totalvalue1)/df_bybrand$totalvalue1
df_bybrand$pdavgfinalprice <- (df_bybrand$avgfinalprice-df_bybrand$avgfinalprice1)/df_bybrand$avgfinalprice1
df_bybrand$pdavgpricebefore <- (df_bybrand$avgpricebefore-df_bybrand$avgpricebefore1)/df_bybrand$avgpricebefore1
#if you calculate using prior discount as denominator could lead to inf so we define them as (percentage change relative to price before discount)
df_bybrand$pdavgdiscount <- (df_bybrand$avgdiscount/df_bybrand$avgpricebefore)-(df_bybrand$avgdiscount1/df_bybrand$avgpricebefore1)
```



```{r merge holiday info, echo=FALSE}
df_bybrand <- merge(df_bybrand,df_holiday[,2:3], by=c("vecka"))
```



\newpage
# Working on Price Before Discount and Discount

We use **datta et al. (2019) full linear model sales-response model** (an error-correction specification):


$$\Delta(S_{i,t}) = \beta_{0i}+\beta_{1i}\Delta (Linelength_{it})+\beta_{2i}\Delta (Price_{it})$$
$$+\beta_{3i}\Delta (CompLinelength_{it})+\beta_{4i}\Delta (CompPrice_{it})$$
$$+\gamma_{i}[S_{i,t-1} - \beta_{5i}Linelength_{i,t-1}-\beta_{6i}Price_{i,t-1}]+\beta_{7i}Trend_{t}+\beta_{8i}Holiday_{t} + Copula$$
where
$$\Delta X_{t} = X_{t} - X_{t-1}$$
and
$$ Price = Regular Price - Discount $$
So, we run this model:
$$\Delta(S_{i,t}) = \beta_{0i}+\beta_{1i}\Delta (Linelength_{it})+\beta_{2i}\Delta (RegPrice_{it})-\beta_{2'i}\Delta (Discount_{i,t}) $$
$$+\beta_{3i}\Delta (CompLinelength_{it})+\beta_{4i}\Delta (CompRegPrice_{it})-\beta_{4'i}\Delta (CompDiscount_{i,t})$$
$$+\gamma_{i}[S_{i,t-1} - \beta_{5i}Linelength_{i,t-1}-\beta_{6i}RegPrice_{i,t-1}-\beta_{6'i}Discount_{i,t-1}]$$
$$+\beta_{7i}Trend_{t}+\beta_{8i}Holiday_{t} + Copula$$

* We expect $\hat{\beta_{2'i}} > 0$ because $-(\hat{\beta_{2i}}\Delta Price)$; so $-\beta_{2i}\Delta (RegPrice_{it})+\beta_{2'i}\Delta (Discount_{i,t})$

\newpage
# Results

* We report $\hat{\beta_{2'i}}$ as short term discount effect and $\hat{\beta_{6'i}}$ as long term discount effect and their standard errors.

```{r Estimate full linear model with table, echo=FALSE}
  df_bybrand$dLL = df_bybrand$LL - df_bybrand$LL1
  df_bybrand$davgcompLL = df_bybrand$avgcompLL - df_bybrand$avgcompLL1
  df_bybrand$davgcompfinalprice = df_bybrand$avgcompfinalprice - df_bybrand$avgcompfinalprice1
  df_bybrand$davgcompdiscount = df_bybrand$avgcompdiscount - df_bybrand$avgcompdiscount1
  
df_linear_withdiscount_hyper <- data.frame(matrix(NA, ncol = 6 , nrow = (nbrand))) 
df_linear_withdiscount_super <- data.frame(matrix(NA, ncol = 6 , nrow = (nbrand))) 
df_linear_withdiscount_convenience <- data.frame(matrix(NA, ncol = 6 , nrow = (nbrand))) 

#Calculate lm for (before-discount)
  for (i in 1:length(distinctbrandcomplete)){
#lm for before&discount
lm_1_hyper <- lm(dtotalvolume ~ dLL + davgpricebefore + davgdiscount + davgcompLL + davgcompfinalprice + davgcompdiscount + totalvolume1 + LL1 +avgpricebefore1 + avgdiscount1 + holiday ,data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "hypermarket",])
lm_1_super <- lm(dtotalvolume ~ dLL + davgpricebefore + davgdiscount + davgcompLL + davgcompfinalprice + davgcompdiscount + totalvolume1 + LL1 +avgpricebefore1 + avgdiscount1 + holiday ,data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "supermarket",])
lm_1_convenience <- lm(dtotalvolume ~ dLL + davgpricebefore + davgdiscount + davgcompLL + davgcompfinalprice + davgcompdiscount + totalvolume1 + LL1 +avgpricebefore1 + avgdiscount1 + holiday ,data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]& df_bybrand$format == "convenience",])

#Export Discount coefficient across format

df_linear_withdiscount_hyper[i,1] <- toString(distinctbrandcomplete[i])
df_linear_withdiscount_hyper[i,2] <- "hypermarket"
df_linear_withdiscount_hyper[i,3] = summary(lm_1_hyper)$coefficients[4,1]
df_linear_withdiscount_hyper[i,4] = summary(lm_1_hyper)$coefficients[4,2]
df_linear_withdiscount_hyper[i,5] = summary(lm_1_hyper)$coefficients[11,1]
df_linear_withdiscount_hyper[i,6] = summary(lm_1_hyper)$coefficients[11,2]
df_linear_withdiscount_hyper[i,1] <- toString(distinctbrandcomplete[i])

df_linear_withdiscount_super[i,1] <- toString(distinctbrandcomplete[i])
df_linear_withdiscount_super[i,2] <- "supermarket"
df_linear_withdiscount_super[i,3] = summary(lm_1_super)$coefficients[4,1]
df_linear_withdiscount_super[i,4] = summary(lm_1_super)$coefficients[4,2]
df_linear_withdiscount_super[i,5] = summary(lm_1_super)$coefficients[11,1]
df_linear_withdiscount_super[i,6] = summary(lm_1_super)$coefficients[11,2]

df_linear_withdiscount_convenience[i,1] <- toString(distinctbrandcomplete[i])
df_linear_withdiscount_convenience[i,2] <- "convenience"
df_linear_withdiscount_convenience[i,3] = summary(lm_1_convenience)$coefficients[4,1]
df_linear_withdiscount_convenience[i,4] = summary(lm_1_convenience)$coefficients[4,2]
df_linear_withdiscount_convenience[i,5] = summary(lm_1_convenience)$coefficients[11,1]
df_linear_withdiscount_convenience[i,6] = summary(lm_1_convenience)$coefficients[11,2]
  }

df_linear_withdiscount <- rbind(df_linear_withdiscount_hyper,df_linear_withdiscount_super,df_linear_withdiscount_convenience)

colnames(df_linear_withdiscount) <- c('brand','format','Short Coef Discount','Short Std Discount','Long Coef Discount','Long Std Discount')
knitr::kable(df_linear_withdiscount, col.names = c('Brand','Format','Short Discount Est','Short SE of Est.','Long Discount Est','Long SE of Est.'))

remove(list=c("df_linear_withdiscount_hyper","df_linear_withdiscount_super","df_linear_withdiscount_convenience"))
```

* We print brand and category characteristics.

```{r print market situation, echo=FALSE}

knitr::kable(brandcharacteristic[,-(5:9)], col.names = c('Format','Brand','Average Weekly Sales(Volume)','Average Weekly MarketShare'))
knitr::kable(brandcharacteristic[,-(3:5)], col.names = c('Format','Brand','Average Discount Depth','Average Discount Breath','(5%) Disc Frequency','Freq Ratio'))

knitr::kable(categorycharacteristic, col.names = c('Format','Average Discount Depth','Average Discount Breath','Var of Market Share'))
```

* We calculated short-term elasticities (not long-term as long-term effects coefficients are insignificant with large SE), by normalizing it with $\frac{\bar{Sales_{ijk}}}{\bar{X_{ijk}}}$. In Srinivasan et al. (2004); *"When making comparisons across brands and product categories, however, one may want to control for scale differences, and convert the respective summary statistics to unit-free elasticities. We derive the elasicities at the mean by normalizing the incremental performance by the ratio of the sample performance mean to the sample price mean"*

* From Srinivasan et al. (2004); the unit free elasticity is short-term $ShortEst/\frac{\bar{Sales_{ijk}}}{\bar{X_{ijk}}}*100$.

```{r calculate elasticities short term effect, echo=FALSE}
#Include brand characteristics and calculate elasticities
df_elasticities <- merge(df_linear_withdiscount[,1:4],brandcharacteristic, by=c("brand","format"))
df_elasticities$meanelasticity <- df_elasticities$'Short Coef Discount'*(df_elasticities$avgbranddiscount/df_elasticities$avgbrandweeksales)*100
df_elasticities$sdelasticity <- df_elasticities$'Short Std Discount'*(df_elasticities$avgbranddiscount/df_elasticities$avgbrandweeksales)*100
knitr::kable(df_elasticities[, -(5:11)], col.names = c('Brand','Format','Short Discount Est','Short SE of Est.','Mean Discount Elasticity','SD Discount Elasticity'))
```


```{r merge category characteristic, include=FALSE}
#Include brand characteristics and calculate elasticities
df_first <- merge(df_elasticities,categorycharacteristic, by=c("format"))
df_first$category <- toString(categorydf)
```

```{r export the csv file, include=FALSE}
path = '../../gen/data'

output = paste0(path,'/discount_',categorydf,'.csv')


write.csv(df_first,output)
```

