---
title: "Price Discount Analysis for Cereals"
author: "Tanetpong"
date: "18/10/2021"
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../gen/analysis") })
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(dplyr) #for mutate factor level of brand
library(plyr) #for revalue function for brand
library(data.table) #for set DT checking brand
```

# Data Management

```{r read data}
df_scanner <- read.csv("../../data/df_scanner.csv")
df <-subset(df_scanner,category == "Cereals")
df <- df %>% mutate(brand=droplevels(brand)) #Because the subset function doesnt drop the factor per se
df <- df %>% mutate(vecka=droplevels(as.factor(vecka))) #In case some categories doesnt have full week like another
#for simplicity, we will drop online sales for now (due to small data)
df_online <- subset(df, saljkanal == 1)
message(paste("The total number of weekly online sold for this category:", dim(df_online)[1]))
df <- subset(df, saljkanal == 0)
remove(list=c("df_scanner", "df_online")) #remove unnecessary file to make environment clean
```

```{r Rename the brand of cereal for consistency, be careful of non-roman character}
table(df$brand)
df$brand<- revalue(df$brand, c(
              "Honey Monster"="Honey Monster",
              "ICA Basic"="ICA", "ICA Gott Liv"="ICA","ICA Basic"="ICA", "ICA I love eco"="ICA",
              "KUNG MARKATTA"="Kung markatta",
              "Paulun"="Pauluns",
              "QUAKER"="Quaker",
              "RenÃ©e Voltaire"="ReneeVoltaire", "RENÃ‰E VOLTAIRE"="ReneeVoltaire"
              ))
table(df$brand)
```

```{r select the brand with every weekly sales regardless of sku, echo=FALSE}
#create a table of distinct week
distinctweek<-unique(df$vecka)
message(paste("The total number of week sold for this category:", length(distinctweek)))
#calculate the brand sales by week
distinctbrand<-unique(df$brand)
message(paste("The total number of brand for this category:", length(distinctbrand)))
brandsalecount<-setDT(df)[, .N, .(vecka,brand)]
brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand)]#we count if the brand got shown in the scanner data each week
#select the brand that have complete week
brandcompleteweek<-subset(brandweeksalestime, N >= length(distinctweek))
brandcompleteweek <- brandcompleteweek %>% mutate(brand=droplevels(brand))
distinctbrandcomplete<-unique(brandcompleteweek$brand)
message(paste("The total number of brand that has complete observation for this category:", dim(brandcompleteweek)[1]))

df_complete <- df[df$brand %in% brandcompleteweek$brand, ]
df_complete <- df_complete %>% mutate(brand=droplevels(brand))
message(paste("The number of observation before dropping non-complete brand:", dim(df)[1]))
message(paste("The number of observation after dropping non-complete brand:", dim(df_complete)[1]))

#remove used data
remove(list=c("brandsalecount", "brandweeksalestime","brandcompleteweek","df")) 
```

We want to compare between the *change in final price* vis a vis the *change in discount* and interesting to see the price before (now we will compare three aspects) 
```{r calculate the price related variables or our main IV}
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df_complete$pricebeforeperunit <- df_complete$spendingbeforedisc/df_complete$sales_volume
df_complete$finalpriceperunit <- df_complete$finalspending/df_complete$sales_volume
df_complete$discountperunit <- df_complete$totaldiscount/df_complete$sales_volume
#calculated weight
weeklysalesbybrand<-setDT(df_complete)[, .(totalsales=sum(finalspending)), .(vecka,brand)]
df_weightcalc <- merge(df_complete,weeklysalesbybrand, by=c("vecka","brand"))
df_weightcalc$wp <- df_weightcalc$finalspending/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_complete$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_complete$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_complete$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount)), .(vecka,brand)]

#remove prior df
remove(list=c("df_complete","weeklysalesbybrand", "df_weightcalc"))
```

\newpage
# Model-free evidence for absolute relationship
We will explore relationship between price before discount, final price, discount and total sales by brand
```{r simple plot for absolute term}
par(mfrow = c(3,3))
for (i in 1:length(distinctbrandcomplete)){
plot(totalvolume ~ avgfinalprice, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="blue")
plot(totalvolume ~ avgpricebefore, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="green")
plot(totalvolume ~ avgdiscount, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="red")
}
```

\newpage
# Explore the lag
Next, we want to see the difference term between time. Hence, we need to create lagged variable (by brand)
```{r generate lag term(s)}
#We have to sort the data in the way that we have the same brand and ascending order row
df_bybrand<-df_bybrand[order(df_bybrand$brand,df_bybrand$vecka),]
#Create Lag(1) of TotalVolume,TotalValue, Price before, Final Price and Discount for each brand
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
#We drop week 0
df_bybrand <- na.omit(df_bybrand)
df_bybrand$dtotalvolume <- df_bybrand$totalvolume-df_bybrand$totalvolume1
df_bybrand$dtotalvalue <- df_bybrand$totalvalue-df_bybrand$totalvalue1
df_bybrand$davgfinalprice <- df_bybrand$avgfinalprice-df_bybrand$avgfinalprice1
df_bybrand$davgpricebefore <- df_bybrand$avgpricebefore-df_bybrand$avgpricebefore1
df_bybrand$davgdiscount <- df_bybrand$avgdiscount-df_bybrand$avgdiscount1
```

\newpage
# Model-free evidence for temporal relative relationship
We will explore relationship between difference of price before discount, final price, discount and total sales by brand
```{r simple plot for difference}
par(mfrow = c(3,3))
for (i in 1:length(distinctbrandcomplete)){
plot(dtotalvolume ~ davgfinalprice, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="blue")
plot(dtotalvolume ~ davgpricebefore, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="green")
plot(dtotalvolume ~ davgdiscount, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i]], main = distinctbrandcomplete[i], col="red")
}
```
