---
title: "Managebrandandcategorydata"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand and import
library(car) #function for testing coefficient equivalence
library(lmtest) #function for testing nonlinearity
```


```{r read data, include=FALSE}
df_scanner <- fread("../../../data/df_scanner_butikid.csv", encoding = 'UTF-8')
df_holiday <- read.csv("../../../data/weeklyholiday.csv")
```

```{r rename all ICA brand and code PL and NB, include=FALSE}
df_scanner$format <- ifelse(df_scanner$saljkanal == "1","online",df_scanner$format)
df_scanner$format <- as.factor(df_scanner$format)
```

```{r rename all ICA brand and code PL and NB, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
              "IBA"="ICA",
              "ICA Asia"="ICA",
              "ICA BASIC" = "ICA Basic",
              "ICA EKOLOGISKT" = "ICA I love eco",
              "ICA Cook & Eat" = "ICA",
              "ICA God smak från" = "ICA",
              "ICA GOTT LIV" = "ICA Gott Liv",
              "ICA HOME" = "ICA",
              "ICA home" = "ICA",
              "I LOVE ECO" = "ICA I love eco",
              "ICA I LOVE ECO" = "ICA I love eco",
              "ICA KVANTUM" = "ICA",
              "ICA KVANTUMS BAGERI" = "ICA",
              "ICA Rätt Enkelt" = "ICA",
              "ICA SELECTION" = "ICA Selection"
              ))
private_label <- as.factor(c("ICA","ICA Basic","ICA Gott Liv","ICA I love eco","ICA Selection","ICA Skona"))

df_scanner$brand_cat <- ifelse(df_scanner$brand %in% private_label,df_scanner$brand,"NB")
df_scanner$brand_cat <- as.factor(df_scanner$brand_cat)
df_scanner$PL <- ifelse(df_scanner$brand %in% private_label,1,0)
#df_scanner$PL <- as.factor(df_scanner$PL)
```



```{r drop unexplainablevalue}
#dropdecimal and non-integer

df <- df_scanner[df_scanner$sales_volume>=1,]
df <- df[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_scanner)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner"))

```

#Function of selecting the brand and generate relevant variables

```{r define function for filtering brand with complete (153) observations}
brandfiltering_format <- function(df,format,category,nweek){
  category = "Bottled water"
  format = "hypermarket"
  nweek=153
  df_format_category <- df[df$category == "Bottled water" & df$format == "hypermarket",]
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand_cat,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand_cat,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand_cat=droplevels(brand_cat))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand_cat)
message(paste("# of remaining brands for",category,"in",format,":", dim(brandcompleteweek)[1],"(from",length(unique(df_format_category$brand_cat)),")"))

df_format_category_complete <- df_format_category[df_format_category$brand_cat %in% brandcompleteweek$brand_cat, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand_cat=droplevels(brand_cat))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]
message(paste("% of obs. maintain:", (nobsafterdrop/nobsbeforedrop)*100))

return(df_format_category_complete)
}
```


#Function of testing coefficient of price before VS discount.
This function will return the estimated coefficients of price before, discount and whether these coefficients are statistically significant.


```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

test_discount_coef <- function(aggregate_df){
  
  distinctbrandcomplete <- unique(aggregate_df$brand)
  nbrand<-length(distinctbrandcomplete)
  
  
  df_discount_coef_test <- data.frame(matrix(NA, ncol = 9 , nrow = (nbrand))) 
  for (i in 1:length(distinctbrandcomplete)){
#lm for before&discount


lm_discount <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrandcomplete[i],])


#test coefficient between price before discount (Testing linear hypothesis on the coefficients of a system of equations by an F-test or Wald-test)
  #see more https://kzee.github.io/CoeffDiff_Demo.html
coeftest<-linearHypothesis(lm_discount, "dlogavgpricebefore - dlognondepth = 0")

#Export Discount coefficient across format

df_discount_coef_test[i,1] <- paste0(unique(aggregate_df$format))
df_discount_coef_test[i,2] <- paste0(unique(aggregate_df$category))
df_discount_coef_test[i,3] <- toString(distinctbrandcomplete[i])
df_discount_coef_test[i,4] = summary(lm_discount)$coefficients[3,1]
df_discount_coef_test[i,5] = summary(lm_discount)$coefficients[3,2]
df_discount_coef_test[i,6] = summary(lm_discount)$coefficients[4,1]
df_discount_coef_test[i,7] = summary(lm_discount)$coefficients[4,2]
df_discount_coef_test[i,8] = round(coeftest$`Pr(>F)`[2],4)
df_discount_coef_test[i,9] = round(summary(lm_discount)$r.squared,4)

colnames(df_discount_coef_test) <- c('format','category','brand','Coef PriceBefore','Sd PriceBefore','Coef NonDiscount','Sd NonDiscount','p coef test','R2 of model')
  }
df_discount_coef_test$pricedecision <- ifelse(df_discount_coef_test$`p coef test`< 0.05, 'discount', 'finalprice')

return(df_discount_coef_test)
  
}
```

#Function of testing nonlinearity

This function returns p-value for likelihood ratio test when non-linearity term (or quadratic term) is added and conclusion whether which function should be performed. 


However, we still need to create another function that skip some lm in case of all brands have significant discount parameters and vice versa (LATER).

```{r}
test_nonlinearity_both <- function(aggregate_df,discount_coef_result){
  
  df_merge_result <- merge(aggregate_df,discount_coef_result, by=c("brand"))
  
  df_finalprice <- df_merge_result[df_merge_result$pricedecision == 'finalprice', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  
  df_discount <- df_merge_result[df_merge_result$pricedecision == 'discount', ]
  df_discount <- df_discount %>% mutate(brand=droplevels(brand))
  distinctbrand_discount <- unique(df_discount$brand)
  nbrand_discount<-length(distinctbrand_discount)

   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){  
  
lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_price2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + I(dlogavgfinalprice^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

test_price<-lrtest(lm_finalprice, lm_finalprice_price2)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_price$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = "NA"
df_finalprice_lr[i,4] = "NA"
}  
  
 df_discount_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_discount)))  
  for (i in 1:length(distinctbrand_discount)){

lm_discount <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_price2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + I(dlogavgpricebefore^2) + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_discount2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth +I(dlognondepth^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_pricediscount2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + I(dlogavgpricebefore^2) + dlognondepth +I(dlognondepth^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

test_price<-lrtest(lm_discount, lm_discount_price2)
test_discount<-lrtest(lm_discount, lm_discount_discount2)
test_price_discount <- lrtest(lm_discount,lm_discount_pricediscount2)

df_discount_lr[i,1] <- toString(distinctbrand_discount[i])
df_discount_lr[i,2] = round(test_price$`Pr(>Chisq)`[2],4)
df_discount_lr[i,3] = round(test_discount$`Pr(>Chisq)`[2],4)
df_discount_lr[i,4] = round(test_price_discount$`Pr(>Chisq)`[2],4)
  }
 
df_nonlinearity_test <- rbind(df_discount_lr,df_finalprice_lr)
colnames(df_nonlinearity_test) <- c('brand','p-value-price^2','p-value-discount^2','p-value-priceanddiscount^2')

#give the decision in this nonlinearitystep

df_nonlinearity_test$linearitydecision <- "nonlinearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` =="NA"] <- "linearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` >= 0.05 & df_nonlinearity_test$`p-value-priceanddiscount^2`>=0.05] <- "linearity"

df_nonlinearity_test$nonlinearitydecision <- "nonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`linearitydecision` =="linearity"] <- "linearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` >= 0.05] <- "pricebeforenonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` == "NA"] <- "finalpricenonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` < 0.05] <- "discountnonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` < 0.05 & df_nonlinearity_test$`p-value-priceanddiscount^2`< 0.05] <- "priceanddiscountnonlinearity"

return(df_nonlinearity_test)
  
}


test_nonlinearity_onlyfinal <- function(aggregate_df,discount_coef_result){
  
  df_merge_result <- merge(aggregate_df,discount_coef_result, by=c("brand"))
  
  df_finalprice <- df_merge_result[df_merge_result$pricedecision == 'finalprice', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  
   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){  
  
lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_price2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + I(dlogavgfinalprice^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

test_price<-lrtest(lm_finalprice, lm_finalprice_price2)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_price$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = "NA"
df_finalprice_lr[i,4] = "NA"
}  
  
 
df_nonlinearity_test <- df_finalprice_lr
colnames(df_nonlinearity_test) <- c('brand','p-value-price^2','p-value-discount^2','p-value-priceanddiscount^2')


df_nonlinearity_test$linearitydecision <- "nonlinearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` =="NA"] <- "linearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` >= 0.05 & df_nonlinearity_test$`p-value-priceanddiscount^2`>=0.05] <- "linearity"

df_nonlinearity_test$nonlinearitydecision <- "nonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`linearitydecision` =="linearity"] <- "linearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` == "NA"] <- "finalpricenonlinearity"


return(df_nonlinearity_test)
  
}

test_nonlinearity_onlydiscount <- function(aggregate_df,discount_coef_result){
  
  df_merge_result <- merge(aggregate_df,discount_coef_result, by=c("brand"))
  
  df_discount <- df_merge_result[df_merge_result$pricedecision == 'discount', ]
  df_discount <- df_discount %>% mutate(brand=droplevels(brand))
  distinctbrand_discount <- unique(df_discount$brand)
  nbrand_discount<-length(distinctbrand_discount)
  
 df_discount_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_discount)))  
  for (i in 1:length(distinctbrand_discount)){

lm_discount <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_price2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + I(dlogavgpricebefore^2) + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_discount2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth +I(dlognondepth^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

lm_discount_pricediscount2 <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + I(dlogavgpricebefore^2) + dlognondepth +I(dlognondepth^2) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday ,data=df_discount[df_discount$brand == distinctbrand_discount[i],])

test_price<-lrtest(lm_discount, lm_discount_price2)
test_discount<-lrtest(lm_discount, lm_discount_discount2)
test_price_discount <- lrtest(lm_discount,lm_discount_pricediscount2)

df_discount_lr[i,1] <- toString(distinctbrand_discount[i])
df_discount_lr[i,2] = round(test_price$`Pr(>Chisq)`[2],4)
df_discount_lr[i,3] = round(test_discount$`Pr(>Chisq)`[2],4)
df_discount_lr[i,4] = round(test_price_discount$`Pr(>Chisq)`[2],4)
  }
 
df_nonlinearity_test <- df_discount_lr
colnames(df_nonlinearity_test) <- c('brand','p-value-price^2','p-value-discount^2','p-value-priceanddiscount^2')

#give the decision in this nonlinearitystep

df_nonlinearity_test$linearitydecision <- "nonlinearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` =="NA"] <- "linearity"
df_nonlinearity_test$linearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` >= 0.05 & df_nonlinearity_test$`p-value-priceanddiscount^2`>=0.05] <- "linearity"

df_nonlinearity_test$nonlinearitydecision <- "nonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`linearitydecision` =="linearity"] <- "linearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` >= 0.05] <- "pricebeforenonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` >= 0.05 & df_nonlinearity_test$`p-value-discount^2` < 0.05] <- "discountnonlinearity"
df_nonlinearity_test$nonlinearitydecision[df_nonlinearity_test$`p-value-price^2` < 0.05 & df_nonlinearity_test$`p-value-discount^2` < 0.05 & df_nonlinearity_test$`p-value-priceanddiscount^2`< 0.05] <- "priceanddiscountnonlinearity"

return(df_nonlinearity_test)
  
}
```





#Function for testing source of non-linearity

This function returns p-value for likelihood ratio test when HBP/D (historical benchmark price/discount) and CBP/D (competitive benchmark price/discount) are added.


However, we still need to create another function that skip some lm in case of all brands have only one type of nonlinearity.

```{r}
test_sourceofnonlinearity_onlyfinal <- function(aggregate_df,nonlinearity_result){
  
  df_merge_result <- merge(aggregate_df,nonlinearity_result, by=c("brand"))
  
  df_finalprice <- df_merge_result[df_merge_result$nonlinearitydecision == 'finalpricenonlinearity', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  df_finalprice$hbp <- log(df_finalprice$avgfinalprice)-log(df_finalprice$avgfinalprice1)
  df_finalprice$cbp <- (df_finalprice$avgfinalprice - df_finalprice$avgcompfinalprice)/df_finalprice$avgfinalprice

   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){

lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_cbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbpcbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])


test_hbp<-lrtest(lm_finalprice, lm_finalprice_hbp)
test_cbp<-lrtest(lm_finalprice, lm_finalprice_cbp)
test_hbpcbp<-lrtest(lm_finalprice, lm_finalprice_hbpcbp)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_hbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_cbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = round(test_hbpcbp$`Pr(>Chisq)`[2],4)
}  
  
df_sourcenonlinearity_test <- df_finalprice_lr
colnames(df_sourcenonlinearity_test) <- c('brand','p-value-hbp','p-value-cbp','p-value-hbp&cbp')

return(df_sourcenonlinearity_test)
  
}

df_7 <- test_sourceofnonlinearity_onlyfinal(aggregate_df = df_chips_super, nonlinearity_result = nonlinear_test_chips_super)

test_sourceofnonlinearity_onlypricebefore<- function(aggregate_df,nonlinearity_result){
  
  df_merge_result <- merge(aggregate_df,nonlinearity_result, by=c("brand"))
  
  df_pricebefore <- df_merge_result[df_merge_result$nonlinearitydecision == 'pricebeforenonlinearity', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  df_finalprice$hbp <- log(df_finalprice$avgfinalprice)-log(df_finalprice$avgfinalprice1)
  df_finalprice$cbp <- (df_finalprice$avgfinalprice - df_finalprice$avgcompfinalprice)/df_finalprice$avgfinalprice

   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){

lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_cbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbpcbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])



test_hbp<-lrtest(lm_finalprice, lm_finalprice_hbp)
test_cbp<-lrtest(lm_finalprice, lm_finalprice_cbp)
test_hbpcbp<-lrtest(lm_finalprice, lm_finalprice_hbpcbp)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_hbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_cbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = round(test_hbpcbp$`Pr(>Chisq)`[2],4)
}  
df_sourcenonlinearity_test <- df_finalprice_lr
colnames(df_sourcenonlinearity_test) <- c('brand','p-value-hbp','p-value-cbp','p-value-hbp&cbp')

return(df_sourcenonlinearity_test)
  
}


test_sourceofnonlinearity_onlypricebeforeanddiscount


test_sourceofnonlinearity_finaldiscount
test_sourceofnonlinearity_finalpricebefore 



test_sourceofnonlinearity_finaldiscountpricebefore


```


#Empirical Test for nonlinearity
```{r Bottled Water}
#Get seperate dataframe
df_bottledwater_hyper <- brandfiltering_format(df=df,format = "hypermarket",category ="Bottled water",nweek=153)
df_bottledwater_super <- generate_df(df,format = "supermarket",category ="Bottled water",nweek=153)
df_bottledwater_conve <- generate_df(df,format = "convenience",category ="Bottled water",nweek=153)
df_bottledwater_online <- generate_df(df,format = "online",category ="Bottled water",nweek=153)

#test discount coefficient
discount_test_bottledwater_hyper <- test_discount_coef(aggregate_df = df_bottledwater_hyper)
discount_test_bottledwater_super <- test_discount_coef(aggregate_df = df_bottledwater_super)
discount_test_bottledwater_conve <- test_discount_coef(aggregate_df = df_bottledwater_conve)
discount_test_bottledwater<-rbind(discount_test_bottledwater_hyper,discount_test_bottledwater_super,discount_test_bottledwater_conve)
remove(list=c("discount_test_bottledwater_hyper","discount_test_bottledwater_super","discount_test_bottledwater_conve"))

#test nonlinearity
nonlinear_test_bottledwater_hyper <- test_nonlinearity_onlydiscount(aggregate_df = df_bottledwater_hyper,discount_coef_result = discount_test_bottledwater_hyper)
nonlinear_test_bottledwater_super <- test_nonlinearity_both(aggregate_df = df_bottledwater_super,discount_coef_result = discount_test_bottledwater_super)
nonlinear_test_bottledwater_conve <- test_nonlinearity_both(aggregate_df = df_bottledwater_conve,discount_coef_result = discount_test_bottledwater_conve)

#conclude nonlinearitytest
nonlinear_test_bottledwater_hyper$format <- "hypermarket"
nonlinear_test_bottledwater_super$format <- "supermarket"
nonlinear_test_bottledwater_conve$format <- "convenience"
nonlinearity_bottledwater_result <- rbind(nonlinear_test_bottledwater_hyper[,-(2:5)],nonlinear_test_bottledwater_super[,-(2:5)],nonlinear_test_bottledwater_conve[,-(2:5)])

#test source of nonlinearity
```


```{r Baking ingredients}
#Get seperate dataframe
df_bakingingredient_hyper <- generate_df(df,format = "hypermarket",category ="Baking ingredients",nweek=153)
df_bakingingredient_super <- generate_df(df,format = "supermarket",category ="Baking ingredients",nweek=153)
df_bakingingredient_conve <- generate_df(df,format = "convenience",category ="Baking ingredients",nweek=153)

#Too few observation left
```

```{r Bathproduct}
#Get seperate dataframe
bathproduct_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Bath Products",nweek=153)
bathproduct_super <- brandfiltering_format(df,format = "supermarket",category ="Bath Products",nweek=153)
bathproduct_conve <- brandfiltering_format(df,format = "convenience",category ="Bath Products",nweek=153)

#Too few observation left
```

```{r Biscuits}
#Get seperate dataframe
biscuits_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Biscuits",nweek=153)
biscuits_super <- brandfiltering_format(df,format = "supermarket",category ="Biscuits",nweek=153)
biscuits_conve <- brandfiltering_format(df,format = "convenience",category ="Biscuits",nweek=153)

#Too few observation left
```

```{r Butter}
#Get seperate dataframe
butter_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Butter",nweek=153)
butter_super <- brandfiltering_format(df,format = "supermarket",category ="Butter",nweek=153)
butter_conve <- brandfiltering_format(df,format = "convenience",category ="Butter",nweek=153)

#Create aggregate dataframe
df_butter_hyper <- genrelevantvar(df=butter_hyper)
df_butter_super <- genrelevantvar(df=butter_super)
df_butter_conve <- genrelevantvar(df=butter_conve)

#test discount coefficient
discount_test_butter_hyper <- test_discount_coef(aggregate_df = df_butter_hyper)
discount_test_butter_super <- test_discount_coef(aggregate_df = df_butter_super)
discount_test_butter_conve <- test_discount_coef(aggregate_df = df_butter_conve)

#test nonlinearity
nonlinear_test_butter_hyper <- test_nonlinearity_both(aggregate_df = df_butter_hyper,discount_coef_result = discount_test_butter_hyper)
nonlinear_test_butter_super <- test_nonlinearity_both(aggregate_df = df_butter_super,discount_coef_result = discount_test_butter_super)
nonlinear_test_butter_conve <- test_nonlinearity_both(aggregate_df = df_butter_conve,discount_coef_result = discount_test_butter_conve)

#conclude nonlinearitytest
nonlinear_test_butter_hyper$format <- "hypermarket"
nonlinear_test_butter_super$format <- "supermarket"
nonlinear_test_butter_conve$format <- "convenience"
nonlinearity_butter_result <- rbind(nonlinear_test_butter_hyper[,-(2:5)],nonlinear_test_butter_super[,-(2:5)],nonlinear_test_butter_conve[,-(2:5)])
```

```{r CannedSoup}
#Get seperate dataframe
cannedsoup_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Canned soup",nweek=153)
cannedsoup_super <- brandfiltering_format(df,format = "supermarket",category ="Canned soup",nweek=153)
cannedsoup_conve <- brandfiltering_format(df,format = "convenience",category ="Canned soup",nweek=153)

#Too few observation left
```

```{r CannedVegg}
#Get seperate dataframe
cannedvegg_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Canned vegetables",nweek=153)
cannedvegg_super <- brandfiltering_format(df,format = "supermarket",category ="Canned vegetables",nweek=153)
cannedvegg_conve <- brandfiltering_format(df,format = "convenience",category ="Canned vegetables",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cannedvegg_hyper <- genrelevantvar(df=cannedvegg_hyper)
df_cannedvegg_super <- genrelevantvar(df=cannedvegg_super)

#test discount coefficient
discount_test_cannedvegg_hyper <- test_discount_coef(aggregate_df = df_cannedvegg_hyper)
discount_test_cannedvegg_super <- test_discount_coef(aggregate_df = df_cannedvegg_super)

#test nonlinearity
nonlinear_test_cannedvegg_hyper <- test_nonlinearity_both(aggregate_df = df_cannedvegg_hyper,discount_coef_result = discount_test_cannedvegg_hyper)
nonlinear_test_cannedvegg_super <- test_nonlinearity_both(aggregate_df = df_cannedvegg_super,discount_coef_result = discount_test_cannedvegg_super)

#conclude nonlinearitytest
nonlinear_test_cannedvegg_hyper$format <- "hypermarket"
nonlinear_test_cannedvegg_super$format <- "supermarket"
nonlinearity_cannedvegg_result <- rbind(nonlinear_test_cannedvegg_hyper[,-(2:5)],nonlinear_test_cannedvegg_super[,-(2:5)])
```

```{r Cereal}
#Get seperate dataframe
cereal_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cereals",nweek=153)
cereal_super <- brandfiltering_format(df,format = "supermarket",category ="Cereals",nweek=153)
cereal_conve <- brandfiltering_format(df,format = "convenience",category ="Cereals",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cereal_hyper <- genrelevantvar(df=cereal_hyper)
df_cereal_super <- genrelevantvar(df=cereal_super)

#test discount coefficient
discount_test_cereal_hyper <- test_discount_coef(aggregate_df = df_cereal_hyper)
discount_test_cereal_super <- test_discount_coef(aggregate_df = df_cereal_super)

#test nonlinearity
nonlinear_test_cereal_hyper <- test_nonlinearity_both(aggregate_df = df_cereal_hyper,discount_coef_result = discount_test_cereal_hyper)
nonlinear_test_cereal_super <- test_nonlinearity_both(aggregate_df = df_cereal_super,discount_coef_result = discount_test_cereal_super)

#conclude nonlinearitytest
nonlinear_test_cereal_hyper$format <- "hypermarket"
nonlinear_test_cereal_super$format <- "supermarket"
nonlinearity_cereal_result <- rbind(nonlinear_test_cereal_hyper[,-(2:5)],nonlinear_test_cereal_super[,-(2:5)])
```
```{r Chips}
#Get seperate dataframe
chips_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153)
chips_super <- brandfiltering_format(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153)
chips_conve <- brandfiltering_format(df,format = "convenience",category ="Chips & Salty snacks",nweek=153)

#Create aggregate dataframe
df_chips_hyper <- genrelevantvar(df=chips_hyper)
df_chips_super <- genrelevantvar(df=chips_super)
df_chips_conve <- genrelevantvar(df=chips_conve)

#test discount coefficient
discount_test_chips_hyper <- test_discount_coef(aggregate_df = df_chips_hyper)
discount_test_chips_super <- test_discount_coef(aggregate_df = df_chips_super)
discount_test_chips_conve <- test_discount_coef(aggregate_df = df_chips_conve)

#test nonlinearity
nonlinear_test_chips_hyper <- test_nonlinearity_both(aggregate_df = df_chips_hyper,discount_coef_result = discount_test_chips_hyper)
nonlinear_test_chips_super <- test_nonlinearity_both(aggregate_df = df_chips_super,discount_coef_result = discount_test_chips_super)
nonlinear_test_chips_conve <- test_nonlinearity_both(aggregate_df = df_chips_conve,discount_coef_result = discount_test_chips_conve)

#conclude nonlinearitytest
nonlinear_test_chips_hyper$format <- "hypermarket"
nonlinear_test_chips_super$format <- "supermarket"
nonlinear_test_chips_conve$format <- "convenience"
nonlinearity_chips_result <- rbind(nonlinear_test_chips_hyper[,-(2:5)],nonlinear_test_chips_super[,-(2:5)],nonlinear_test_chips_conve[,-(2:5)])
```

```{r Chocolate}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chocolate",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Chocolate",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Chocolate",nweek=153)

#Create aggregate dataframe
df_choco_hyper <- genrelevantvar(df=choco_hyper)
df_choco_super <- genrelevantvar(df=choco_super)
df_choco_conve <- genrelevantvar(df=choco_conve)

#test discount coefficient
discount_test_choco_hyper <- test_discount_coef(aggregate_df = df_choco_hyper)
discount_test_choco_super <- test_discount_coef(aggregate_df = df_choco_super)
discount_test_choco_conve <- test_discount_coef(aggregate_df = df_choco_conve)

#test nonlinearity
nonlinear_test_choco_hyper <- test_nonlinearity_both(aggregate_df = df_choco_hyper,discount_coef_result = discount_test_choco_hyper)
nonlinear_test_choco_super <- test_nonlinearity_both(aggregate_df = df_choco_super,discount_coef_result = discount_test_choco_super)
nonlinear_test_choco_conve <- test_nonlinearity_both(aggregate_df = df_choco_conve,discount_coef_result = discount_test_choco_conve)

#conclude nonlinearitytest
nonlinear_test_choco_hyper$format <- "hypermarket"
nonlinear_test_choco_super$format <- "supermarket"
nonlinear_test_choco_conve$format <- "convenience"
nonlinearity_choco_result <- rbind(nonlinear_test_choco_hyper[,-(2:5)],nonlinear_test_choco_super[,-(2:5)],nonlinear_test_choco_conve[,-(2:5)])
```

```{r Cleaningproducts}
#Get seperate dataframe
cleaningprod_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cleaning products",nweek=153)
cleaningprod_super <- brandfiltering_format(df,format = "supermarket",category ="Cleaning products",nweek=153)
cleaningprod_conve <- brandfiltering_format(df,format = "convenience",category ="Cleaning products",nweek=153)

#Too few observation left
```


```{r Coffee}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Coffee",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Coffee",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Coffee",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Cookie}
#Get seperate dataframe
cookie_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cookies",nweek=153)
cookie_super <- brandfiltering_format(df,format = "supermarket",category ="Cookies",nweek=153)
cookie_conve <- brandfiltering_format(df,format = "convenience",category ="Cookies",nweek=153)

#Too few observation left
```

```{r Cream}
#Get seperate dataframe
cream_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cream",nweek=153)
cream_super <- brandfiltering_format(df,format = "supermarket",category ="Cream",nweek=153)
cream_conve <- brandfiltering_format(df,format = "convenience",category ="Cream",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cream_hyper <- genrelevantvar(df=cream_hyper)
df_cream_super <- genrelevantvar(df=cream_super)

#test discount coefficient
discount_test_cream_hyper <- test_discount_coef(aggregate_df = df_cream_hyper)
discount_test_cream_super <- test_discount_coef(aggregate_df = df_cream_super)

#test nonlinearity
nonlinear_test_cream_hyper <- test_nonlinearity_both(aggregate_df = df_cream_hyper,discount_coef_result = discount_test_cream_hyper)
nonlinear_test_cream_super <- test_nonlinearity_both(aggregate_df = df_cream_super,discount_coef_result = discount_test_cream_super)

#conclude nonlinearitytest
nonlinear_test_cream_hyper$format <- "hypermarket"
nonlinear_test_cream_super$format <- "supermarket"
nonlinearity_cream_result <- rbind(nonlinear_test_cream_hyper[,-(2:5)],nonlinear_test_cream_super[,-(2:5)])
```

```{r washingproducts}
#Get seperate dataframe
dishandwashing_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Dishwasher & washing up",nweek=153)
dishandwashing_super <- brandfiltering_format(df,format = "supermarket",category ="Dishwasher & washing up",nweek=153)
dishandwashing_conve <- brandfiltering_format(df,format = "convenience",category ="Dishwasher & washing up",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r frozenpizza}
#Get seperate dataframe
frozenpizza_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Frozen Pizza Snacks",nweek=153)
frozenpizza_super <- brandfiltering_format(df,format = "supermarket",category ="Frozen Pizza Snacks",nweek=153)
frozenpizza_conve <- brandfiltering_format(df,format = "convenience",category ="Frozen Pizza Snacks",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r fruit juice}
#Get seperate dataframe
juice_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Fruit Juice",nweek=153)
juice_super <- brandfiltering_format(df,format = "supermarket",category ="Fruit Juice",nweek=153)
juice_conve <- brandfiltering_format(df,format = "convenience",category ="Fruit Juice",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r household utensilts}
#Get seperate dataframe
hhutensils_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Household utensils",nweek=153)
hhutensils_super <- brandfiltering_format(df,format = "supermarket",category ="Household utensils",nweek=153)
hhutensils_conve <- brandfiltering_format(df,format = "convenience",category ="Household utensils",nweek=153)

#We don't even have a household utensils purchased in these three stores
```

```{r ice cream}
#Get seperate dataframe
icecream_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Ice cream",nweek=153)
icecream_super <- brandfiltering_format(df,format = "supermarket",category ="Ice cream",nweek=153)
icecream_conve <- brandfiltering_format(df,format = "convenience",category ="Ice cream",nweek=153)

#Only supermarket pass the criteria. What should we do?
```

```{r Jam}
#Get seperate dataframe
jam_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Jam",nweek=153)
jam_super <- brandfiltering_format(df,format = "supermarket",category ="Jam",nweek=153)
jam_conve <- brandfiltering_format(df,format = "convenience",category ="Jam",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Lactose Free}
#Get seperate dataframe
lactosefree_hyper <- brandfiltering_format(df,format = "hypermarket",category ="LactoseFree",nweek=153)
lactosefree_super <- brandfiltering_format(df,format = "supermarket",category ="LactoseFree",nweek=153)
lactosefree_conve <- brandfiltering_format(df,format = "convenience",category ="LactoseFree",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_lactosefree_hyper <- genrelevantvar(df=lactosefree_hyper)
df_lactosefree_super <- genrelevantvar(df=lactosefree_super)

#test discount coefficient
discount_test_lactosefree_hyper <- test_discount_coef(aggregate_df = df_lactosefree_hyper)
discount_test_lactosefree_super <- test_discount_coef(aggregate_df = df_lactosefree_super)

#test nonlinearity
nonlinear_test_lactosefree_hyper <- test_nonlinearity_both(aggregate_df = df_lactosefree_hyper,discount_coef_result = discount_test_lactosefree_hyper)
nonlinear_test_lactosefree_super <- test_nonlinearity_both(aggregate_df = df_lactosefree_super,discount_coef_result = discount_test_lactosefree_super)

#conclude nonlinearitytest
nonlinear_test_lactosefree_hyper$format <- "hypermarket"
nonlinear_test_lactosefree_super$format <- "supermarket"
nonlinearity_lactosefree_result <- rbind(nonlinear_test_lactosefree_hyper[,-(2:5)],nonlinear_test_lactosefree_super[,-(2:5)])
```

```{r Laundry}
#Get seperate dataframe
laundry_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Laundry",nweek=153)
laundry_super <- brandfiltering_format(df,format = "supermarket",category ="Laundry",nweek=153)
laundry_conve <- brandfiltering_format(df,format = "convenience",category ="Laundry",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Milk}
#Get seperate dataframe
milk_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Milk",nweek=153)
milk_super <- brandfiltering_format(df,format = "supermarket",category ="Milk",nweek=153)
milk_conve <- brandfiltering_format(df,format = "convenience",category ="Milk",nweek=153)

#Too few observation left
```
```{r Pasta}
#Get seperate dataframe
pasta_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Pasta",nweek=153)
pasta_super <- brandfiltering_format(df,format = "supermarket",category ="Pasta",nweek=153)
pasta_conve <- brandfiltering_format(df,format = "convenience",category ="Pasta",nweek=153)

#We can run for convenience and hypermarket
#Create aggregate dataframe
df_pasta_hyper <- genrelevantvar(df=pasta_hyper)
df_pasta_conve <- genrelevantvar(df=pasta_conve)

#test discount coefficient
discount_test_pasta_hyper <- test_discount_coef(aggregate_df = df_pasta_hyper)
discount_test_pasta_conve <- test_discount_coef(aggregate_df = df_pasta_conve)

#test nonlinearity
nonlinear_test_pasta_hyper <- test_nonlinearity_both(aggregate_df = df_pasta_hyper,discount_coef_result = discount_test_pasta_hyper)
nonlinear_test_pasta_conve <- test_nonlinearity_both(aggregate_df = df_pasta_conve,discount_coef_result = discount_test_pasta_conve)

#conclude nonlinearitytest
nonlinear_test_pasta_hyper$format <- "hypermarket"
nonlinear_test_pasta_conve$format <- "conveniencestore"
nonlinearity_pasta_result <- rbind(nonlinear_test_pasta_hyper[,-(2:5)],nonlinear_test_pasta_conve[,-(2:5)])
```

```{r Pastry}
#Get seperate dataframe
pastry_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Pastry",nweek=153)
pastry_super <- brandfiltering_format(df,format = "supermarket",category ="Pastry",nweek=153)
pastry_conve <- brandfiltering_format(df,format = "convenience",category ="Pastry",nweek=153)

#Too few observation left
```
```{r Readymade Meal}
#Get seperate dataframe
readymademeal_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Ready-made meals",nweek=153)
readymademeal_super <- brandfiltering_format(df,format = "supermarket",category ="Ready-made meals",nweek=153)
readymademeal_conve <- brandfiltering_format(df,format = "convenience",category ="Ready-made meals",nweek=153)

#Too few observation left
```
```{r Rice}
#Get seperate dataframe
rice_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Rice",nweek=153)
rice_super <- brandfiltering_format(df,format = "supermarket",category ="Rice",nweek=153)
rice_conve <- brandfiltering_format(df,format = "convenience",category ="Rice",nweek=153)

#Only Hypermarket pass the criteria (super almost!)
```
```{r Seasoning}
#Get seperate dataframe
seasoning_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Seasoning",nweek=153)
seasoning_super <- brandfiltering_format(df,format = "supermarket",category ="Seasoning",nweek=153)
seasoning_conve <- brandfiltering_format(df,format = "convenience",category ="Seasoning",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_seasoning_hyper <- genrelevantvar(df=seasoning_hyper)
df_seasoning_super <- genrelevantvar(df=seasoning_super)

#test discount coefficient
discount_test_seasoning_hyper <- test_discount_coef(aggregate_df = df_seasoning_hyper)
discount_test_seasoning_super <- test_discount_coef(aggregate_df = df_seasoning_super)

#test nonlinearity
nonlinear_test_seasoning_hyper <- test_nonlinearity_both(aggregate_df = df_seasoning_hyper,discount_coef_result = discount_test_seasoning_hyper)
nonlinear_test_seasoning_super <- test_nonlinearity_both(aggregate_df = df_seasoning_super,discount_coef_result = discount_test_seasoning_super)

#conclude nonlinearitytest
nonlinear_test_seasoning_hyper$format <- "hypermarket"
nonlinear_test_seasoning_super$format <- "supermarket"
nonlinearity_seasoning_result <- rbind(nonlinear_test_seasoning_hyper[,-(2:5)],nonlinear_test_seasoning_super[,-(2:5)])
```
```{r Softdrink}
#Get seperate dataframe
softdrink_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Soft drinks",nweek=153)
softdrink_super <- brandfiltering_format(df,format = "supermarket",category ="Soft drinks",nweek=153)
softdrink_conve <- brandfiltering_format(df,format = "convenience",category ="Soft drinks",nweek=153)

#Too few observation left
```

```{r Sweets and candies}
#Get seperate dataframe
sweets_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Sweets & Candy",nweek=153)
sweets_super <- brandfiltering_format(df,format = "supermarket",category ="Sweets & Candy",nweek=153)
sweets_conve <- brandfiltering_format(df,format = "convenience",category ="Sweets & Candy",nweek=153)

#Too few observation left
```

```{r Tobacco}
#Get seperate dataframe
tobacco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Tobacco",nweek=153)
tobacco_super <- brandfiltering_format(df,format = "supermarket",category ="Tobacco",nweek=153)
tobacco_conve <- brandfiltering_format(df,format = "convenience",category ="Tobacco",nweek=153)

#Too few observation left
```

```{r Tobacco}
#Get seperate dataframe
toiletpaper_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Toilet tissue",nweek=153)
toiletpaper_super <- brandfiltering_format(df,format = "supermarket",category ="Toilet tissue",nweek=153)
toiletpaper_conve <- brandfiltering_format(df,format = "convenience",category ="Toilet tissue",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_toiletpaper_hyper <- genrelevantvar(df=toiletpaper_hyper)
df_toiletpaper_super <- genrelevantvar(df=toiletpaper_super)

#test discount coefficient
discount_test_toiletpaper_hyper <- test_discount_coef(aggregate_df = df_toiletpaper_hyper)
discount_test_toiletpaper_super <- test_discount_coef(aggregate_df = df_toiletpaper_super)

#test nonlinearity
nonlinear_test_toiletpaper_hyper <- test_nonlinearity_both(aggregate_df = df_toiletpaper_hyper,discount_coef_result = discount_test_toiletpaper_hyper)
nonlinear_test_toiletpaper_super <- test_nonlinearity_both(aggregate_df = df_toiletpaper_super,discount_coef_result = discount_test_toiletpaper_super)

#conclude nonlinearitytest
nonlinear_test_toiletpaper_hyper$format <- "hypermarket"
nonlinear_test_toiletpaper_super$format <- "supermarket"
nonlinearity_toiletpaper_result <- rbind(nonlinear_test_toiletpaper_hyper[,-(2:5)],nonlinear_test_toiletpaper_super[,-(2:5)])
```

```{r Toiletries}
#Get seperate dataframe
toiletries_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Toiletries",nweek=153)
toiletries_super <- brandfiltering_format(df,format = "supermarket",category ="Toiletries",nweek=153)
toiletries_conve <- brandfiltering_format(df,format = "convenience",category ="Toiletries",nweek=153)

#Only Hypermarket pass the criteria (super almost!)
```

```{r Yoghurt}
#Get seperate dataframe
yoghurt_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Yogurt",nweek=153)
yoghurt_super <- brandfiltering_format(df,format = "supermarket",category ="Yogurt",nweek=153)
yoghurt_conve <- brandfiltering_format(df,format = "convenience",category ="Yogurt",nweek=153)

#We can run for supermarket and hypermarket (Almost for convenience, 74.06%)
#Create aggregate dataframe
df_yoghurt_hyper <- genrelevantvar(df=yoghurt_hyper)
df_yoghurt_super <- genrelevantvar(df=yoghurt_super)

#test discount coefficient
discount_test_yoghurt_hyper <- test_discount_coef(aggregate_df = df_yoghurt_hyper)
discount_test_yoghurt_super <- test_discount_coef(aggregate_df = df_yoghurt_super)

#test nonlinearity
nonlinear_test_yoghurt_hyper <- test_nonlinearity_both(aggregate_df = df_yoghurt_hyper,discount_coef_result = discount_test_yoghurt_hyper)
nonlinear_test_yoghurt_super <- test_nonlinearity_both(aggregate_df = df_yoghurt_super,discount_coef_result = discount_test_yoghurt_super)

#conclude nonlinearitytest
nonlinear_test_yoghurt_hyper$format <- "hypermarket"
nonlinear_test_yoghurt_super$format <- "supermarket"
nonlinearity_yoghurt_result <- rbind(nonlinear_test_yoghurt_hyper[,-(2:5)],nonlinear_test_yoghurt_super[,-(2:5)])
```

```{r preliminary result}
Prelim_table<- rbind(nonlinearity_bottledwater_result,nonlinearity_butter_result,nonlinearity_cannedvegg_result,nonlinearity_cereal_result,nonlinearity_chips_result,nonlinearity_choco_result,nonlinearity_cream_result,nonlinearity_lactosefree_result,nonlinearity_pasta_result,nonlinearity_seasoning_result,nonlinearity_toiletpaper_result,nonlinearity_yoghurt_result)
```



#VISUALIZATION
```{r Bottled Water}
#Get seperate dataframe
df_bottledwater_hyper <- generate_df(df,format = "hypermarket",category ="Bottled water",nweek=153)
df_bottledwater_super <- generate_df(df,format = "supermarket",category ="Bottled water",nweek=153)
df_bottledwater_conve <- generate_df(df,format = "convenience",category ="Bottled water",nweek=153)

distinctbrandcomplete<-unique(brandcompleteweek$brand)
for (i in 1:length(distinctbrandcomplete)){
plot(pdtotalvolume ~ pdavgfinalprice, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],], main = distinctbrandcomplete[i], col="blue")
abline(v= 0, col="black")
abline(h= 0, col="black")
plot(pdtotalvolume ~ pdavgpricebefore, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],], main = distinctbrandcomplete[i], col="green")
abline(v= 0, col="black")
abline(h= 0, col="black")
plot(pdtotalvolume ~ pdavgdiscount, data=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],], main = distinctbrandcomplete[i], col="red")
abline(v= 0, col="black")
abline(h= 0, col="black")
}

```

