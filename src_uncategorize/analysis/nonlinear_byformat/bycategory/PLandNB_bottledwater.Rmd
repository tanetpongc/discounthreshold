---
title: "Comparing DVs across format"
author: "Ned"
date: "02/05/2022"
output: pdf_document
---


```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand
library(ggplot2) #for plotting DVs
library(data.table) #for set DT checking brand and import
library(car) #function for testing coefficient equivalence
library(lmtest) #function for testing nonlinearity
```

# Data Management

**Procedure:** 

* Download aggregated data (a summation of weekly sales of each product SKU)
* Select categories of interest
* We are interested in PLs including ICA, ICA Basic, ICA I Love Eco, ICA Gott Liv, ICA Selection and ICA Skona
* We report market structure first and then treat non-PL as competitive national brands.
* We manually generate a aggregate price-related variables and line-length (aka assortment).


```{r read data, include=FALSE}
df_scanner <- fread("../../../../data/df_scanner_butikid.csv", encoding = 'UTF-8')
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```

```{r choose online, include=FALSE}
df_scanner$format <- ifelse(df_scanner$saljkanal == "1","online",df_scanner$format)
df_scanner$format <- as.factor(df_scanner$format)
```

```{r rename all ICA brand and code PL and NB, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
              "IBA"="ICA",
              "ICA Asia"="ICA",
              "ICA BASIC" = "ICA Basic",
              "ICA EKOLOGISKT" = "ICA I love eco",
              "ICA Cook & Eat" = "ICA",
              "ICA God smak från" = "ICA",
              "ICA GOTT LIV" = "ICA Gott Liv",
              "ICA HOME" = "ICA",
              "ICA home" = "ICA",
              "I LOVE ECO" = "ICA I love eco",
              "ICA I LOVE ECO" = "ICA I love eco",
              "ICA KVANTUM" = "ICA",
              "ICA KVANTUMS BAGERI" = "ICA",
              "ICA Rätt Enkelt" = "ICA",
              "ICA SELECTION" = "ICA Selection"
              ))
private_label <- as.factor(c("ICA","ICA Basic","ICA Gott Liv","ICA I love eco","ICA Selection","ICA Skona"))

df_scanner$brand_cat <- ifelse(df_scanner$brand %in% private_label,df_scanner$brand,"NB")
df_scanner$brand_cat <- as.factor(df_scanner$brand_cat)
df_scanner$PL <- ifelse(df_scanner$brand %in% private_label,1,0)
#df_scanner$PL <- as.factor(df_scanner$PL)
```


```{r drop unexplainablevalue, include=FALSE}
#dropdecimal and non-integer

df <- df_scanner[df_scanner$sales_volume>=1,]
df <- df[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_scanner)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner"))

```

```{r select category, include=FALSE}
category = "Bottled water"
df <- df[df$category == "Bottled water",]
```


```{r Filtering brand with complete (153) observations, echo=FALSE}
  category_hypermarket <- df[df$format == "hypermarket",]
  category_super <- df[df$format == "supermarket",]
  category_conveninence <- df[df$format == "convenience",]
  category_online <- df[df$format == "online",]
  
brandfiltering_format <- function(df_format_category,nweek){  
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand_cat,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand_cat,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand_cat=droplevels(brand_cat))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand_cat)

df_format_category_complete <- df_format_category[df_format_category$brand_cat %in% brandcompleteweek$brand_cat, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand_cat=droplevels(brand_cat))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]
message(paste("% of obs. maintain for category ",unique(df_format_category$category),"in format ",unique(df_format_category$format),":", (nobsafterdrop/nobsbeforedrop)*100))

return(df_format_category_complete)
}

category_hypermarket <- brandfiltering_format(category_hypermarket, nweek=153)
category_super <- brandfiltering_format(category_super, nweek=153)
category_conveninence <- brandfiltering_format(category_conveninence, nweek=153)
category_online <- brandfiltering_format(category_online, nweek=59)
```

\newpage
# Market Structure (Before and After treating another brand as NBs)
**Consider all brands:** 
```{r calculate info for individual brands, echo=FALSE}
brandmarketinfo_format <- function(df){  
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$discountdepth <- df$discountperunit/df$pricebeforeperunit
df$discount <- ifelse(df$discountperunit>0,1,0)
weeklymarketbyweek<-setDT(df)[, .(totalformatsales=sum(sales_volume),totalformatsalesvalue=sum(finalspending),totalformatLL=uniqueN(produkt_id)), .(vecka)] #this df will be used for category calculation
weeklymarketsharebybrand<-setDT(df)[, .(totalsales=sum(sales_volume),totalvalue=sum(finalspending),avgpricebefore=mean(pricebeforeperunit),avgfinalprice=mean(finalpriceperunit),avgdiscountdepth=mean(discountdepth), discountfrequency=sum(discount),LL=uniqueN(produkt_id)), .(vecka,brand)] #Should return nbrand x nformat rows
weeklymarketsharemerge <- merge(weeklymarketsharebybrand,weeklymarketbyweek, by=c("vecka"))
brandmarketshareformat<-setDT(weeklymarketsharemerge)[, .(avgbrandweeksales=round(mean(totalsales),digits = 0),avgmarketsharevolume=round(mean(totalsales/totalformatsales),digits = 3) ,avgmarketsharevalue=round(mean(totalvalue/totalformatsalesvalue),digits = 3) ,avgpricebefore=round(mean(avgpricebefore),digits = 2) ,avgfinalprice=round(mean(avgfinalprice),digits = 2) ,avgdiscountdepth=round(mean(avgdiscountdepth)*100,digits = 2)), .(brand)]

return(brandmarketshareformat)
}

brandinfo_category_hypermarket <- brandmarketinfo_format(category_hypermarket)
brandinfo_category_hypermarket$format <- "hypermarket"
brandinfo_category_super <- brandmarketinfo_format(category_super)
brandinfo_category_super$format <- "supermarket"
brandinfo_category_conveninence <- brandmarketinfo_format(category_conveninence)
brandinfo_category_conveninence$format <- "convenience"

brandinfo_category <- rbind(brandinfo_category_hypermarket,brandinfo_category_super,brandinfo_category_conveninence)
setorder(brandinfo_category,format,avgbrandweeksales)

knitr::kable(brandinfo_category, col.names = c('Brand','Sales(Volume)','Share(Volume)','Share(Value)','ListPrice','Final Price','Discount (%)', 'Format'))
```

**Only PLs and NBs:** 
```{r calculate info for PLs and NBs, echo=FALSE}
brandmarketPLNBinfo_format <- function(df){  
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$discountdepth <- df$discountperunit/df$pricebeforeperunit
df$discount <- ifelse(df$discountperunit>0,1,0)
weeklymarketbyweek<-setDT(df)[, .(totalformatsales=sum(sales_volume),totalformatsalesvalue=sum(finalspending),totalformatLL=uniqueN(produkt_id)), .(vecka)] #this df will be used for category calculation
weeklymarketsharebybrand<-setDT(df)[, .(totalsales=sum(sales_volume),totalvalue=sum(finalspending),avgpricebefore=mean(pricebeforeperunit),avgfinalprice=mean(finalpriceperunit),avgdiscountdepth=mean(discountdepth), discountfrequency=sum(discount),LL=uniqueN(produkt_id)), .(vecka,brand_cat)] #Should return nbrand x nformat rows
weeklymarketsharemerge <- merge(weeklymarketsharebybrand,weeklymarketbyweek, by=c("vecka"))
brandmarketshareformat<-setDT(weeklymarketsharemerge)[, .(avgbrandweeksales=round(mean(totalsales),digits = 0),avgmarketsharevolume=round(mean(totalsales/totalformatsales),digits = 3) ,avgmarketsharevalue=round(mean(totalvalue/totalformatsalesvalue),digits = 3) ,avgpricebefore=round(mean(avgpricebefore),digits = 2) ,avgfinalprice=round(mean(avgfinalprice),digits = 2) ,avgdiscountdepth=round(mean(avgdiscountdepth)*100,digits = 2)), .(brand_cat)]

return(brandmarketshareformat)
}

brandmarketPLNBinfo_category_hypermarket <- brandmarketPLNBinfo_format(category_hypermarket)
brandmarketPLNBinfo_category_hypermarket$format <- "hypermarket"
brandmarketPLNBinfo_category_super <- brandmarketPLNBinfo_format(category_super)
brandmarketPLNBinfo_category_super$format <- "supermarket"
brandmarketPLNBinfo_category_conveninence <- brandmarketPLNBinfo_format(category_conveninence)
brandmarketPLNBinfo_category_conveninence$format <- "convenience"

brandmarketPLNBinfo_category <- rbind(brandmarketPLNBinfo_category_hypermarket,brandmarketPLNBinfo_category_super,brandmarketPLNBinfo_category_conveninence)
setorder(brandmarketPLNBinfo_category,format,brand_cat)

knitr::kable(brandmarketPLNBinfo_category, col.names = c('Brand','Sales(Volume)','Share(Volume)','Share(Value)','ListPrice','Final Price','Discount (%)', 'Format'))
```


```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar <- function(df){
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id)), .(vecka,brand_cat)] 

df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand_cat"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand_cat,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(nonpricecampaign)), .(vecka,brand_cat)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info

df_bybrand <- df_bybrand %>% mutate(brand_cat=droplevels(brand_cat))
distinctbrandcomplete <- unique(df_bybrand$brand_cat)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 16 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand_cat != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand_cat == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand_cat<-as.factor(df_rep$brand_cat)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand_cat,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand_cat, FUN= lag_1)

#create brand share
weeklysalescat<-setDT(df)[, .(totalcatsales=sum(finalspending)), .(vecka)]
df_bybrand <- merge(df_bybrand,weeklysalescat, by=c("vecka"))
df_bybrand$brandshare <- (df_bybrand$totalvalue/df_bybrand$totalcatsales)
df_bybrand$brandshare1 <- ave(df_bybrand$brandshare, df_bybrand$brand_cat, FUN= lag_1)
df_bybrand$oddbrandshare = df_bybrand$brandshare/(1-df_bybrand$brandshare)
df_bybrand$oddbrandshare1 <- ave(df_bybrand$oddbrandshare, df_bybrand$brand_cat, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dtotalvolume <- df_bybrand$totalvolume-df_bybrand$totalvolume1
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$davgfinalprice <- (df_bybrand$avgfinalprice)-(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$davgpricebefore <- (df_bybrand$avgpricebefore)-(df_bybrand$avgpricebefore1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$ddiscount <- df_bybrand$avgdiscount-df_bybrand$avgdiscount1
df_bybrand$dlogdiscount <- log(df_bybrand$avgdiscount+1)-log(df_bybrand$avgdiscount1+1)
df_bybrand$dlognondepth <- log(df_bybrand$nondepth)-log(df_bybrand$nondepth1)
df_bybrand$dLL = df_bybrand$LL - df_bybrand$LL1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$davgcompLL = (df_bybrand$avgcompLL) - (df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$davgcompfinalprice = (df_bybrand$avgcompfinalprice) - (df_bybrand$avgcompfinalprice1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)
df_bybrand$dbrandshare <- df_bybrand$brandshare - df_bybrand$brandshare1
df_bybrand$dlogbrandshare <- log(df_bybrand$brandshare) - log(df_bybrand$brandshare1)
df_bybrand$dlogoddbrandshare <- log(df_bybrand$oddbrandshare) - log(df_bybrand$oddbrandshare1)

#create trend
df_bybrand$trend <- as.numeric(as.factor(df_bybrand$vecka))

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:3], by=c("vecka"))

return(df_bybrand)
}

df_category_hypermarket <- genrelevantvar(category_hypermarket)
df_category_super <- genrelevantvar(category_super)
df_category_convenience <- genrelevantvar(category_conveninence)
# df_category_online <- genrelevantvar(category_online)
```

\newpage

# Working on variables and model

**Unit** : $$\Delta(S_{i,t}) = f(ListPrice_{it},Discount_{it})$$
**log(Unit)** : $$\Delta ln(S_{i,t}) = f(ListPrice_{it},NonDiscountDepth_{it})$$
**Market Share** : $$\Delta (Share_{i,t}) = f(ListPrice_{it},Discount_{it})$$
**log(Market Share)** : $$\Delta ln(Share_{i,t}) = f(ListPrice_{it},NonDiscountDepth_{it})$$

Note that $i$ is Private label $i$ and t is week $t$

# Explore the DV across formats
```{r time series plot for DV across format, echo=FALSE}
df_category_hypermarket$format <- "hypermarket"
df_category_super$format <- "supermarket"
df_category_convenience$format <- "convenience"

dfforplotDV <- rbind(df_category_hypermarket,df_category_super,df_category_convenience)

dfforplotDV_PL <- dfforplotDV[dfforplotDV$brand_cat %in% private_label,]
distinctbrandforplot <- unique(dfforplotDV_PL$brand_cat)
dfforplotDV_PL$vecka <- as.factor(dfforplotDV_PL$vecka)

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=trend, y=dtotalvolume, color=format ,group=format)) +
  geom_line()+
  geom_point() +
  ggtitle(paste0('DTotalVolume for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=trend, y=dlogtotalvolume, color=format ,group=format)) +
  geom_line()+
  geom_point() +
  ggtitle(paste0('Dln(TotalVolume) for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=trend, y=dbrandshare*100, color=format ,group=format)) +
  geom_line()+
  geom_point() +
  ggtitle(paste0('DBrandshare for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=trend, y=dlogbrandshare, color=format ,group=format)) +
  geom_line()+
  geom_point() +
  ggtitle(paste0('Dln(Brandshare) for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=davgpricebefore, y=dtotalvolume, color=format ,group=format)) +
  geom_line()+
  ggtitle(paste0('DPrice & DUnit Level Relationship for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=dlogavgpricebefore, y=dlogtotalvolume, color=format ,group=format)) +
  geom_line() +
  ggtitle(paste0('DlnPrice & log Unit Relationship for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=ddiscount, y=dtotalvolume, color=format ,group=format)) +
  geom_line() +
  ggtitle(paste0('DDiscount & DUnit Level Relationship for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=dlognondepth, y=dlogtotalvolume, color=format ,group=format)) +
  geom_line() +
  ggtitle(paste0('DlnNonDepth & log Unit Relationship for Brand:',distinctbrandforplot[i]))
  print(p)
}

for (i in 1:length(distinctbrandforplot)){
  data=dfforplotDV_PL[dfforplotDV_PL$brand_cat == distinctbrandforplot[i],]
  p = ggplot(data, aes(x=dlogdiscount, y=dlogtotalvolume, color=format ,group=format)) +
  geom_line() +
  ggtitle(paste0('DlnDiscount & log Unit Relationship for Brand:',distinctbrandforplot[i]))
  print(p)
}
```

# Testing coefficient of price before VS discount.

* We wrote the function of testing coefficient of price before VS discount. This function will return the estimated coefficients of price before, discount and whether these coefficients are statistically significant.

\newpage
**Unit** :
$$\Delta(S_{i,t}) = \beta_{0i}+\beta_{1i}\Delta (Linelength_{it})+\beta_{2i}\Delta (RegPrice_{it})-\beta_{2'i}\Delta (Discount_{i,t}) $$
$$+\beta_{3i}\Delta (CompLinelength_{it})+\beta_{4i}\Delta (CompPrice_{it})$$
$$+\gamma_{i}[S_{i,t-1} - \beta_{5i}Linelength_{i,t-1}-\beta_{6i}RegPrice_{i,t-1}-\beta_{6'i}Discount_{i,t-1}]$$
$$+\beta_{8i}Holiday_{t}$$



```{r test discount for unit, echo=FALSE}

test_discount_coef_unit <- function(aggregate_df){
  
  aggregate_df <- aggregate_df[aggregate_df$brand_cat %in% private_label,]
  distinctbrandcomplete <- unique(aggregate_df$brand_cat)
  nbrand<-length(distinctbrandcomplete)
  
  
  df_discount_coef_test <- data.frame(matrix(NA, ncol = 7 , nrow = (nbrand))) 
  for (i in 1:length(distinctbrandcomplete)){

lm_discount_PLvolume <- lm(dtotalvolume ~ dLL + davgpricebefore + ddiscount + davgcompLL + davgcompfinalprice  + totalvolume1 + LL1 + avgpricebefore1 + avgdiscount1+ holiday ,data=aggregate_df[aggregate_df$brand_cat == distinctbrandcomplete[i],])


#test coefficient between price before discount (Testing linear hypothesis on the coefficients of a system of equations by an F-test or Wald-test)
  #see more https://kzee.github.io/CoeffDiff_Demo.html
coeftest_PLvolume<-linearHypothesis(lm_discount_PLvolume, "davgpricebefore - ddiscount = 0")


#Export Discount coefficient across format

df_discount_coef_test[i,1] <- toString(distinctbrandcomplete[i])
df_discount_coef_test[i,2] = summary(lm_discount_PLvolume)$coefficients[3,1]
df_discount_coef_test[i,3] = summary(lm_discount_PLvolume)$coefficients[3,2]
df_discount_coef_test[i,4] = summary(lm_discount_PLvolume)$coefficients[4,1]
df_discount_coef_test[i,5] = summary(lm_discount_PLvolume)$coefficients[4,2]
df_discount_coef_test[i,6] = round(coeftest_PLvolume$`Pr(>F)`[2],4)
df_discount_coef_test[i,7] = round(summary(lm_discount_PLvolume)$r.squared,4)


colnames(df_discount_coef_test) <- c('brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model')
  }
return(df_discount_coef_test)
}

testdisc_unit_category_hypermarket <- test_discount_coef_unit(df_category_hypermarket)
testdisc_unit_category_hypermarket$format <- "hypermarket"
testdisc_unit_category_super <- test_discount_coef_unit(df_category_super)
testdisc_unit_category_super$format <- "supermarket"
testdisc_unit_category_convenience <- test_discount_coef_unit(df_category_convenience)
testdisc_unit_category_convenience$format <- "convenience"

testdisc_unit_category <- rbind(testdisc_unit_category_hypermarket,testdisc_unit_category_super,testdisc_unit_category_convenience)

knitr::kable(testdisc_unit_category, col.names = c('Brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model', 'Format'))
```


**log(Unit)**

$$\Delta ln(S_{ijk,t}) = \beta_{0ijk}+\beta_{1ijk,t}\Delta ln(Linelength_{it})+\beta_{2ijk}(\Delta ln(ListPrice_{ijk,t})+ \beta_{2'ijk} \Delta (ln(1 - {Depth_{ijk,t}))} $$
$$+\beta_{3ijk}\Delta ln(CompLinelength_{ijk,t})+\beta_{4ijk}\Delta ln(CompPrice_{ijk,t})$$
$$+\gamma_{i}[S_{ijk,t-1} - \beta_{5ijk}ln(Linelength_{ijk,t-1})-\beta_{6ijk}(\Delta ln(ListPrice_{ijk,t-1})- \beta_{6'ijk} (ln(1 - {Depth_{ijk,t-1}})))]$$
$$+\beta_{8ijk}Holiday_{t}$$
```{r test discount for log unit, echo=FALSE}

test_discount_coef_log <- function(aggregate_df){
  
  aggregate_df <- aggregate_df[aggregate_df$brand_cat %in% private_label,]
  distinctbrandcomplete <- unique(aggregate_df$brand_cat)
  nbrand<-length(distinctbrandcomplete)
  
  
  df_discount_coef_test <- data.frame(matrix(NA, ncol = 7 , nrow = (nbrand))) 
  for (i in 1:length(distinctbrandcomplete)){

lm_discount_PLlog <- lm(dlogtotalvolume ~ dlogLL + dlogavgpricebefore + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday  ,data=aggregate_df[aggregate_df$brand_cat == distinctbrandcomplete[i],])


#test coefficient between price before discount (Testing linear hypothesis on the coefficients of a system of equations by an F-test or Wald-test)
  #see more https://kzee.github.io/CoeffDiff_Demo.html
coeftest_PLlog<-linearHypothesis(lm_discount_PLlog, "dlogavgpricebefore - dlognondepth = 0")


#Export Discount coefficient across format

df_discount_coef_test[i,1] <- toString(distinctbrandcomplete[i])
df_discount_coef_test[i,2] = summary(lm_discount_PLlog)$coefficients[3,1]
df_discount_coef_test[i,3] = summary(lm_discount_PLlog)$coefficients[3,2]
df_discount_coef_test[i,4] = summary(lm_discount_PLlog)$coefficients[4,1]
df_discount_coef_test[i,5] = summary(lm_discount_PLlog)$coefficients[4,2]
df_discount_coef_test[i,6] = round(coeftest_PLlog$`Pr(>F)`[2],4)
df_discount_coef_test[i,7] = round(summary(lm_discount_PLlog)$r.squared,4)


colnames(df_discount_coef_test) <- c('brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model')
  }
return(df_discount_coef_test)
}

testdisc_log_category_hypermarket <- test_discount_coef_log(df_category_hypermarket)
testdisc_log_category_hypermarket$format <- "hypermarket"
testdisc_log_category_super <- test_discount_coef_log(df_category_super)
testdisc_log_category_super$format <- "supermarket"
testdisc_log_category_convenience <- test_discount_coef_log(df_category_convenience)
testdisc_log_category_convenience$format <- "convenience"

testdisc_log_category <- rbind(testdisc_log_category_hypermarket,testdisc_log_category_super,testdisc_log_category_convenience)

knitr::kable(testdisc_log_category, col.names = c('Brand','Co Price','Sd Price','Co NonDiscountDept','Sd Discount','p coef test','R2 of model', 'Format'))
```

\newpage
**Market Share** :
$$\Delta(Share_{i,t}) = \beta_{0i}+\beta_{1i}\Delta (Linelength_{it})+\beta_{2i}\Delta (RegPrice_{it})-\beta_{2'i}\Delta (Discount_{i,t}) $$
$$+\beta_{3i}\Delta (CompLinelength_{it})+\beta_{4i}\Delta (CompPrice_{it})$$
$$+\gamma_{i}[S_{i,t-1} - \beta_{5i}Linelength_{i,t-1}-\beta_{6i}RegPrice_{i,t-1}-\beta_{6'i}Discount_{i,t-1}]$$
$$+\beta_{8i}Holiday_{t}$$



```{r test discount for market share, echo=FALSE}

test_discount_coef_share <- function(aggregate_df){
  
  aggregate_df <- aggregate_df[aggregate_df$brand_cat %in% private_label,]
  distinctbrandcomplete <- unique(aggregate_df$brand_cat)
  nbrand<-length(distinctbrandcomplete)
  
  
  df_discount_coef_test <- data.frame(matrix(NA, ncol = 7 , nrow = (nbrand))) 
  for (i in 1:length(distinctbrandcomplete)){

lm_discount_PLshare <- lm(dbrandshare ~ dLL + davgpricebefore + ddiscount + davgcompLL + davgcompfinalprice  + totalvolume1 + LL1 + avgpricebefore1 + avgdiscount1 + holiday ,data=aggregate_df[aggregate_df$brand_cat == distinctbrandcomplete[i],])


#test coefficient between price before discount (Testing linear hypothesis on the coefficients of a system of equations by an F-test or Wald-test)
  #see more https://kzee.github.io/CoeffDiff_Demo.html
coeftest_PLshare<-linearHypothesis(lm_discount_PLshare, "davgpricebefore - ddiscount = 0")


#Export Discount coefficient across format

df_discount_coef_test[i,1] <- toString(distinctbrandcomplete[i])
df_discount_coef_test[i,2] = summary(lm_discount_PLshare)$coefficients[3,1]
df_discount_coef_test[i,3] = summary(lm_discount_PLshare)$coefficients[3,2]
df_discount_coef_test[i,4] = summary(lm_discount_PLshare)$coefficients[4,1]
df_discount_coef_test[i,5] = summary(lm_discount_PLshare)$coefficients[4,2]
df_discount_coef_test[i,6] = round(coeftest_PLshare$`Pr(>F)`[2],4)
df_discount_coef_test[i,7] = round(summary(lm_discount_PLshare)$r.squared,4)


colnames(df_discount_coef_test) <- c('brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model')
  }
return(df_discount_coef_test)
}

testdisc_share_category_hypermarket <- test_discount_coef_share(df_category_hypermarket)
testdisc_share_category_hypermarket$format <- "hypermarket"
testdisc_share_category_super <- test_discount_coef_share(df_category_super)
testdisc_share_category_super$format <- "supermarket"
testdisc_share_category_convenience <- test_discount_coef_share(df_category_convenience)
testdisc_share_category_convenience$format <- "convenience"

testdisc_share_category <- rbind(testdisc_share_category_hypermarket,testdisc_share_category_super,testdisc_share_category_convenience)

knitr::kable(testdisc_share_category, col.names = c('Brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model', 'Format'))
```


**log(Market Share)**

$$\Delta ln(Share_{ijk,t}) = \beta_{0ijk}+\beta_{1ijk,t}\Delta ln(Linelength_{it})+\beta_{2ijk}(\Delta ln(ListPrice_{ijk,t})+ \beta_{2'ijk} \Delta (ln(1 - {Depth_{ijk,t}))} $$
$$+\beta_{3ijk}\Delta ln(CompLinelength_{ijk,t})+\beta_{4ijk}\Delta ln(CompPrice_{ijk,t})$$
$$+\gamma_{i}[S_{ijk,t-1} - \beta_{5ijk}ln(Linelength_{ijk,t-1})-\beta_{6ijk}(\Delta ln(ListPrice_{ijk,t-1})- \beta_{6'ijk} (ln(1 - {Depth_{ijk,t-1}})))]$$
$$+\beta_{8ijk}Holiday_{t}$$
```{r test discount for log market share, echo=FALSE}

test_discount_coef_logshare <- function(aggregate_df){
  
  aggregate_df <- aggregate_df[aggregate_df$brand_cat %in% private_label,]
  distinctbrandcomplete <- unique(aggregate_df$brand_cat)
  nbrand<-length(distinctbrandcomplete)
  
  
  df_discount_coef_test <- data.frame(matrix(NA, ncol = 7 , nrow = (nbrand))) 
  for (i in 1:length(distinctbrandcomplete)){

lm_discount_PLlogshare <- lm(dlogbrandshare ~ dlogLL + dlogavgpricebefore + dlognondepth + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgpricebefore1) + log(nondepth1) + holiday  ,data=aggregate_df[aggregate_df$brand_cat == distinctbrandcomplete[i],])


#test coefficient between price before discount (Testing linear hypothesis on the coefficients of a system of equations by an F-test or Wald-test)
  #see more https://kzee.github.io/CoeffDiff_Demo.html
coeftest_PLlogshare<-linearHypothesis(lm_discount_PLlogshare, "dlogavgpricebefore - dlognondepth = 0")


#Export Discount coefficient across format

df_discount_coef_test[i,1] <- toString(distinctbrandcomplete[i])
df_discount_coef_test[i,2] = summary(lm_discount_PLlogshare)$coefficients[3,1]
df_discount_coef_test[i,3] = summary(lm_discount_PLlogshare)$coefficients[3,2]
df_discount_coef_test[i,4] = summary(lm_discount_PLlogshare)$coefficients[4,1]
df_discount_coef_test[i,5] = summary(lm_discount_PLlogshare)$coefficients[4,2]
df_discount_coef_test[i,6] = round(coeftest_PLlogshare$`Pr(>F)`[2],4)
df_discount_coef_test[i,7] = round(summary(lm_discount_PLlogshare)$r.squared,4)


colnames(df_discount_coef_test) <- c('brand','Co Price','Sd Price','Co Discount','Sd Discount','p coef test','R2 of model')
  }
return(df_discount_coef_test)
}

testdisc_logshare_category_hypermarket <- test_discount_coef_logshare(df_category_hypermarket)
testdisc_logshare_category_hypermarket$format <- "hypermarket"
testdisc_logshare_category_super <- test_discount_coef_logshare(df_category_super)
testdisc_logshare_category_super$format <- "supermarket"
testdisc_logshare_category_convenience <- test_discount_coef_logshare(df_category_convenience)
testdisc_logshare_category_convenience$format <- "convenience"

testdisc_logshare_category <- rbind(testdisc_logshare_category_hypermarket,testdisc_logshare_category_super,testdisc_logshare_category_convenience)

knitr::kable(testdisc_logshare_category, col.names = c('Brand','Co Price','Sd Price','Co NonDiscountDept','Sd Discount','p coef test','R2 of model', 'Format'))
```

\newpage

# Testing coefficient of price gap VS discount

**Unit** : $$\Delta(S_{i,t}) = f(ListPrice_{it},Discount_{it},ListPriceHistGap_{it},DiscountHistGap_{it},ListPriceCompGap_{it},DiscountCompGap_{it})$$
**log(Unit)** : $$\Delta ln(S_{i,t}) = f(ListPrice_{it},NonDiscountDepth_{it},ListPriceHistGap_{it},NonDiscHistGap_{it},ListPriceCompGap_{it},NonDiscCompGap_{it})$$
**Market Share** : $$\Delta (Share_{i,t}) = f(ListPrice_{it},Discount_{it},ListPriceHistGap_{it},DiscountHistGap_{it},ListPriceCompGap_{it},DiscountCompGap_{it})$$
**log(Market Share)** : $$\Delta ln(Share_{i,t}) = f(ListPrice_{it},NonDiscountDepth_{it},ListPriceHistGap_{it},NonDiscHistGap_{it},ListPriceCompGap_{it},NonDiscCompGap_{it})$$