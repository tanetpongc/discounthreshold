---
title: "Managebrandandcategorydata for (aggregate model) discount loss threshold"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand
library(ggplot2) #for plotting
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_discount_threshold.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```


```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```

```{r filter the SKU by format}
filterSKU <- function(df,format){
df_format <- df[df$format == format,]
SKU_count<-setDT(df_format)[, .N, .(vecka,produkt_id)]
SKUweeksalestime<-setDT(SKU_count)[, .N, .(produkt_id)]#we count if the brand got shown in the scanner 
SKUcompleteweek<-subset(SKUweeksalestime, N >= 153)
SKUcompleteweek$produkt_id <- as.factor(SKUcompleteweek$produkt_id)
SKUcompleteweek <- SKUcompleteweek %>% mutate(produkt_id=droplevels(produkt_id))
df_format_complete <- df_format[df_format$produkt_id %in% SKUcompleteweek$produkt_id, ]

print(paste("totalsales_before:",sum(df_format$finalspending),"totalsales_remained:",sum(df_format_complete$finalspending),"maintain(%):", (sum(df_format_complete$finalspending/sum(df_format$finalspending))*100)))
return(df_format_complete)
}


df_hypermarket <- filterSKU(df,format = "hypermarket")
df_supermarket <- filterSKU(df,format = "hypermarket")
df_conve <- filterSKU(df,format = "hypermarket")

```



#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar <- function(df,format,category){
  df <- df[df$category == category & df$format == format,]
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalcampaign=.N,totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand_PLNB,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand_PLNB","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign),totalcampaign=sum(totalcampaign)), .(vecka,brand_PLNB,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)
df_bybrand$pricecampaignintensity <- ((df_bybrand$totalpricecampaign/df_bybrand$totalcampaign)*100)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info

distinctbrandcomplete <- unique(df$brand_PLNB)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 20 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand_PLNB != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand_PLNB == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgcompfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgcomppricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgcompdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of (log) variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dtotalvolume <- (df_bybrand$totalvolume)-(df_bybrand$totalvolume1)
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$davgfinalprice <- (df_bybrand$avgfinalprice)-(df_bybrand$avgfinalprice1)
df_bybrand$davgpricebefore <- (df_bybrand$avgpricebefore)-(df_bybrand$avgpricebefore1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dnondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlognondepth <- log(df_bybrand$nondepth)-log(df_bybrand$nondepth1)
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

df_bybrand$logavgdiscount <- log(df_bybrand$avgdiscount+1)
df_bybrand$logavgdiscount1 <- log(df_bybrand$avgdiscount1+1)
df_bybrand$dlogavgdiscount <- log(df_bybrand$avgdiscount+1) - log(df_bybrand$avgdiscount1+1)
df_bybrand$logtotalvolume <- log(df_bybrand$totalvolume)
df_bybrand$logavgpricebefore <- log(df_bybrand$avgpricebefore)
df_bybrand$logavgcompfinalprice <- log(df_bybrand$avgcompfinalprice)
df_bybrand$logavgfinalprice <- log(df_bybrand$avgfinalprice)


#create copula
make_copula <- function(x) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-.0000001), qnorm(ecdf(x)(x))))}
#This functions transforms a variable (condition: non-normally distributed) to its copula-correction term which can be entered in model estimation. See Park and Gupta (2012, Marketing Science)
df_bybrand$cop_logavgpricebefore <- make_copula(log((df_bybrand$avgpricebefore)))
df_bybrand$cop_logavgfinalprice <- make_copula(log((df_bybrand$avgfinalprice)))
df_bybrand$cop_logdiscount <- make_copula(df_bybrand$logavgdiscount)
df_bybrand$cop_lognondepth<- make_copula(log(df_bybrand$nondepth))

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))

#convert format back
df_bybrand$format <- format
df_bybrand$category <- category


return(df_bybrand)
}

```



#Prepare data for estimating aggregate
```{r}
baking_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Baking ingredients")
baking_super_PL <- genrelevantvar(df,format = "supermarket",category ="Baking ingredients")
baking_conve_PL <- genrelevantvar(df,format = "convenience",category ="Baking ingredients")

biscuit_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Biscuits")
biscuit_super_PL <- genrelevantvar(df,format = "supermarket",category ="Biscuits")
# biscuit_conve_PL <- genrelevantvar(df,format = "convenience",category ="Biscuits") #there are several weeks ICA is not sold in convenient store

butter_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Butter")
butter_super_PL <- genrelevantvar(df,format = "supermarket",category ="Butter")
butter_conve_PL <- genrelevantvar(df,format = "convenience",category ="Butter")

bottledwater_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Bottled water")
bottledwater_super_PL <- genrelevantvar(df,format = "supermarket",category ="Bottled water")
# bottledwater_conve_PL <- genrelevantvar(df,format = "convenience",category ="Bottled water") #there is one week ICA is not sold in convenient store

cereals_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cereals")
cereals_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cereals")
# cereals_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cereals") #there is one week ICA is not sold in convenient store

chips_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Chips & Salty snacks")
chips_super_PL <- genrelevantvar(df,format = "supermarket",category ="Chips & Salty snacks")
chips_conve_PL <- genrelevantvar(df,format = "convenience",category ="Chips & Salty snacks")

coffee_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Coffee")
coffee_super_PL <- genrelevantvar(df,format = "supermarket",category ="Coffee")
#coffee_conve_PL <- genrelevantvar(df,format = "convenience",category ="Coffee") #there are several weeks ICA is not sold in convenient store

cookie_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cookies")
cookie_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cookies")
# cookie_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cookies") #there is one week ICA is not sold in convenient store

cream_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cream")
cream_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cream")
cream_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cream")

frozenpizz_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Frozen Pizza Snacks")
# frozenpizz_super_PL <- genrelevantvar(df,format = "supermarket",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store
# frozenpizz_conve_PL <- genrelevantvar(df,format = "convenience",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store

juice_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Fruit Juice")
juice_super_PL <- genrelevantvar(df,format = "supermarket",category ="Fruit Juice")
# juice_conve_PL <- genrelevantvar(df,format = "convenience",category ="Fruit Juice") #there is one week ICA is not sold in convenient

icecream_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Ice cream")
icecream_super_PL <- genrelevantvar(df,format = "supermarket",category ="Ice cream")
# icecream_conve_PL <- genrelevantvar(df,format = "convenience",category ="Ice cream") #there are several weeks ICA is not sold in convenient store

jam_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Jam")
jam_super_PL <- genrelevantvar(df,format = "supermarket",category ="Jam")
jam_conve_PL <- genrelevantvar(df,format = "convenience",category ="Jam")

lactosefree_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="LactoseFree")
lactosefree_super_PL <- genrelevantvar(df,format = "supermarket",category ="LactoseFree")
lactosefree_conve_PL <- genrelevantvar(df,format = "convenience",category ="LactoseFree")

pastry_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Pastry")
pastry_super_PL <- genrelevantvar(df,format = "supermarket",category ="Pastry")
#pastry_conve_PL <- genrelevantvar(df,format = "convenience",category ="Pastry") #there are several weeks ICA is not sold in convenient store

readymeal_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Ready-made meals")
readymeal_super_PL <- genrelevantvar(df,format = "supermarket",category ="Ready-made meals")
readymeal_conve_PL <- genrelevantvar(df,format = "convenience",category ="Ready-made meals")

rice_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Rice")
rice_super_PL <- genrelevantvar(df,format = "supermarket",category ="Rice")
#rice_conve_PL <- genrelevantvar(df,format = "convenience",category ="Rice") #there are several weeks ICA is not sold in convenient store

seasoning_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Seasoning")
seasoning_super_PL <- genrelevantvar(df,format = "supermarket",category ="Seasoning")
#seasoning_conve_PL <- genrelevantvar(df,format = "convenience",category ="Seasoning") #there is one week ICA is not sold in convenient

softdrink_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Soft drinks")
softdrink_super_PL <- genrelevantvar(df,format = "supermarket",category ="Soft drinks")
#softdrink_conve_PL <- genrelevantvar(df,format = "convenience",category ="Soft drinks") #there is one week ICA is not sold in convenient

yoghurt_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Yogurt")
yoghurt_super_PL <- genrelevantvar(df,format = "supermarket",category ="Yogurt")
yoghurt_conve_PL <- genrelevantvar(df,format = "convenience",category ="Yogurt")
```

#Estimate Nonlinear Model
```{r eval=FALSE, include=FALSE}

baking_hyper_PL_est <- discountnonlinearest_PL(df = baking_hyper_PL)
baking_super_PL_est <- discountnonlinearest_PL(df = baking_super_PL)
baking_conve_PL_est <- discountnonlinearest_PL(df = baking_conve_PL)

biscuit_hyper_PL_est <- discountnonlinearest_PL(df = biscuit_hyper_PL)
biscuit_super_PL_est <- discountnonlinearest_PL(df = biscuit_super_PL)


butter_hyper_PL_est <- discountnonlinearest_PL(df = butter_hyper_PL)
butter_super_PL_est <- discountnonlinearest_PL(df = butter_super_PL)
butter_conve_PL_est <- discountnonlinearest_PL(df = butter_conve_PL)

bottledwater_hyper_PL_est <- discountnonlinearest_PL(df = bottledwater_hyper_PL)
bottledwater_super_PL_est <- discountnonlinearest_PL(df = bottledwater_super_PL)


cereals_hyper_PL_est <- discountnonlinearest_PL(df = cereals_hyper_PL)
cereals_super_PL_est <- discountnonlinearest_PL(df = cereals_super_PL)


chips_hyper_PL_est <- discountnonlinearest_PL(df = chips_hyper_PL)
chips_super_PL_est <- discountnonlinearest_PL(df = chips_super_PL)
chips_conve_PL_est <- discountnonlinearest_PL(df = chips_conve_PL)

coffee_hyper_PL_est <- discountnonlinearest_PL(df = coffee_hyper_PL)
coffee_super_PL_est <- discountnonlinearest_PL(df = coffee_super_PL)


cookie_hyper_PL_est <- discountnonlinearest_PL(df = cookie_hyper_PL)
cookie_super_PL_est <- discountnonlinearest_PL(df = cookie_super_PL)


cream_hyper_PL_est <- discountnonlinearest_PL(df = cream_hyper_PL)
cream_super_PL_est <- discountnonlinearest_PL(df = cream_super_PL)
cream_conve_PL_est <- discountnonlinearest_PL(df = cream_conve_PL)

frozenpizz_hyper_PL_est <- discountnonlinearest_PL(df = frozenpizz_hyper_PL)

juice_hyper_PL_est <- discountnonlinearest_PL(df = juice_hyper_PL)
juice_super_PL_est <- discountnonlinearest_PL(df = juice_super_PL)


icecream_hyper_PL_est <- discountnonlinearest_PL(df = icecream_hyper_PL)
icecream_super_PL_est <- discountnonlinearest_PL(df = icecream_super_PL)

jam_hyper_PL_est <- discountnonlinearest_PL(df = jam_hyper_PL)
jam_super_PL_est <- discountnonlinearest_PL(df = jam_super_PL)
jam_conve_PL_est <- discountnonlinearest_PL(df = jam_conve_PL)

lactosefree_hyper_PL_est <- discountnonlinearest_PL(df = lactosefree_hyper_PL)
lactosefree_super_PL_est <- discountnonlinearest_PL(df = lactosefree_super_PL)
lactosefree_conve_PL_est <- discountnonlinearest_PL(df = lactosefree_conve_PL)

pastry_hyper_PL_est <- discountnonlinearest_PL(df = pastry_hyper_PL)
pastry_super_PL_est <- discountnonlinearest_PL(df = pastry_super_PL)


readymeal_hyper_PL_est <- discountnonlinearest_PL(df = readymeal_hyper_PL)
readymeal_super_PL_est <- discountnonlinearest_PL(df = readymeal_super_PL)
readymeal_conve_PL_est <- discountnonlinearest_PL(df = readymeal_conve_PL)

rice_hyper_PL_est <- discountnonlinearest_PL(df = rice_hyper_PL)
rice_super_PL_est <- discountnonlinearest_PL(df = rice_super_PL)


seasoning_hyper_PL_est <- discountnonlinearest_PL(df = seasoning_hyper_PL)
seasoning_super_PL_est <- discountnonlinearest_PL(df = seasoning_super_PL)


softdrink_hyper_PL_est <- discountnonlinearest_PL(df = softdrink_hyper_PL)
softdrink_super_PL_est <- discountnonlinearest_PL(df = softdrink_super_PL)


yoghurt_hyper_PL_est <- discountnonlinearest_PL(df = yoghurt_hyper_PL)
yoghurt_super_PL_est <- discountnonlinearest_PL(df = yoghurt_super_PL)
yoghurt_conve_PL_est <- discountnonlinearest_PL(df = yoghurt_conve_PL)
```

```{r plot explore}
Combined_Dataset <- rbind(baking_hyper_PL,baking_super_PL,baking_conve_PL, 
                          biscuit_hyper_PL,biscuit_super_PL,
                          butter_hyper_PL,butter_super_PL,butter_conve_PL,
                          bottledwater_hyper_PL,bottledwater_super_PL,
                          cereals_hyper_PL,cereals_super_PL,
                          chips_hyper_PL,chips_super_PL,chips_conve_PL,
                          coffee_hyper_PL,coffee_super_PL,
                          cookie_hyper_PL,cookie_super_PL,
                          cream_hyper_PL,cream_super_PL,cream_conve_PL,
                          frozenpizz_hyper_PL,
                          juice_hyper_PL,juice_super_PL,
                          icecream_hyper_PL,icecream_super_PL,
                          jam_hyper_PL,jam_super_PL,jam_conve_PL,
                          lactosefree_hyper_PL,lactosefree_super_PL,lactosefree_conve_PL,
                          pastry_hyper_PL,pastry_super_PL,
                          readymeal_hyper_PL,readymeal_super_PL,readymeal_conve_PL,
                          rice_hyper_PL,rice_super_PL,
                          seasoning_hyper_PL,seasoning_super_PL,
                          softdrink_hyper_PL,softdrink_super_PL,
                          yoghurt_hyper_PL,yoghurt_super_PL,yoghurt_conve_PL)


Combined_Dataset_PL <- Combined_Dataset[Combined_Dataset$brand == "PL",]



data_PL_hypermarket <- Combined_Dataset_PL[Combined_Dataset_PL$format == "hypermarket",]
distinctcategory_hyper <- unique(data_PL_hypermarket$category)
ncategory_hyper<-length(distinctcategory_hyper)

data_PL_supermarket <- Combined_Dataset_PL[Combined_Dataset_PL$format == "supermarket",]
distinctcategory_super <- unique(data_PL_supermarket$category)
ncategory_super<-length(distinctcategory_super)

data_PL_conve <- Combined_Dataset_PL[Combined_Dataset_PL$format == "convenience",]
distinctcategory_conve <- unique(data_PL_conve$category)
ncategory_conve<-length(distinctcategory_conve)

par(mfrow = c(3,2))
for (i in 1:length(distinctcategory_hyper)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="pink")
  hist(data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],]$dlogavgpricebefore,main = paste("ICA Hypermarket",distinctcategory_hyper[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],]$dlognondepth,main = paste("ICA Hypermarket",distinctcategory_hyper[i]),xlab = "dlognondepth")
}

for (i in 1:length(distinctcategory_super)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="pink")
  hist(data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],]$dlogavgpricebefore,main = paste("ICA Supermarket",distinctcategory_super[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],]$dlognondepth,main = paste("ICA Supermarket",distinctcategory_super[i]),xlab = "dlognondepth")
}

for (i in 1:length(distinctcategory_conve)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="pink")
  hist(data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],]$dlogavgpricebefore,main = paste("ICA Convenience",distinctcategory_conve[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],]$dlognondepth,main = paste("ICA Convenience",distinctcategory_conve[i]),xlab = "dlognondepth")
}

```

#Estimate Nonlinear Model WITH LEVEL
```{r eval=FALSE, include=FALSE}

baking_hyper_PL_est <- discountnonlinearest_PL_level(df = baking_hyper_PL)
baking_super_PL_est <- discountnonlinearest_PL_level(df = baking_super_PL)
baking_conve_PL_est <- discountnonlinearest_PL_level(df = baking_conve_PL)

biscuit_hyper_PL_est <- discountnonlinearest_PL_level(df = biscuit_hyper_PL)
biscuit_super_PL_est <- discountnonlinearest_PL_level(df = biscuit_super_PL)


butter_hyper_PL_est <- discountnonlinearest_PL_level(df = butter_hyper_PL)
butter_super_PL_est <- discountnonlinearest_PL_level(df = butter_super_PL)
butter_conve_PL_est <- discountnonlinearest_PL_level(df = butter_conve_PL)

bottledwater_hyper_PL_est <- discountnonlinearest_PL_level(df = bottledwater_hyper_PL)
bottledwater_super_PL_est <- discountnonlinearest_PL_level(df = bottledwater_super_PL)


cereals_hyper_PL_est <- discountnonlinearest_PL_level(df = cereals_hyper_PL)
cereals_super_PL_est <- discountnonlinearest_PL_level(df = cereals_super_PL)


chips_hyper_PL_est <- discountnonlinearest_PL_level(df = chips_hyper_PL)
chips_super_PL_est <- discountnonlinearest_PL_level(df = chips_super_PL)
chips_conve_PL_est <- discountnonlinearest_PL_level(df = chips_conve_PL)

coffee_hyper_PL_est <- discountnonlinearest_PL_level(df = coffee_hyper_PL)
coffee_super_PL_est <- discountnonlinearest_PL_level(df = coffee_super_PL)


cookie_hyper_PL_est <- discountnonlinearest_PL_level(df = cookie_hyper_PL)
cookie_super_PL_est <- discountnonlinearest_PL_level(df = cookie_super_PL)


cream_hyper_PL_est <- discountnonlinearest_PL_level(df = cream_hyper_PL)
cream_super_PL_est <- discountnonlinearest_PL_level(df = cream_super_PL)
cream_conve_PL_est <- discountnonlinearest_PL_level(df = cream_conve_PL)

frozenpizz_hyper_PL_est <- discountnonlinearest_PL_level(df = frozenpizz_hyper_PL)

juice_hyper_PL_est <- discountnonlinearest_PL_level(df = juice_hyper_PL)
juice_super_PL_est <- discountnonlinearest_PL_level(df = juice_super_PL)


icecream_hyper_PL_est <- discountnonlinearest_PL_level(df = icecream_hyper_PL)
icecream_super_PL_est <- discountnonlinearest_PL_level(df = icecream_super_PL)

jam_hyper_PL_est <- discountnonlinearest_PL_level(df = jam_hyper_PL)
jam_super_PL_est <- discountnonlinearest_PL_level(df = jam_super_PL)
jam_conve_PL_est <- discountnonlinearest_PL_level(df = jam_conve_PL)

lactosefree_hyper_PL_est <- discountnonlinearest_PL_level(df = lactosefree_hyper_PL)
lactosefree_super_PL_est <- discountnonlinearest_PL_level(df = lactosefree_super_PL)
lactosefree_conve_PL_est <- discountnonlinearest_PL_level(df = lactosefree_conve_PL)

pastry_hyper_PL_est <- discountnonlinearest_PL_level(df = pastry_hyper_PL)
pastry_super_PL_est <- discountnonlinearest_PL_level(df = pastry_super_PL)


readymeal_hyper_PL_est <- discountnonlinearest_PL_level(df = readymeal_hyper_PL)
readymeal_super_PL_est <- discountnonlinearest_PL_level(df = readymeal_super_PL)
readymeal_conve_PL_est <- discountnonlinearest_PL_level(df = readymeal_conve_PL)

rice_hyper_PL_est <- discountnonlinearest_PL_level(df = rice_hyper_PL)
rice_super_PL_est <- discountnonlinearest_PL_level(df = rice_super_PL)


seasoning_hyper_PL_est <- discountnonlinearest_PL_level(df = seasoning_hyper_PL)
seasoning_super_PL_est <- discountnonlinearest_PL_level(df = seasoning_super_PL)


softdrink_hyper_PL_est <- discountnonlinearest_PL_level(df = softdrink_hyper_PL)
softdrink_super_PL_est <- discountnonlinearest_PL_level(df = softdrink_super_PL)


yoghurt_hyper_PL_est <- discountnonlinearest_PL_level(df = yoghurt_hyper_PL)
yoghurt_super_PL_est <- discountnonlinearest_PL_level(df = yoghurt_super_PL)
yoghurt_conve_PL_est <- discountnonlinearest_PL_level(df = yoghurt_conve_PL)
```

#Estimate Nonlinear Model WITH LEVEL
```{r eval=FALSE, include=FALSE}

baking_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_hyper_PL)[[1]]
baking_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_super_PL)[[1]]
baking_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_conve_PL)[[1]]

biscuit_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = biscuit_hyper_PL)[[1]]
biscuit_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = biscuit_super_PL)[[1]]


butter_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_hyper_PL)[[1]]
butter_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_super_PL)[[1]]
butter_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_conve_PL)[[1]]

bottledwater_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = bottledwater_hyper_PL)[[1]]
bottledwater_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = bottledwater_super_PL)[[1]]


cereals_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cereals_hyper_PL)[[1]]
cereals_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cereals_super_PL)[[1]]


chips_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_hyper_PL)[[1]]
chips_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_super_PL)[[1]]
chips_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_conve_PL)[[1]]

coffee_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = coffee_hyper_PL)[[1]]
coffee_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = coffee_super_PL)[[1]]


cookie_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cookie_hyper_PL)[[1]]
cookie_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cookie_super_PL)[[1]]


cream_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_hyper_PL)[[1]]
cream_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_super_PL)[[1]]
cream_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_conve_PL)[[1]]

frozenpizz_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = frozenpizz_hyper_PL)[[1]]

juice_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = juice_hyper_PL)[[1]]
juice_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = juice_super_PL)[[1]]


icecream_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = icecream_hyper_PL)[[1]]
icecream_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = icecream_super_PL)[[1]]

jam_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_hyper_PL)[[1]]
jam_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_super_PL)[[1]]
jam_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_conve_PL)[[1]]

lactosefree_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_hyper_PL)[[1]]
lactosefree_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_super_PL)[[1]]
lactosefree_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_conve_PL)[[1]]

pastry_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = pastry_hyper_PL)[[1]]
pastry_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = pastry_super_PL)[[1]]


readymeal_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_hyper_PL)[[1]]
readymeal_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_super_PL)[[1]]
readymeal_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_conve_PL)[[1]]

rice_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = rice_hyper_PL)[[1]]
rice_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = rice_super_PL)[[1]]


seasoning_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = seasoning_hyper_PL)[[1]]
seasoning_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = seasoning_super_PL)[[1]]


softdrink_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = softdrink_hyper_PL)[[1]]
softdrink_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = softdrink_super_PL)[[1]]


yoghurt_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_hyper_PL)[[1]]
yoghurt_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_super_PL)[[1]]
yoghurt_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_conve_PL)[[1]]


baking_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = baking_hyper_PL)[[2]]
baking_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = baking_super_PL)[[2]]
baking_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = baking_conve_PL)[[2]]

biscuit_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = biscuit_hyper_PL)[[2]]
biscuit_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = biscuit_super_PL)[[2]]


butter_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = butter_hyper_PL)[[2]]
butter_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = butter_super_PL)[[2]]
butter_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = butter_conve_PL)[[2]]

bottledwater_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = bottledwater_hyper_PL)[[2]]
bottledwater_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = bottledwater_super_PL)[[2]]


cereals_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cereals_hyper_PL)[[2]]
cereals_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cereals_super_PL)[[2]]


chips_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = chips_hyper_PL)[[2]]
chips_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = chips_super_PL)[[2]]
chips_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = chips_conve_PL)[[2]]

coffee_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = coffee_hyper_PL)[[2]]
coffee_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = coffee_super_PL)[[2]]


cookie_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cookie_hyper_PL)[[2]]
cookie_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cookie_super_PL)[[2]]


cream_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cream_hyper_PL)[[2]]
cream_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cream_super_PL)[[2]]
cream_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = cream_conve_PL)[[2]]

frozenpizz_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = frozenpizz_hyper_PL)[[2]]

juice_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = juice_hyper_PL)[[2]]
juice_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = juice_super_PL)[[2]]


icecream_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = icecream_hyper_PL)[[2]]
icecream_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = icecream_super_PL)[[2]]

jam_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = jam_hyper_PL)[[2]]
jam_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = jam_super_PL)[[2]]
jam_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = jam_conve_PL)[[2]]

lactosefree_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = lactosefree_hyper_PL)[[2]]
lactosefree_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = lactosefree_super_PL)[[2]]
lactosefree_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = lactosefree_conve_PL)[[2]]

pastry_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = pastry_hyper_PL)[[2]]
pastry_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = pastry_super_PL)[[2]]


readymeal_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = readymeal_hyper_PL)[[2]]
readymeal_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = readymeal_super_PL)[[2]]
readymeal_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = readymeal_conve_PL)[[2]]

rice_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = rice_hyper_PL)[[2]]
rice_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = rice_super_PL)[[2]]


seasoning_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = seasoning_hyper_PL)[[2]]
seasoning_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = seasoning_super_PL)[[2]]


softdrink_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = softdrink_hyper_PL)[[2]]
softdrink_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = softdrink_super_PL)[[2]]


yoghurt_hyper_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = yoghurt_hyper_PL)[[2]]
yoghurt_super_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = yoghurt_super_PL)[[2]]
yoghurt_conve_PL_est_discount_plot <- discountnonlinearest_PL_nothreshold(df = yoghurt_conve_PL)[[2]]
```

#Estimate Nonlinear Model ONLY loglevel
```{r eval=FALSE, include=FALSE}
#Extract Estimate result
baking_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_hyper_PL)[[1]]
baking_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_super_PL)[[1]]
baking_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_conve_PL)[[1]]

biscuit_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_hyper_PL)[[1]]
biscuit_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_super_PL)[[1]]


butter_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_hyper_PL)[[1]]
butter_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_super_PL)[[1]]
butter_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_conve_PL)[[1]]

bottledwater_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_hyper_PL)[[1]]
bottledwater_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_super_PL)[[1]]


cereals_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_hyper_PL)[[1]]
cereals_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_super_PL)[[1]]


chips_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_hyper_PL)[[1]]
chips_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_super_PL)[[1]]
chips_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_conve_PL)[[1]]

coffee_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_hyper_PL)[[1]]
coffee_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_super_PL)[[1]]


cookie_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_hyper_PL)[[1]]
cookie_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_super_PL)[[1]]


cream_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_hyper_PL)[[1]]
cream_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_super_PL)[[1]]
cream_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_conve_PL)[[1]]

frozenpizz_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = frozenpizz_hyper_PL)[[1]]

juice_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_hyper_PL)[[1]]
juice_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_super_PL)[[1]]


icecream_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_hyper_PL)[[1]]
icecream_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_super_PL)[[1]]

jam_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_hyper_PL)[[1]]
jam_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_super_PL)[[1]]
jam_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_conve_PL)[[1]]

lactosefree_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_hyper_PL)[[1]]
lactosefree_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_super_PL)[[1]]
lactosefree_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_conve_PL)[[1]]

pastry_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_hyper_PL)[[1]]
pastry_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_super_PL)[[1]]


readymeal_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_hyper_PL)[[1]]
readymeal_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_super_PL)[[1]]
readymeal_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_conve_PL)[[1]]

rice_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_hyper_PL)[[1]]
rice_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_super_PL)[[1]]


seasoning_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_hyper_PL)[[1]]
seasoning_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_super_PL)[[1]]


softdrink_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_hyper_PL)[[1]]
softdrink_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_super_PL)[[1]]


yoghurt_hyper_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_hyper_PL)[[1]]
yoghurt_super_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_super_PL)[[1]]
yoghurt_conve_PL_est <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_conve_PL)[[1]]


#Extract plots
baking_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_hyper_PL)[[2]]
baking_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_super_PL)[[2]]
baking_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_conve_PL)[[2]]

biscuit_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_hyper_PL)[[2]]
biscuit_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_super_PL)[[2]]


butter_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_hyper_PL)[[2]]
butter_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_super_PL)[[2]]
butter_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_conve_PL)[[2]]

bottledwater_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_hyper_PL)[[2]]
bottledwater_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_super_PL)[[2]]


cereals_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_hyper_PL)[[2]]
cereals_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_super_PL)[[2]]


chips_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_hyper_PL)[[2]]
chips_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_super_PL)[[2]]
chips_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_conve_PL)[[2]]

coffee_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_hyper_PL)[[2]]
coffee_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_super_PL)[[2]]


cookie_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_hyper_PL)[[2]]
cookie_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_super_PL)[[2]]


cream_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_hyper_PL)[[2]]
cream_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_super_PL)[[2]]
cream_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_conve_PL)[[2]]

frozenpizz_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = frozenpizz_hyper_PL)[[2]]

juice_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_hyper_PL)[[2]]
juice_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_super_PL)[[2]]


icecream_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_hyper_PL)[[2]]
icecream_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_super_PL)[[2]]

jam_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_hyper_PL)[[2]]
jam_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_super_PL)[[2]]
jam_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_conve_PL)[[2]]

lactosefree_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_hyper_PL)[[2]]
lactosefree_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_super_PL)[[2]]
lactosefree_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_conve_PL)[[2]]

pastry_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_hyper_PL)[[2]]
pastry_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_super_PL)[[2]]


readymeal_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_hyper_PL)[[2]]
readymeal_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_super_PL)[[2]]
readymeal_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_conve_PL)[[2]]

rice_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_hyper_PL)[[2]]
rice_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_super_PL)[[2]]


seasoning_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_hyper_PL)[[2]]
seasoning_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_super_PL)[[2]]


softdrink_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_hyper_PL)[[2]]
softdrink_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_super_PL)[[2]]


yoghurt_hyper_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_hyper_PL)[[2]]
yoghurt_super_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_super_PL)[[2]]
yoghurt_conve_PL_est_plot <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_conve_PL)[[2]]

```

#Estimate Nonlinear Model ONLY loglevel
```{r eval=FALSE, include=FALSE}

butter_hyper_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = butter_hyper_PL)[[2]]
butter_super_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = butter_super_PL)[[2]]
butter_conve_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = butter_conve_PL)[[2]]

bottledwater_hyper_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = bottledwater_hyper_PL)[[2]]
bottledwater_super_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = bottledwater_super_PL)[[2]]


chips_hyper_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = chips_hyper_PL)[[2]]
chips_super_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = chips_super_PL)[[2]]
chips_conve_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = chips_conve_PL)[[2]]

readymeal_hyper_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = readymeal_hyper_PL)[[2]]
readymeal_super_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = readymeal_super_PL)[[2]]
readymeal_conve_PL_est_threshold_plot <- discountnonlinearest_PL_onlyfinalprice_loss(df = readymeal_conve_PL)[[2]]


Combined_result_onlyprice_threshold_plot<- rbind( 
                          butter_hyper_PL_est_threshold_plot,butter_super_PL_est_threshold_plot,butter_conve_PL_est_threshold_plot,
                          bottledwater_hyper_PL_est_threshold_plot,bottledwater_super_PL_est_threshold_plot,
                          chips_hyper_PL_est_threshold_plot,chips_super_PL_est_threshold_plot,chips_conve_PL_est_threshold_plot,
                          readymeal_hyper_PL_est_threshold_plot,readymeal_super_PL_est_threshold_plot,readymeal_conve_PL_est_threshold_plot)
Combined_result_onlyprice_threshold_plot$dlogprice_values <- as.numeric(Combined_result_onlyprice_threshold_plot$dlogprice_values)
Combined_result_onlyprice_threshold_plot$NLPE_values_finalprice <- as.numeric(Combined_result_onlyprice_threshold_plot$NLPE_values_finalprice)
Combined_result_onlyprice_threshold_plot$category <- as.factor(Combined_result_onlyprice_threshold_plot$category)
Combined_result_onlyprice_threshold_plot$format <- as.factor(Combined_result_onlyprice_threshold_plot$format)
```

```{r}
Combined_result_discount <- rbind(baking_hyper_PL_est_discount,baking_super_PL_est_discount,baking_conve_PL_est_discount, 
                          biscuit_hyper_PL_est_discount,biscuit_super_PL_est_discount,
                          butter_hyper_PL_est_discount,butter_super_PL_est_discount,butter_conve_PL_est_discount,
                          bottledwater_hyper_PL_est_discount,bottledwater_super_PL_est_discount,
                          cereals_hyper_PL_est_discount,cereals_super_PL_est_discount,
                          chips_hyper_PL_est_discount,chips_super_PL_est_discount,chips_conve_PL_est_discount,
                          coffee_hyper_PL_est_discount,coffee_super_PL_est_discount,
                          cookie_hyper_PL_est_discount,cookie_super_PL_est_discount,
                          cream_hyper_PL_est_discount,cream_super_PL_est_discount,cream_conve_PL_est_discount,
                          frozenpizz_hyper_PL_est_discount,
                          juice_hyper_PL_est_discount,juice_super_PL_est_discount,
                          icecream_hyper_PL_est_discount,icecream_super_PL_est_discount,
                          jam_hyper_PL_est_discount,jam_super_PL_est_discount,jam_conve_PL_est_discount,
                          lactosefree_hyper_PL_est_discount,lactosefree_super_PL_est_discount,lactosefree_conve_PL_est_discount,
                          pastry_hyper_PL_est_discount,pastry_super_PL_est_discount,
                          readymeal_hyper_PL_est_discount,readymeal_super_PL_est_discount,readymeal_conve_PL_est_discount,
                          rice_hyper_PL_est_discount,rice_super_PL_est_discount,
                          seasoning_hyper_PL_est_discount,seasoning_super_PL_est_discount,
                          softdrink_hyper_PL_est_discount,softdrink_super_PL_est_discount,
                          yoghurt_hyper_PL_est_discount,yoghurt_super_PL_est_discount,yoghurt_conve_PL_est_discount)


Combined_result_discount_plot <- rbind(
                          butter_hyper_PL_est_discount_plot,butter_super_PL_est_discount_plot,butter_conve_PL_est_discount_plot,
                          bottledwater_hyper_PL_est_discount_plot,bottledwater_super_PL_est_discount_plot,
                          chips_hyper_PL_est_discount_plot,chips_super_PL_est_discount_plot,chips_conve_PL_est_discount_plot,
                          readymeal_hyper_PL_est_discount_plot,readymeal_super_PL_est_discount_plot,readymeal_conve_PL_est_discount_plot)
Combined_result_discount_plot$dlogprice_values <- as.numeric(Combined_result_discount_plot$dlogprice_values)
Combined_result_discount_plot$NLPE_values_pricebefore <- as.numeric(Combined_result_discount_plot$NLPE_values_pricebefore)
Combined_result_discount_plot$NLPE_values_discount <- as.numeric(Combined_result_discount_plot$NLPE_values_discount)
Combined_result_discount_plot$category <- as.factor(Combined_result_discount_plot$category)
Combined_result_discount_plot$format <- as.factor(Combined_result_discount_plot$format)

Combined_result_onlyprice<- rbind(baking_hyper_PL_est,baking_super_PL_est,baking_conve_PL_est, 
                          biscuit_hyper_PL_est,biscuit_super_PL_est,
                          butter_hyper_PL_est,butter_super_PL_est,butter_conve_PL_est,
                          bottledwater_hyper_PL_est,bottledwater_super_PL_est,
                          cereals_hyper_PL_est,cereals_super_PL_est,
                          chips_hyper_PL_est,chips_super_PL_est,chips_conve_PL_est,
                          coffee_hyper_PL_est,coffee_super_PL_est,
                          cookie_hyper_PL_est,cookie_super_PL_est,
                          cream_hyper_PL_est,cream_super_PL_est,cream_conve_PL_est,
                          frozenpizz_hyper_PL_est,
                          juice_hyper_PL_est,juice_super_PL_est,
                          icecream_hyper_PL_est,icecream_super_PL_est,
                          jam_hyper_PL_est,jam_super_PL_est,jam_conve_PL_est,
                          lactosefree_hyper_PL_est,lactosefree_super_PL_est,lactosefree_conve_PL_est,
                          pastry_hyper_PL_est,pastry_super_PL_est,
                          readymeal_hyper_PL_est,readymeal_super_PL_est,readymeal_conve_PL_est,
                          rice_hyper_PL_est,rice_super_PL_est,
                          seasoning_hyper_PL_est,seasoning_super_PL_est,
                          softdrink_hyper_PL_est,softdrink_super_PL_est,
                          yoghurt_hyper_PL_est,yoghurt_super_PL_est,yoghurt_conve_PL_est)

Combined_result_onlyprice_plot<- rbind( 
                          butter_hyper_PL_est_plot,butter_super_PL_est_plot,butter_conve_PL_est_plot,
                          bottledwater_hyper_PL_est_plot,bottledwater_super_PL_est_plot,
                          chips_hyper_PL_est_plot,chips_super_PL_est_plot,chips_conve_PL_est_plot,
                          readymeal_hyper_PL_est_plot,readymeal_super_PL_est_plot,readymeal_conve_PL_est_plot)
Combined_result_onlyprice_plot$dlogprice_values <- as.numeric(Combined_result_onlyprice_plot$dlogprice_values)
Combined_result_onlyprice_plot$NLPE_values_finalprice <- as.numeric(Combined_result_onlyprice_plot$NLPE_values_finalprice)
Combined_result_onlyprice_plot$category <- as.factor(Combined_result_onlyprice_plot$category)
Combined_result_onlyprice_plot$format <- as.factor(Combined_result_onlyprice_plot$format)
```

```{r}

ggplot(Combined_result_onlyprice_plot, aes(x = dlogprice_values, y = NLPE_values_finalprice, color = category, linetype = format)) +
  geom_line() +
  labs(title = "FINAL Price Elasticity",
       x = "dlogfinalprice",
       y = "NL_Price")

ggplot(Combined_result_discount_plot, aes(x = dlogprice_values, y = NLPE_values_pricebefore, color = category, linetype = format)) +
  geom_line() +
  labs(title = "Price BEFORE Elasticity",
       x = "dlogpricebefore",
       y = "NL_Pricebefore")

ggplot(Combined_result_discount_plot, aes(x = dlogprice_values, y = NLPE_values_discount, color = category, linetype = format)) +
  geom_line() +
  labs(title = "DISCOUNT Elasticity",
       x = "dlogdiscount",
       y = "NL_Discount")

```

