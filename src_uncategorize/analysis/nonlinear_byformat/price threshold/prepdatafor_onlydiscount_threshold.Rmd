---
title: "Managebrandandcategorydata for (aggregate model) discount loss threshold"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_discount_threshold.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```


```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df_offline[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```


#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar <- function(df,format,category){
  df <- df[df$category == category & df$format == format,]
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalcampaign=.N,totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand_PLNB,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand_PLNB","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign),totalcampaign=sum(totalcampaign)), .(vecka,brand_PLNB,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info

distinctbrandcomplete <- unique(df$brand_PLNB)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 20 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand_PLNB != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand_PLNB == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgcompfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgcomppricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgcompdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dlognondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

#create copula
make_copula <- function(x) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-.0000001), qnorm(ecdf(x)(x))))}
#This functions transforms a variable (condition: non-normally distributed) to its copula-correction term which can be entered in model estimation. See Park and Gupta (2012, Marketing Science)
df_bybrand$cop_logavgpricebefore <- make_copula(log((df_bybrand$avgpricebefore)))
df_bybrand$cop_lognondepth<- make_copula(log(df_bybrand$nondepth))

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))

#convert format back
df_bybrand$format <- format
df_bybrand$category <- category


return(df_bybrand)
}

```



#Prepare data for estimating aggregate
```{r}
baking_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Baking ingredients")
baking_super_PL <- genrelevantvar(df,format = "supermarket",category ="Baking ingredients")
baking_conve_PL <- genrelevantvar(df,format = "convenience",category ="Baking ingredients")

biscuit_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Biscuits")
biscuit_super_PL <- genrelevantvar(df,format = "supermarket",category ="Biscuits")
# biscuit_conve_PL <- genrelevantvar(df,format = "convenience",category ="Biscuits") #there are several weeks ICA is not sold in convenient store

butter_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Butter")
butter_super_PL <- genrelevantvar(df,format = "supermarket",category ="Butter")
butter_conve_PL <- genrelevantvar(df,format = "convenience",category ="Butter")

bottledwater_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Bottled water")
bottledwater_super_PL <- genrelevantvar(df,format = "supermarket",category ="Bottled water")
# bottledwater_conve_PL <- genrelevantvar(df,format = "convenience",category ="Bottled water") #there is one week ICA is not sold in convenient store

cereals_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cereals")
cereals_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cereals")
# cereals_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cereals") #there is one week ICA is not sold in convenient store

chips_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Chips & Salty snacks")
chips_super_PL <- genrelevantvar(df,format = "supermarket",category ="Chips & Salty snacks")
chips_conve_PL <- genrelevantvar(df,format = "convenience",category ="Chips & Salty snacks")

coffee_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Coffee")
coffee_super_PL <- genrelevantvar(df,format = "supermarket",category ="Coffee")
#coffee_conve_PL <- genrelevantvar(df,format = "convenience",category ="Coffee") #there are several weeks ICA is not sold in convenient store

cookie_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cookies")
cookie_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cookies")
# cookie_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cookies") #there is one week ICA is not sold in convenient store

cream_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Cream")
cream_super_PL <- genrelevantvar(df,format = "supermarket",category ="Cream")
cream_conve_PL <- genrelevantvar(df,format = "convenience",category ="Cream")

frozenpizz_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Frozen Pizza Snacks")
# frozenpizz_super_PL <- genrelevantvar(df,format = "supermarket",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store
# frozenpizz_conve_PL <- genrelevantvar(df,format = "convenience",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store

juice_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Fruit Juice")
juice_super_PL <- genrelevantvar(df,format = "supermarket",category ="Fruit Juice")
# juice_conve_PL <- genrelevantvar(df,format = "convenience",category ="Fruit Juice") #there is one week ICA is not sold in convenient

icecream_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Ice cream")
icecream_super_PL <- genrelevantvar(df,format = "supermarket",category ="Ice cream")
# icecream_conve_PL <- genrelevantvar(df,format = "convenience",category ="Ice cream") #there are several weeks ICA is not sold in convenient store

jam_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Jam")
jam_super_PL <- genrelevantvar(df,format = "supermarket",category ="Jam")
jam_conve_PL <- genrelevantvar(df,format = "convenience",category ="Jam")

lactosefree_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="LactoseFree")
lactosefree_super_PL <- genrelevantvar(df,format = "supermarket",category ="LactoseFree")
lactosefree_conve_PL <- genrelevantvar(df,format = "convenience",category ="LactoseFree")

pastry_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Pastry")
pastry_super_PL <- genrelevantvar(df,format = "supermarket",category ="Pastry")
#pastry_conve_PL <- genrelevantvar(df,format = "convenience",category ="Pastry") #there are several weeks ICA is not sold in convenient store

readymeal_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Ready-made meals")
readymeal_super_PL <- genrelevantvar(df,format = "supermarket",category ="Ready-made meals")
readymeal_conve_PL <- genrelevantvar(df,format = "convenience",category ="Ready-made meals")

rice_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Rice")
rice_super_PL <- genrelevantvar(df,format = "supermarket",category ="Rice")
#rice_conve_PL <- genrelevantvar(df,format = "convenience",category ="Rice") #there are several weeks ICA is not sold in convenient store

seasoning_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Seasoning")
seasoning_super_PL <- genrelevantvar(df,format = "supermarket",category ="Seasoning")
#seasoning_conve_PL <- genrelevantvar(df,format = "convenience",category ="Seasoning") #there is one week ICA is not sold in convenient

softdrink_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Soft drinks")
softdrink_super_PL <- genrelevantvar(df,format = "supermarket",category ="Soft drinks")
#softdrink_conve_PL <- genrelevantvar(df,format = "convenience",category ="Soft drinks") #there is one week ICA is not sold in convenient

yoghurt_hyper_PL <- genrelevantvar(df,format = "hypermarket",category ="Yogurt")
yoghurt_super_PL <- genrelevantvar(df,format = "supermarket",category ="Yogurt")
yoghurt_conve_PL <- genrelevantvar(df,format = "convenience",category ="Yogurt")
```

