---
title: "Managebrandandcategorydata"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand
library(car) #function for testing coefficient equivalence
library(lmtest) #function for testing nonlinearity
require(nnet) #for multinomial regression
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_butikid.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```

```{r rename all brand, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
            #bakingingredient
              "Dr.OETKER"="Dr.Oetker",
              "KUNG MARKATTA" = "Kung markatta",
              "ODENSE" = "Odense",
            #bathproducts
              "DEPEND"="Depend",
              "DETTOL" = "Dettol",
              "Dove Men Care" = "Dove",
              "HAWAIIAN TROPIC" = "Hawaiian Tropic",
              "NEEDS" = "Needs",
              "NIVEA" = "Nivea",
              "Nivea Body" = "Nivea",
              "Nivea Face" = "Nivea",
              "NIVEA FACE" = "Nivea",
              "Nivea Lip" = "Nivea",
              "Nivea Men" = "Nivea",
              "Nivea Shower" = "Nivea",
              "OLAY" = "Olay",
              "PALMETTEN" = "Palmetten",
              "PALMOLIVE" = "Palmolive",
            #Bottled water
              "BONAQUA SILVER"="bonaqua silver",
            #Canned Soup
              "FELIX"="felix",
              "HEINZ" = "Heinz",
            #Canned Vegg
              "FONTANA"="Fontana",
            #Cereals
              "HONEY MONSTER"="Honey Monster",
              "KUNG MARKATTA"="Kung markatta",
              "Paulun"="Pauluns",
              "QUAKER"="Quaker",
              "RenÃ©e Voltaire"="ReneeVoltaire", "RENÃ‰E VOLTAIRE"="ReneeVoltaire",
            #Chips
              "CRISPY"="Crispy",
              "ESTRELLA" = "Estrella",
              "GÃ…RDSCHIPS" = "GÃ¥rdschips",
              "OLW" = "Olw",
              "PRIMA" = "Prima",
              "ROOTFRUIT" = "Rootfruit",
            #Chocolate
              "Droste"="DROSTE",
              "FAZER" = "Fazer",
              "LINDT" = "Lindt",
              "MALTESERS" = "Maltesers",
              "MARABOU" = "Marabou",
              "PLAMIL" = "Plamil",
              "QUICK MILK" = "Quick Milk",
              "RITTER SPORT" = "Ritter Sport",
            #cleaningProducts
              "AIR WICK"="Air Wick",
              "CILLIT BANG" = "Cillit Bang",
              "TOMIK" = "Tomik",
            #Coffees
              "DOLCE GUSTO"="Dolce Gusto",
              "LÃ–FBERGS" = "LÃ¶fbergs",
              "LAVAZZA" = "Lavazza",
            #cookies
              "MC VITIES"="Mc Vities",
              "MARYLAND" = "Maryland",
            #cream
              "ARLA"="Arla",
              "LINDAHLS" = "Lindahls",
            #Dishwasher & washing up
              "FINISH"="Finish",
            #FrozenPizza
              "BILLYS"="Billys",
            #Fruitjuice
              "FONTANA"="Fontana",
              "BRAVO" = "Bravo",
              "Froosh" = "Froosh",
              "GLOCKENGOLD" = "glockengold",
              "GLOCKEN GOLD" = "glockengold",
              "KIVIKS" = "Kiviks",
              "Loviseberg" = "LOVISEBERG",
              "PURE" = "Pure",
              "RYNKEBY" = "Runkeby",
            #Icecream
              "Ã–STERHAGENGLASS"="Ã–STERHAGEN",
              "ALVESTAGLASS" = "ALVESTA GLASS",
              "BEN & JERRYS" = "Ben & Jerrys",
              "CORNETTO" = "Cornetto",
              "GB GLACE" = "GB Glace",
              "HÃ„AGEN DAZS" = "HÃ¤agen Dazs",
              "HÃ„AGEN-DAZS" = "HÃ¤agen Dazs",
              "KLINGS" = "KLING",
              "KLINGS GLASS" = "KLING", 
              "SIA" = "SIA Glass",
              "TRIUMF GLASS" = "Triumf Glass",
              "Yollibox" = "YOLLIBOX",
            #Jam
              "SKIPPY"="Skippy",
            #Laundry
              "SOFTLAN"="Softlan",
            #ReadyMadeMeal
              "BIOFOOD"="Biofood",
              "MONINI" = "Monini",
            #Softdrinks
              "COCA-COLA"="Coca-Cola",
              "COCA COLA"="Coca-Cola",
              "Coca-Cola life"="Coca-Cola",
              "FANTA" = "Fanta",
              "Fanta Zero" = "Fanta",
              "MOUNTAIN DEW" = "Mountain Dew",
              "PEPSI" = "Pepsi",
              "SAN PELLEGRINO"="San Pellegrino",
              "Sodastream EXTERN" = "Sodastream",
              "Sprite Zero"="Sprite",
              "Three Hearts"="THREE HEARTS",
            #Sweetandcandies
              "BUBS"="Bubs",
              "Carletti"="CARLETTI",
              "COTE D OR"="Cote d Or",
              "EKORRENS" = "Ekorrens",
              "FAZER" = "Fazer",
              "HARIBO" = "Haribo",
              "KONFEKTA" = "Konfekta",
              "KOUVOLAN"="Kouvolan",
              "LINDT" = "Lindt",
              "MARABOU"="Marabou",
              "MARS"="Mars",
              "NESTLE" = "Nestle",
              "SNICKERS" = "Snickers",
              "TWIX" = "Twix",
              "TOMS" = "Toms",
            #Tobacco
              "BIC"="Bic",
              "BLEND"="Blend",
              "CAMEL"="Camel",
              "CRICKET" = "Cricket",
              "GÃ–TEBORGS" = "GÃ¶teborgs",
              "GÃ¶teborgs" = "Gateborgs",
              "GENERAL" = "General",
              "JOHN SILVER" = "John Silver",
              "KALIBER"="Kaliber",
              "LEVEL" = "Level",
              "MARLBORO"="Marlboro",
              "PRINCE"="Prince",
              "RIGHT" = "Right",
              "WINSTON" = "Winston",
            #Toiletries
              "EKULF"="Ekulf",
              "JORDAN"="Jordan",
              "LISTERINE"="Listerine",
              "PEPSODENT" = "Pepsodent",
              "SENSODYNE" = "Sensodyne",
            #yogurt
              "ARLA KO"="Arla Ko",
              "FjÃ¤llyoghurt"="FjÃ¤llfil"
              ))
```



```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df_offline[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```

#Function of filtering brand

```{r define function for filtering brand with complete (153) observations}
brandfiltering_format <- function(df,format,category,nweek){
  df_format_category <- df[df$category == category & df$format == format,]
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand=droplevels(brand))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand)
message(paste("# of remaining brands for",category,"in",format,":", dim(brandcompleteweek)[1],"(from",length(unique(df_format_category$brand)),")"))

df_format_category_complete <- df_format_category[df_format_category$brand %in% brandcompleteweek$brand, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand=droplevels(brand))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]
message(paste("% of obs. maintain:", (nobsafterdrop/nobsbeforedrop)*100))

return(df_format_category_complete)
}
```

#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar <- function(df){
  
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign)), .(vecka,brand,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info


distinctbrandcomplete <- unique(df$brand)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 19 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dlognondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))


return(df_bybrand)
}

```



#Function of testing nonlinearity

This function returns p-value for likelihood ratio test when non-linearity term (or quadratic term) is added and conclusion whether which fuction should be performed. 


However, we still need to create another function that skip some lm in case of all brands have significant discount parameters and vice versa (LATER).

```{r}

test_nonlinearity_onlyfinalprice <- function(aggregate_df){
  
  distinctbrand_finalprice <- unique(aggregate_df$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  
   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 8 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){  
  
lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])


lm_finalprice_priceprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1)+ trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])

lm_finalprice_compgap <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgfinalprice*I(dlogavgcompfinalprice^2) + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1)+ trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])

test_price1 <-lrtest(lm_finalprice, lm_finalprice_priceprice)
test_price2 <-lrtest(lm_finalprice, lm_finalprice_compgap)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_price1$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_price2$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = summary(lm_finalprice)$coefficients[3,1]
df_finalprice_lr[i,5] = summary(lm_finalprice)$coefficients[3,2]
#df_finalprice_lr[i,6] = round(summary(lm_finalprice)$coefficients[10,1]/summary(lm_finalprice)$coefficients[8,1],4)
df_finalprice_lr[i,6] = round(summary(lm_finalprice)$r.squared,4)
#df_finalprice_lr[i,8] = summary(lm_finalprice)$coefficients[4,1]
#df_finalprice_lr[i,9] = summary(lm_finalprice)$coefficients[4,2]
df_finalprice_lr[i,7] = round(summary(lm_finalprice_priceprice)$r.squared,4)
df_finalprice_lr[i,8] = round(summary(lm_finalprice_compgap)$r.squared,4)
}  
  
colnames(df_finalprice_lr) <- c('brand','p-value-LRhist','p-value-LRcomp','Coef Price','Sd Price','RsqLinear','RsqHist','RsqComp')

 #colnames(df_finalprice_lr) <- c('brand','p-value-pricehist','p-value-pricecom','Coef Price','Sd Price','Coef Long','RsqLinearmod','coefprice2','sdprice2')


return(df_finalprice_lr)
  
}
```

#For Second stage analysis
  
  Create Store Characteristic (feature ,discount depth, breadth) based on category
  
**Brand level:** 

* (Static) Market Share: Average market share of category of each format across 153 weeks
* Brand Discount Frequency:The number of weeks in which negative price-promotion shocks are at least 5% of the brand’s regular price (Srinivasan et al 2004)
* Brand Discount Breadth: Average Discount Breadth of each brand in each format across 153 weeks
* Brand Discount Depth: Average Discount Dept of each of each brand in each format across 153 weeks
 
Also, we need to calculate brand average sales and discount value to calculate *discount elasticities* later. 
 

```{r create brand level data frame for second-stage analysis, include=FALSE}
  
branddiscountcharacteristic <- function(df,category,nweek){
  
df_category <- df[df$category == category,]

weeklymarketbyweek<-setDT(df_category)[, .(totalformatsales=sum(sales_volume),totalformatLL=uniqueN(produkt_id)), .(vecka,format,category)] #this df will be used for category calculation
weeklymarketsharebybrand<-setDT(df_category)[, .(totalsales=sum(sales_volume)), .(vecka,brand,format,category)] #Should return nbrand x nformat rows
weeklymarketsharemerge <- merge(weeklymarketsharebybrand,weeklymarketbyweek, by=c("vecka","format","category"))
brandmarketshareformat<-setDT(weeklymarketsharemerge)[, .(avgbrandweeksales=mean(totalsales),avgmarketshare=mean(totalsales/totalformatsales)), .(brand,format,category)]

df_bybrand_discount<-df_category[df_category$totaldiscount>0,] 
branddiscountdepth<-setDT(df_bybrand_discount)[, .(avgbranddiscount=mean(totaldiscount),avgbranddiscountdepth=mean(totaldiscount/spendingbeforedisc)), .(brand,format,category)] #Should return nbrand x nformat rows

LLTotal<-setDT(df_category)[, .(LLTotal=uniqueN(produkt_id)), .(vecka,brand,format,category)] #this df will be used for category calculation
LLdiscount<-setDT(df_bybrand_discount)[, .(LLdiscount=uniqueN(produkt_id)), .(vecka,brand,format,category)] 
LLdiscountmerge<-merge(LLdiscount,LLTotal, by=c("vecka","format","brand","category")) 
LLdiscountmerge$discountbreadth <- LLdiscountmerge$LLdiscount/LLdiscountmerge$LL 
branddiscountbreadth<-setDT(LLdiscountmerge)[, .(avgbranddiscountbreath=mean(LLdiscount/LLTotal)), .(brand,format,category)] 

df_complete_highdiscount<-df_category[(df_category$totaldiscount/df_category$spendingbeforedisc>0.05),]
counthighdiscount<-setDT(df_complete_highdiscount)[, .(SKUdiscount=uniqueN(produkt_id)), .(vecka,brand,format,category)]
counthighdiscount$weekdisc<-1
branddiscountfrequency<-setDT(counthighdiscount)[, .(frequency=sum(weekdisc)), .(brand,format,category)] 
branddiscountfrequency$freqratio <- branddiscountfrequency$frequency/nweek

brandcharacteristic_1 <-merge(brandmarketshareformat,branddiscountdepth, by=c("format","brand","category"))
brandcharacteristic_2 <-merge(brandcharacteristic_1,branddiscountbreadth, by=c("format","brand","category"))
brandcharacteristic <-merge(brandcharacteristic_2,branddiscountfrequency, by=c("format","brand","category"))

return(brandcharacteristic)
}

#yoghurtdiscount <- branddiscountcharacteristic(df,category ="Yogurt",nweek=153)
```
 
**Create Category Characteristics (Penetration, Frequency, Storable, Impulse, Store Brand)**

* Storability & Impulsiveness
* Category Discount Breath: Average Discount Breadth of each format across 153 weeks (weeks that got promoted)
* Category Discount Depth: Average Discount Depth of each format across 153 weeks
* Competitive Structure: The variance in average shares across brands
* Category Deal Dependency: Average weekly proportion of category purchased on deal.

```{r create category data frame for second-stage analysis, include=FALSE}

formatcharacteristic <- function(df,category){

df_category <- df[df$category == category,]

#create price variation
weeklysalesbybrand<-setDT(df_category)[, .(totalsales=sum(sales_volume)), .(vecka,brand,format,category)] 
df_weightcalc <- merge(df_category,weeklysalesbybrand, by=c("vecka","brand","format","category"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgfinalprice <- (df_weightcalc$finalspending*df_weightcalc$wp)/df_weightcalc$sales_volume

df_brandprice <- setDT(df_weightcalc)[, .(avgfinalpricesku=sum(avgfinalprice)), .(vecka,brand,format,category)]
df_pricesd <- setDT(df_brandprice)[, .(sdpriceacrossbrand=sd(avgfinalpricesku)), .(vecka,format,category)]
df_avgpricesd <- setDT(df_pricesd)[, .(avgsdpriceacrossbrand=mean(sdpriceacrossbrand)), .(format,category)]

# SKU
skuofferperweek <- setDT(df_category)[, .(totalSKU=uniqueN(produkt_id)), .(vecka,format,category)]
avgskuofferperweek <- setDT(skuofferperweek)[, .(avgSKUoffer=mean(totalSKU)), .(format,category)]

# marketshare
weeklymarketbyweek<-setDT(df_category)[, .(totalformatsales=sum(sales_volume),totalformatLL=uniqueN(produkt_id)), .(vecka,format,category)] #this df will be used for category calculation
weeklymarketsharebybrand<-setDT(df_category)[, .(totalsales=sum(sales_volume)), .(vecka,brand,format,category)] #Should return nbrand x nformat rows
weeklymarketsharemerge <- merge(weeklymarketsharebybrand,weeklymarketbyweek, by=c("vecka","format","category"))
brandmarketshareformat<-setDT(weeklymarketsharemerge)[, .(avgbrandweeksales=mean(totalsales),avgmarketshare=mean(totalsales/totalformatsales)), .(brand,format,category)]

df_dfmarketshare <- setDT(brandmarketshareformat)[, .(sdmarketshare=sd(avgmarketshare)), .(format,category)]


#dealproportion
df_category_discount<-df_category[df_category$totaldiscount>0,] 
categorydeal <- setDT(df_category_discount)[,.(totaldiscvolume=sum(sales_volume)), .(vecka,format,category)]
categorytotal <- setDT(df_category)[,.(totalvolume=sum(sales_volume)), .(vecka,format,category)]
categoryproportion<-left_join(categorytotal,categorydeal,by=c("format","vecka","category")) #merge will leave the week without deal
categoryproportion$totaldiscvolume[is.na(categoryproportion$totaldiscvolume)] <- 0
categoryproportionformat <- setDT(categoryproportion)[,.(averagedealprop=mean(totaldiscvolume/totalvolume)), .(format,category)]


categorycharacteristic_1 <-merge(avgskuofferperweek,df_avgpricesd, by=c("format","category"))
categorycharacteristic_2 <-merge(categorycharacteristic_1,categoryproportionformat, by=c("format","category"))
categorycharacteristic <-merge(categorycharacteristic_2,df_dfmarketshare, by=c("format","category"))

return(categorycharacteristic)
}
```


#Empirical Test for nonlinearity
```{r Bottled Water}
#Get seperate dataframe
bottledwater_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Bottled water",nweek=153)
bottledwater_super <- brandfiltering_format(df,format = "supermarket",category ="Bottled water",nweek=153)
bottledwater_conve <- brandfiltering_format(df,format = "convenience",category ="Bottled water",nweek=153)

#Create aggregate dataframe
df_bottledwater_hyper <- genrelevantvar(df=bottledwater_hyper)
df_bottledwater_super <- genrelevantvar(df=bottledwater_super)
df_bottledwater_conve <- genrelevantvar(df=bottledwater_conve)

#test nonlinearity
nonlinear_test_bottledwater_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_hyper)
nonlinear_test_bottledwater_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_super)
nonlinear_test_bottledwater_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_conve)


nonlinear_test_bottledwater_hyper$format <- "hypermarket"
nonlinear_test_bottledwater_super$format <- "supermarket"
nonlinear_test_bottledwater_conve$format <- "convenience"
nonlinearity_bottledwater_result <- rbind(nonlinear_test_bottledwater_hyper,nonlinear_test_bottledwater_super,nonlinear_test_bottledwater_conve)
nonlinearity_bottledwater_result$category <- "Bottled water"

#add info for second stage
bottledwaterbranddiscount <- branddiscountcharacteristic(df,category ="Bottled water",nweek=153)
bottledwaterstorediscount <- formatcharacteristic(df,category ="Bottled water")

#mergeinfo
bottledwater_result <- merge(nonlinearity_bottledwater_result,bottledwaterbranddiscount, by=c("brand","format","category"))
bottledwater_result <- merge(bottledwater_result,bottledwaterstorediscount, by=c("format","category"))
```

```{r Butter}
#Get seperate dataframe
butter_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Butter",nweek=153)
butter_super <- brandfiltering_format(df,format = "supermarket",category ="Butter",nweek=153)
butter_conve <- brandfiltering_format(df,format = "convenience",category ="Butter",nweek=153)

#Create aggregate dataframe
df_butter_hyper <- genrelevantvar(df=butter_hyper)
df_butter_super <- genrelevantvar(df=butter_super)
df_butter_conve <- genrelevantvar(df=butter_conve)

#test discount coefficient
nonlinear_test_butter_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_butter_hyper)
nonlinear_test_butter_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_butter_super)
nonlinear_test_butter_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_butter_conve)


#conclude nonlinearitytest
nonlinear_test_butter_hyper$format <- "hypermarket"
nonlinear_test_butter_super$format <- "supermarket"
nonlinear_test_butter_conve$format <- "convenience"
nonlinearity_butter_result <- rbind(nonlinear_test_butter_hyper,nonlinear_test_butter_super,nonlinear_test_butter_conve)
nonlinearity_butter_result$category <- "Butter"

#add info for second stage
butterbranddiscount <- branddiscountcharacteristic(df,category ="Butter",nweek=153)
butterstorediscount <- formatcharacteristic(df,category ="Butter")

#mergeinfo
butter_result <- merge(nonlinearity_butter_result,butterbranddiscount, by=c("brand","format","category"))
butter_result <- merge(butter_result,butterstorediscount, by=c("format","category"))
```

```{r Chips}
#Get seperate dataframe
chips_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153)
chips_super <- brandfiltering_format(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153)
chips_conve <- brandfiltering_format(df,format = "convenience",category ="Chips & Salty snacks",nweek=153)

#Create aggregate dataframe
df_chips_hyper <- genrelevantvar(df=chips_hyper)
df_chips_super <- genrelevantvar(df=chips_super)
df_chips_conve <- genrelevantvar(df=chips_conve)

#test discount coefficient
nonlinear_test_chips_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_chips_hyper)
nonlinear_test_chips_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_chips_super)
nonlinear_test_chips_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_chips_conve)

#conclude nonlinearitytest
nonlinear_test_chips_hyper$format <- "hypermarket"
nonlinear_test_chips_super$format <- "supermarket"
nonlinear_test_chips_conve$format <- "convenience"
nonlinearity_chips_result <- rbind(nonlinear_test_chips_hyper,nonlinear_test_chips_super,nonlinear_test_chips_conve)
nonlinearity_chips_result$category <- "Chips & Salty snacks"

#add info for second stage
chipsbranddiscount <- branddiscountcharacteristic(df,category ="Chips & Salty snacks",nweek=153)
chipsstorediscount <- formatcharacteristic(df,category ="Chips & Salty snacks")

#mergeinfo
chips_result <- merge(nonlinearity_chips_result,chipsbranddiscount, by=c("brand","format","category"))
chips_result <- merge(chips_result,chipsstorediscount, by=c("format","category"))
```



```{r Chocolate}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chocolate",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Chocolate",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Chocolate",nweek=153)

#Create aggregate dataframe
df_choco_hyper <- genrelevantvar(df=choco_hyper)
df_choco_super <- genrelevantvar(df=choco_super)
df_choco_conve <- genrelevantvar(df=choco_conve)

#test discount coefficient
nonlinear_test_choco_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_choco_hyper)
nonlinear_test_choco_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_choco_super)
nonlinear_test_choco_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_choco_conve)


#conclude nonlinearitytest
nonlinear_test_choco_hyper$format <- "hypermarket"
nonlinear_test_choco_super$format <- "supermarket"
nonlinear_test_choco_conve$format <- "convenience"
nonlinearity_choco_result <- rbind(nonlinear_test_choco_hyper,nonlinear_test_choco_super,nonlinear_test_choco_conve)
nonlinearity_choco_result$category <- "Chocolate"

#add info for second stage
chocobranddiscount <- branddiscountcharacteristic(df,category ="Chocolate",nweek=153)
chocostorediscount <- formatcharacteristic(df,category ="Chocolate")

#mergeinfo
choco_result <- merge(nonlinearity_choco_result,chocobranddiscount, by=c("brand","format","category"))
choco_result <- merge(choco_result,chocostorediscount, by=c("format","category"))
```

```{r Yoghurt}
#Get seperate dataframe
yoghurt_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Yogurt",nweek=153)
yoghurt_super <- brandfiltering_format(df,format = "supermarket",category ="Yogurt",nweek=153)
yoghurt_conve <- brandfiltering_format(df,format = "convenience",category ="Yogurt",nweek=153)

#We can run for supermarket and hypermarket (Almost for convenience, 74.06%)
#Create aggregate dataframe
df_yoghurt_hyper <- genrelevantvar(df=yoghurt_hyper)
df_yoghurt_super <- genrelevantvar(df=yoghurt_super)
df_yoghurt_conve <- genrelevantvar(df=yoghurt_conve)

#test discount coefficient
nonlinear_test_yoghurt_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_yoghurt_hyper)
nonlinear_test_yoghurt_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_yoghurt_super)
nonlinear_test_yoghurt_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_yoghurt_conve)

#conclude nonlinearitytest
nonlinear_test_yoghurt_hyper$format <- "hypermarket"
nonlinear_test_yoghurt_super$format <- "supermarket"
nonlinear_test_yoghurt_conve$format <- "convenience"
nonlinearity_yoghurt_result <- rbind(nonlinear_test_yoghurt_hyper,nonlinear_test_yoghurt_super,nonlinear_test_yoghurt_conve)

nonlinearity_yoghurt_result$category <- "Yogurt"

#add info for second stage
yoghurtbranddiscount <- branddiscountcharacteristic(df,category ="Yogurt",nweek=153)
yoghurtstorediscount <- formatcharacteristic(df,category ="Yogurt")

#mergeinfo
yogurt_result <- merge(nonlinearity_yoghurt_result,yoghurtbranddiscount, by=c("brand","format","category"))
yogurt_result <- merge(yogurt_result,yoghurtstorediscount, by=c("format","category"))
```

```{r preliminary result}
Prelim_table<- rbind(nonlinearity_bottledwater_result,nonlinearity_butter_result,nonlinearity_chips_result,nonlinearity_choco_result,nonlinearity_yoghurt_result)

#add decision making
Prelim_table$modeldecision <- "linearity"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` < 0.05 & Prelim_table$`p-value-LRcomp` < 0.05] <- "fullmodel"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` < 0.05 & Prelim_table$`p-value-LRcomp` >= 0.05] <- "histgap"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` >= 0.05 & Prelim_table$`p-value-LRcomp` < 0.05] <- "compgap"

#write.csv(Prelim_table,"C:/Users/TA.4621/Desktop/2021/DiscountThreshold/WorkingRepo/src/analysis/nonlinear_byformat/price threshold/prelimnonlinear_221115.csv", row.names = TRUE)

Summary <- setDT(Prelim_table)[, .N, by=.(modeldecision,format,category)]

summary_format <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision,format)]
summary_category <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision,category)]
summary_total <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision)]
```

```{r prelimsecondstage}
Prelim_second_table<- rbind(bottledwater_result,butter_result,chips_result,choco_result,yogurt_result)

#add decision making
Prelim_second_table$modeldecision <- "linearity"
Prelim_second_table$modeldecision[Prelim_second_table$`p-value-pricehist` < 0.05 & Prelim_second_table$`p-value-pricecom` < 0.05] <- "fullmodel"
Prelim_second_table$modeldecision[Prelim_second_table$`p-value-pricehist` < 0.05 & Prelim_second_table$`p-value-pricecom` >= 0.05] <- "histgap"
Prelim_second_table$modeldecision[Prelim_second_table$`p-value-pricehist` >= 0.05 & Prelim_second_table$`p-value-pricecom` < 0.05] <- "compgap"
```


```{r}
#add decision making
Prelim_second_table$linearmodel <- 1
Prelim_second_table$linearmodel[Prelim_second_table$`p-value-pricehist` < 0.05 | Prelim_second_table$`p-value-pricecom` < 0.05] <- 0
```


```{r multinomial regression}
Prelim_second_table$modeldecision <- as.factor(Prelim_second_table$modeldecision)
Prelim_second_table$modeldecision2 <- relevel(Prelim_second_table$modeldecision, ref = "linearity")
test <- multinom(modeldecision2 ~ avgbranddiscountdepth + avgbranddiscountbreath + freqratio + avgSKUoffer + avgsdpriceacrossbrand + averagedealprop + sdmarketshare, data = Prelim_second_table)

summary(test)
z <- summary(test)$coefficients/summary(test)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2

```

```{r binomial}
Prelim_second_table$linearmodel <- as.factor(Prelim_second_table$linearmodel)
Prelim_second_table$linearmodel2 <- relevel(Prelim_second_table$linearmodel, ref = "linearity")
model <- glm(linearmodel ~ avgbranddiscountdepth + avgbranddiscountbreath + freqratio + avgSKUoffer + avgsdpriceacrossbrand + averagedealprop + sdmarketshare,family=binomial(link='logit'),data=Prelim_second_table)

summary(model)

model2 <- glm(linearmodel ~ format*avgbranddiscountdepth + format*avgbranddiscountbreath + format*freqratio ,family=binomial(link='logit'),data=Prelim_second_table)
summary(model2)
```

```{r}
df_linearity <- Prelim_second_table[Prelim_second_table$modeldecision == "linearity",]

fixedSecondStageLS_linear<- lm(`Coef Price` ~ avgbranddiscountdepth + avgbranddiscountbreath + freqratio + avgSKUoffer + avgsdpriceacrossbrand + averagedealprop + sdmarketshare+format, data = df_linearity , weights=(1/`Sd Price`))

df_hist <- Prelim_second_table[Prelim_second_table$modeldecision == "histgap",]
fixedSecondStageLS_histgap<- lm(coefprice2 ~ avgbranddiscountdepth + avgbranddiscountbreath + freqratio + avgSKUoffer + avgsdpriceacrossbrand + averagedealprop + sdmarketshare, data = df_hist , weights=(1/sdprice2))
```

```{r}
unmatchbrand <- c("Flora","LÃ¤tta","Valio","ICA Basic","LantChips","Pringles","Lindt","Oboy","")
df_format_category_complete <- df_format_category[df_format_category$brand %in% brandcompleteweek$brand, ]
```

  