---
title: "Managebrandandcategorydata"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand and shapiro-wilk test
library("ggpubr")
library(data.table) #for set DT checking brand
library(car) #function for testing coefficient equivalence
library("Hmisc") #for optim
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_butikid.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```

```{r rename all brand, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
            #bakingingredient
              "Dr.OETKER"="Dr.Oetker",
              "KUNG MARKATTA" = "Kung markatta",
              "ODENSE" = "Odense",
            #bathproducts
              "DEPEND"="Depend",
              "DETTOL" = "Dettol",
              "Dove Men Care" = "Dove",
              "HAWAIIAN TROPIC" = "Hawaiian Tropic",
              "NEEDS" = "Needs",
              "NIVEA" = "Nivea",
              "Nivea Body" = "Nivea",
              "Nivea Face" = "Nivea",
              "NIVEA FACE" = "Nivea",
              "Nivea Lip" = "Nivea",
              "Nivea Men" = "Nivea",
              "Nivea Shower" = "Nivea",
              "OLAY" = "Olay",
              "PALMETTEN" = "Palmetten",
              "PALMOLIVE" = "Palmolive",
            #Bottled water
              "BONAQUA SILVER"="bonaqua silver",
            #Canned Soup
              "FELIX"="felix",
              "HEINZ" = "Heinz",
            #Canned Vegg
              "FONTANA"="Fontana",
            #Cereals
              "HONEY MONSTER"="Honey Monster",
              "KUNG MARKATTA"="Kung markatta",
              "Paulun"="Pauluns",
              "QUAKER"="Quaker",
              "RenÃ©e Voltaire"="ReneeVoltaire", "RENÃ‰E VOLTAIRE"="ReneeVoltaire",
            #Chips
              "CRISPY"="Crispy",
              "ESTRELLA" = "Estrella",
              "GÃ…RDSCHIPS" = "GÃ¥rdschips",
              "OLW" = "Olw",
              "PRIMA" = "Prima",
              "ROOTFRUIT" = "Rootfruit",
            #Chocolate
              "Droste"="DROSTE",
              "FAZER" = "Fazer",
              "LINDT" = "Lindt",
              "MALTESERS" = "Maltesers",
              "MARABOU" = "Marabou",
              "PLAMIL" = "Plamil",
              "QUICK MILK" = "Quick Milk",
              "RITTER SPORT" = "Ritter Sport",
            #cleaningProducts
              "AIR WICK"="Air Wick",
              "CILLIT BANG" = "Cillit Bang",
              "TOMIK" = "Tomik",
            #Coffees
              "DOLCE GUSTO"="Dolce Gusto",
              "LÃ–FBERGS" = "LÃ¶fbergs",
              "LAVAZZA" = "Lavazza",
            #cookies
              "MC VITIES"="Mc Vities",
              "MARYLAND" = "Maryland",
            #cream
              "ARLA"="Arla",
              "LINDAHLS" = "Lindahls",
            #Dishwasher & washing up
              "FINISH"="Finish",
            #FrozenPizza
              "BILLYS"="Billys",
            #Fruitjuice
              "FONTANA"="Fontana",
              "BRAVO" = "Bravo",
              "Froosh" = "Froosh",
              "GLOCKENGOLD" = "glockengold",
              "GLOCKEN GOLD" = "glockengold",
              "KIVIKS" = "Kiviks",
              "Loviseberg" = "LOVISEBERG",
              "PURE" = "Pure",
              "RYNKEBY" = "Runkeby",
            #Icecream
              "Ã–STERHAGENGLASS"="Ã–STERHAGEN",
              "ALVESTAGLASS" = "ALVESTA GLASS",
              "BEN & JERRYS" = "Ben & Jerrys",
              "CORNETTO" = "Cornetto",
              "GB GLACE" = "GB Glace",
              "HÃ„AGEN DAZS" = "HÃ¤agen Dazs",
              "HÃ„AGEN-DAZS" = "HÃ¤agen Dazs",
              "KLINGS" = "KLING",
              "KLINGS GLASS" = "KLING", 
              "SIA" = "SIA Glass",
              "TRIUMF GLASS" = "Triumf Glass",
              "Yollibox" = "YOLLIBOX",
            #Jam
              "SKIPPY"="Skippy",
            #Laundry
              "SOFTLAN"="Softlan",
            #ReadyMadeMeal
              "BIOFOOD"="Biofood",
              "MONINI" = "Monini",
            #Softdrinks
              "COCA-COLA"="Coca-Cola",
              "COCA COLA"="Coca-Cola",
              "Coca-Cola life"="Coca-Cola",
              "FANTA" = "Fanta",
              "Fanta Zero" = "Fanta",
              "MOUNTAIN DEW" = "Mountain Dew",
              "PEPSI" = "Pepsi",
              "SAN PELLEGRINO"="San Pellegrino",
              "Sodastream EXTERN" = "Sodastream",
              "Sprite Zero"="Sprite",
              "Three Hearts"="THREE HEARTS",
            #Sweetandcandies
              "BUBS"="Bubs",
              "Carletti"="CARLETTI",
              "COTE D OR"="Cote d Or",
              "EKORRENS" = "Ekorrens",
              "FAZER" = "Fazer",
              "HARIBO" = "Haribo",
              "KONFEKTA" = "Konfekta",
              "KOUVOLAN"="Kouvolan",
              "LINDT" = "Lindt",
              "MARABOU"="Marabou",
              "MARS"="Mars",
              "NESTLE" = "Nestle",
              "SNICKERS" = "Snickers",
              "TWIX" = "Twix",
              "TOMS" = "Toms",
            #Tobacco
              "BIC"="Bic",
              "BLEND"="Blend",
              "CAMEL"="Camel",
              "CRICKET" = "Cricket",
              "GÃ–TEBORGS" = "GÃ¶teborgs",
              "GÃ¶teborgs" = "Gateborgs",
              "GENERAL" = "General",
              "JOHN SILVER" = "John Silver",
              "KALIBER"="Kaliber",
              "LEVEL" = "Level",
              "MARLBORO"="Marlboro",
              "PRINCE"="Prince",
              "RIGHT" = "Right",
              "WINSTON" = "Winston",
            #Toiletries
              "EKULF"="Ekulf",
              "JORDAN"="Jordan",
              "LISTERINE"="Listerine",
              "PEPSODENT" = "Pepsodent",
              "SENSODYNE" = "Sensodyne",
            #yogurt
              "ARLA KO"="Arla Ko",
              "FjÃ¤llyoghurt"="FjÃ¤llfil"
              ))
```



```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df_offline[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```

#Function of filtering brand

```{r define function for filtering brand with complete (153) observations}
brandfiltering_format <- function(df,format,category,nweek){
  df_format_category <- df[df$category == category & df$format == format,]
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand=droplevels(brand))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand)

df_format_category_complete <- df_format_category[df_format_category$brand %in% brandcompleteweek$brand, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand=droplevels(brand))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]

return(df_format_category_complete)
}
```


#Function of creating relevant variables

```{r create trend variable, include=FALSE}
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

make_copula <- function(x) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-.0000001), qnorm(ecdf(x)(x))))}

genrelevantvar <- function(df){
  
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign)), .(vecka,brand,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info


distinctbrandcomplete <- unique(df$brand)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 19 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgcompfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgcomppricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgcompdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dlognondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

#create copula for marketing mix
df_bybrand$cop_finalprice <- make_copula(df_bybrand$avgfinalprice)
df_bybrand$cop_avgcompfinalprice <- make_copula(df_bybrand$avgcompfinalprice)
df_bybrand$cop_logfinalprice <- make_copula(log((df_bybrand$avgfinalprice)))
df_bybrand$cop_logavgcompfinalprice <- make_copula(log(df_bybrand$avgcompfinalprice))

#Gap measure
df_bybrand$hgap <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$cgap <- ((df_bybrand$avgfinalprice - df_bybrand$avgcompfinalprice)/df_bybrand$avgcompfinalprice)

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))

#add campaign regardless price or nonprice
df_bybrand$campaign <- ifelse(df_bybrand$totalpricecampaign + df_bybrand$totalnonpricecampaign > 0, 1, 0)


return(df_bybrand)
}
```


#Function of estimating non-linear pricing curve
```{r nonlinear function full model}
#for full model
est_fullnonlinear <- function(df,format,category,nweek,brand,gamma){

df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgfinalprice*I(dlogavgcompfinalprice^2) + campaign + et_hat+ holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)


#


logL_nonlinearfull <- function(parvec){
  
  F_H_G <- 1/(1+exp(gamma*(brand_data$hgap - parvec[4])))
  F_H_L <- 1/(1+exp(-gamma*(brand_data$hgap - parvec[6])))
  
  F_C_G <- 1/(1+exp(gamma*(brand_data$cgap - parvec[8])))
  F_C_L <- 1/(1+exp(-gamma*(brand_data$cgap - parvec[10])))
  
  ut <- brand_data$dlogtotalvolume - (parvec[1] + (parvec[2] 
                                         + parvec[3]*F_H_G + parvec[5]*F_H_L 
                                         + parvec[7]*F_C_G + parvec[9]*F_C_L)*brand_data$dlogavgfinalprice 
                            + parvec[11]*brand_data$campaign
                            + parvec[12]*brand_data$et_hat +  parvec[13]*brand_data$holiday
                            + parvec[14]*brand_data$cop_logfinalprice +  parvec[15]*brand_data$cop_logavgcompfinalprice)
  logL <- sum (-0.5* log(parvec[16]) - 0.5*ut^2/parvec[16] )
  return(-logL)
  }
#starting value = c(1:constant, 2:price_elas ,3:hgap_gain_slope,4:hgap_gain_threshold,5:hgap_loss_slope,6:hgap_loss_threshold
#                   7:cgap_gain_slope,8:cgap_gain_threshold,9:cgap_loss_slope,10:cgap_loss_threshold)
  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- -0.91 #mean estimate from Pauwels et al. (2007)
  parvec_4 <- -0.23 #mean estimate from Pauwels et al. (2007)
  parvec_5 <- 0.32 #mean estimate from Pauwels et al. (2007)
  parvec_6 <-  0.15 #mean estimate from Pauwels et al. (2007)
  parvec_7 <- 0.49 #mean estimate from Pauwels et al. (2007)
  parvec_8 <- -0.15 #mean estimate from Pauwels et al. (2007)
  parvec_9 <- 0.63 #mean estimate from Pauwels et al. (2007)
  parvec_10 <-  0.17 #mean estimate from Pauwels et al. (2007)
  parvec_11 <- summary(lm_linear)$coefficients[7,1]
  parvec_12 <- summary(lm_linear)$coefficients[8,1]
  parvec_13 <- summary(lm_linear)$coefficients[9,1]
  parvec_14 <- summary(lm_linear)$coefficients[10,1]
  parvec_15 <- summary(lm_linear)$coefficients[11,1]
  parvec_16 <- 1.0 #standard se
  Start_v <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8,
               parvec_9,parvec_10,parvec_11,parvec_12,parvec_13,parvec_14,parvec_15,parvec_16)
  
MLE_logL_nonlinearfull = optim(Start_v,
                  fn = logL_nonlinearfull, # function to maximize
                  method = "BFGS",
                  #method = "SANN",
                  control = list(fnscale = 1), # minimize the function
                  hessian = T # calculate Hessian matrix because we will need for confidence intervals
                  
)

par.est<-MLE_logL_nonlinearfull$par
#par.est
# Calculating the Hessian. Needed to compute std. for estimates
OI<-solve(MLE_logL_nonlinearfull$hessian)

# Calculating std. and t-values for the estimates
par.se<-sqrt(diag(OI))
#par.se
par_name <- c("constant", "price_elas" ,"hgap_gain_slope","hgap_gain_threshold","hgap_loss_slope","hgap_loss_threshold",
                   "cgap_gain_slope","cgap_gain_threshold","cgap_loss_slope","cgap_loss_threshold",
          "campaign","ethat","holiday","cop_price","cop_compprice","model_SE")
par <- data.table(cbind(par_name,par.est,par.se))
par$tstat <- as.numeric(par$par.est)/as.numeric(par$par.se)
par$category <- category
par$format <- format
par$brand <- brand

return(par)
}

#est_loka_super = est_fullnonlinear(df,format = "supermarket",category ="Bottled water",nweek=153,brand = "Loka",gamma = 100)
```

```{r nonlinear function for histgap}
#for Histgap
est_histgap <- function(df,format,category,nweek,brand,gamma){

df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompfinalprice  + campaign + et_hat+ holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)


logL_nonlinearfull <- function(parvec){
  
  F_H_G <- 1/(1+exp(gamma*(brand_data$hgap - parvec[4])))
  F_H_L <- 1/(1+exp(-gamma*(brand_data$hgap - parvec[6])))
  
  
  ut <- brand_data$dlogtotalvolume - (parvec[1] + (parvec[2] 
                                         + parvec[3]*F_H_G + parvec[5]*F_H_L)*brand_data$dlogavgfinalprice 
                            + parvec[7]*brand_data$dlogavgcompfinalprice          
                            + parvec[8]*brand_data$campaign
                            + parvec[9]*brand_data$et_hat +  parvec[10]*brand_data$holiday
                            + parvec[11]*brand_data$cop_logfinalprice +parvec[12]*brand_data$cop_logavgcompfinalprice)
  logL <- sum (-0.5* log(parvec[13]) - 0.5*ut^2/parvec[13] )
  return(-logL)
  }
#starting value = c(1:constant, 2:price_elas ,3:hgap_gain_slope,4:hgap_gain_threshold,5:hgap_loss_slope,6:hgap_loss_threshold
#                   7:cgap_gain_slope,8:cgap_gain_threshold,9:cgap_loss_slope,10:cgap_loss_threshold)
  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- -0.91 #mean estimate from Pauwels et al. (2007)
  parvec_4 <- -0.23 #mean estimate from Pauwels et al. (2007)
  parvec_5 <- 0.32 #mean estimate from Pauwels et al. (2007)
  parvec_6 <-  0.15 #mean estimate from Pauwels et al. (2007)
  parvec_7 <- summary(lm_linear)$coefficients[5,1]
  parvec_8 <- summary(lm_linear)$coefficients[6,1]
  parvec_9 <- summary(lm_linear)$coefficients[7,1]
  parvec_10 <- summary(lm_linear)$coefficients[8,1]
  parvec_11 <- summary(lm_linear)$coefficients[9,1]
  parvec_12 <- summary(lm_linear)$coefficients[10,1]
  parvec_13 <- 1.0 #standard se
  Start_v <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8,
               parvec_9,parvec_10,parvec_11,parvec_12,parvec_13)
  
MLE_logL_nonlinearfull = optim(Start_v,
                  fn = logL_nonlinearfull, # function to maximize
                  method = "BFGS",
                  #method = "SANN",
                  control = list(fnscale = 1), # minimize the function
                  hessian = T # calculate Hessian matrix because we will need for confidence intervals
                  
)

par.est<-MLE_logL_nonlinearfull$par
#par.est
# Calculating the Hessian. Needed to compute std. for estimates
OI<-solve(MLE_logL_nonlinearfull$hessian)

# Calculating std. and t-values for the estimates
par.se<-sqrt(diag(OI))
#par.se
par_name <- c("constant", "price_elas" ,"hgap_gain_slope","hgap_gain_threshold","hgap_loss_slope","hgap_loss_threshold",
                   "compprice","campaign","ethat","holiday","cop_price",
              "cop_compprice","model_SE")
par <- data.table(cbind(par_name,par.est,par.se))
par$tstat <- as.numeric(par$par.est)/as.numeric(par$par.se)
par$category <- category
par$format <- format
par$brand <- brand

return(par)
}

#est_valio_hyper = est_histgap(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Valio",gamma = 100)
```

```{r nonlinear function for histgap}
est_compgap <- function(df,format,category,nweek,brand,gamma){

df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgfinalprice*I(dlogavgcompfinalprice^2) + dlogavgcompfinalprice  + campaign + et_hat + holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)


logL_nonlinearfull <- function(parvec){
  
  F_C_G <- 1/(1+exp(gamma*(brand_data$cgap - parvec[4])))
  F_C_L <- 1/(1+exp(-gamma*(brand_data$cgap - parvec[6])))
  
  ut <- brand_data$dlogtotalvolume - (parvec[1] + (parvec[2] 
                                         + parvec[3]*F_C_G + parvec[5]*F_C_L)*brand_data$dlogavgfinalprice 
                            + parvec[7]*brand_data$dlogavgcompfinalprice          
                            + parvec[8]*brand_data$campaign
                            + parvec[9]*brand_data$et_hat +  parvec[10]*brand_data$holiday
                            + parvec[11]*brand_data$cop_logfinalprice +parvec[12]*brand_data$cop_logavgcompfinalprice)
  logL <- sum (-0.5* log(parvec[13]) - 0.5*ut^2/parvec[13] )
  return(-logL)
  }

  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- -0.91 #mean estimate from Pauwels et al. (2007)
  parvec_4 <- -0.23 #mean estimate from Pauwels et al. (2007)
  parvec_5 <- 0.32 #mean estimate from Pauwels et al. (2007)
  parvec_6 <-  0.15 #mean estimate from Pauwels et al. (2007)
  parvec_7 <- summary(lm_linear)$coefficients[5,1]
  parvec_8 <- summary(lm_linear)$coefficients[6,1]
  parvec_9 <- summary(lm_linear)$coefficients[7,1]
  parvec_10 <- summary(lm_linear)$coefficients[8,1]
  parvec_11 <- summary(lm_linear)$coefficients[9,1]
  parvec_12 <- summary(lm_linear)$coefficients[10,1]
  parvec_13 <- 1.0 #standard se
  Start_v <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8,
               parvec_9,parvec_10,parvec_11,parvec_12,parvec_13)
  
MLE_logL_nonlinearfull = optim(Start_v,
                  fn = logL_nonlinearfull, # function to maximize
                  method = "BFGS",
                  #method = "SANN",
                  control = list(fnscale = 1), # minimize the function
                  hessian = T # calculate Hessian matrix because we will need for confidence intervals
                  
)

par.est<-MLE_logL_nonlinearfull$par
#par.est
# Calculating the Hessian. Needed to compute std. for estimates
OI<-solve(MLE_logL_nonlinearfull$hessian)

# Calculating std. and t-values for the estimates
par.se<-sqrt(diag(OI))
#par.se
par_name <- c("constant", "price_elas" ,"cgap_gain_slope","cgap_gain_threshold","cgap_loss_slope","cgap_loss_threshold",
                   "compprice","campaign","ethat","holiday","cop_price",
              "cop_compprice","model_SE")
par <- data.table(cbind(par_name,par.est,par.se))
par$tstat <- as.numeric(par$par.est)/as.numeric(par$par.se)
par$category <- category
par$format <- format
par$brand <- brand

return(par)
}

est_ICA_super = est_compgap(df,format = "supermarket",category ="Bottled water",nweek=153,brand = "ICA",gamma = 100)
```

```{r linear function}
#for compgap
est_linear <- function(df,format,category,nweek,brand,gamma){

df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + dlogavgcompfinalprice + campaign + et_hat + holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)

  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- summary(lm_linear)$coefficients[3,1]
  parvec_4 <- summary(lm_linear)$coefficients[4,1]
  parvec_5 <- summary(lm_linear)$coefficients[5,1]
  parvec_6 <- summary(lm_linear)$coefficients[6,1]
  parvec_7 <- summary(lm_linear)$coefficients[7,1]
  parvec_8 <- summary(lm_linear)$coefficients[8,1]
  par.est <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8)
  
  se_1 <- summary(lm_linear)$coefficients[1,2]
  se_2 <- summary(lm_linear)$coefficients[2,2]
  se_3 <- summary(lm_linear)$coefficients[3,2]
  se_4 <- summary(lm_linear)$coefficients[4,2]
  se_5 <- summary(lm_linear)$coefficients[5,2]
  se_6 <- summary(lm_linear)$coefficients[6,2]
  se_7 <- summary(lm_linear)$coefficients[7,2]
  se_8 <- summary(lm_linear)$coefficients[8,2]
  par.se <- c(se_1,se_2,se_3,se_4,se_5,se_6,se_7,se_8)

#par.se
par_name <- c("constant", "price_elas" ,
                   "compprice","campaign","ethat","holiday","cop_price",
              "cop_compprice")
par <- data.table(cbind(par_name,par.est,par.se))
par$tstat <- as.numeric(par$par.est)/as.numeric(par$par.se)
par$category <- category
par$format <- format
par$brand <- brand

return(par)
}

#est_ICA_convenience = est_linear(df,format = "convenience",category ="Bottled water",nweek=153,brand = "ICA",gamma = 100)
```



#Estimation
```{r Bottled Water}
#ICA
est_water_ICA_hypermarket = est_linear(df,format = "hypermarket",category ="Bottled water",nweek=153,brand = "ICA",gamma = 100)
est_water_ICA_super = est_compgap(df,format = "supermarket",category ="Bottled water",nweek=153,brand = "ICA",gamma = 100)
est_water_ICA_convenience = est_linear(df,format = "convenience",category ="Bottled water",nweek=153,brand = "ICA",gamma = 100)

#Loka
est_water_Loka_hypermarket = est_linear(df,format = "hypermarket",category ="Bottled water",nweek=153,brand = "Loka",gamma = 100)
est_water_Loka_super = est_fullnonlinear(df,format = "supermarket",category ="Bottled water",nweek=153,brand = "Loka",gamma = 100)
est_water_Loka_convenience = est_linear(df,format = "convenience",category ="Bottled water",nweek=153,brand = "Loka",gamma = 100)

#RamlÃ¶sa
est_water_ramlosa_hypermarket = est_linear(df,format = "hypermarket",category ="Bottled water",nweek=153,brand = "RamlÃ¶sa",gamma = 100)
est_water_ramlosa_super = est_histgap(df,format = "supermarket",category ="Bottled water",nweek=153,brand = "RamlÃ¶sa",gamma = 100)
est_water_ramlosa_convenience = est_linear(df,format = "convenience",category ="Bottled water",nweek=153,brand = "RamlÃ¶sa",gamma = 100)

bottle_water_estimation = rbind(est_water_ICA_hypermarket,est_water_ICA_super,est_water_ICA_convenience,
                              est_water_Loka_hypermarket,est_water_Loka_super,est_water_Loka_convenience,
                               est_water_ramlosa_hypermarket, est_water_ramlosa_super, est_water_ramlosa_convenience)
```


```{r Butter}
#Becel
est_butter_Becel_hypermarket = est_linear(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Becel",gamma = 100)
est_butter_Becel_super = est_compgap(df,format = "supermarket",category ="Butter",nweek=153,brand = "Becel",gamma = 100)
est_butter_Becel_convenience = est_fullnonlinear(df,format = "convenience",category ="Butter",nweek=153,brand = "Becel",gamma = 100)

#ICA
est_butter_ICA_hypermarket = est_histgap(df,format = "hypermarket",category ="Butter",nweek=153,brand = "ICA",gamma = 100)
est_butter_ICA_super = est_histgap(df,format = "supermarket",category ="Butter",nweek=153,brand = "ICA",gamma = 100)
# est_butter_ICA_convenience = est_compgap(df,format = "convenience",category ="Butter",nweek=153,brand = "ICA",gamma = 100) #requires further examinaton system is exactly singular: U[3,3] = 0 for hessian

#Milda
# est_butter_Milda_hypermarket = est_linear(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Milda",gamma = 100) #ALWAYS HAVE CAMPAIGN
#est_butter_Milda_super = est_compgap(df,format = "supermarket",category ="Butter",nweek=153,brand = "Milda",gamma = 100) #requires further examinaton system is exactly singular: U[4,4] = 0 for hessian
#est_butter_Milda_convenience = est_fullnonlinear(df,format = "convenience",category ="Butter",nweek=153,brand = "Milda",gamma = 100) #ALWAYS HAVE CAMPAIGN

#KronjÃ¤st
# est_butter_Kronjast_hypermarket = est_histgap(df,format = "hypermarket",category ="Butter",nweek=153,brand = "KronjÃ¤st",gamma = 100) #requires further examinaton system is exactly U[4,4] = 0
est_butter_kronjast_super = est_linear(df,format = "supermarket",category ="Butter",nweek=153,brand = "KronjÃ¤st",gamma = 100)
#est_butter_kronjast_convenience = est_histgap(df,format = "convenience",category ="Butter",nweek=153,brand = "KronjÃ¤st",gamma = 100) #requires further examinaton system is exactly U[3,3] = 0

#Valio
est_butter_valio_hypermarket = est_histgap(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Valio",gamma = 100)

#bregott
#est_butter_bregott_hypermarket = est_linear(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Bregott",gamma = 100) #ALWAYS HAVE CAMPAIGN
est_butter_bregott_supermarket = est_linear(df,format = "supermarket",category ="Butter",nweek=153,brand = "Bregott",gamma = 100)
est_butter_bregott_convenience = est_linear(df,format = "convenience",category ="Butter",nweek=153,brand = "Bregott",gamma = 100)

#Flora
est_butter_flora_hypermarket = est_linear(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Flora",gamma = 100)
est_butter_flora_supermarket = est_linear(df,format = "supermarket",category ="Butter",nweek=153,brand = "Flora",gamma = 100)

#Svenskt smar
# est_butter_svensktsmar_hypermarket = est_compgap(df,format = "hypermarket",category ="Butter",nweek=153,brand = "Svenskt smÃ¶r",gamma = 100) #requires further examinaton system is exactly U[4,4] = 0
est_butter_svensktsmar_supermarket = est_linear(df,format = "supermarket",category ="Butter",nweek=153,brand = "Svenskt smÃ¶r",gamma = 100)
est_butter_svensktsmar_convenience = est_histgap(df,format = "convenience",category ="Butter",nweek=153,brand = "Svenskt smÃ¶r",gamma = 100)

#Latta
# est_butter_latta_supermarket = est_fullnonlinear(df,format = "supermarket",category ="Butter",nweek=153,brand = "LÃ¤tta",gamma = 100) #requires further examinaton system is exactly U[3,3] = 0


butter_estimation = rbind(est_butter_Becel_hypermarket,est_butter_Becel_super,est_butter_Becel_convenience,est_butter_ICA_hypermarket,est_butter_kronjast_super,est_butter_valio_hypermarket,est_butter_bregott_supermarket,est_butter_bregott_convenience,est_butter_flora_hypermarket,est_butter_flora_supermarket,est_butter_svensktsmar_convenience)
```

```{r Chips}
#Estrella
#est_chips_estrella_hypermarket = est_linear(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "Estrella",gamma = 100) #ALWAYS HAVE CAMPAIGN
#est_chips_estrella_super = est_linear(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153,brand = "Estrella",gamma = 100) #ALWAYS HAVE CAMPAIGN
est_chips_estrella_convenience = est_linear(df,format = "convenience",category ="Chips & Salty snacks",nweek=153,brand = "Estrella",gamma = 100)

#ICA and ICABasic
#est_chips_ICA_hypermarket = est_linear(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "ICA",gamma = 100) #ALWAYS HAVE CAMPAIGN
est_chips_ICA_supermarket = est_linear(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153,brand = "ICA",gamma = 100)
est_chips_ICA_convenience = est_linear(df,format = "convenience",category ="Chips & Salty snacks",nweek=153,brand = "ICA",gamma = 100)
est_chips_ICAbasic_hypermarket = est_histgap(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "ICA Basic",gamma = 100)

#Olw
#est_chips_olw_hypermarket = est_linear(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "Olw",gamma = 100) #ALWAYS HAVE CAMPAIGN
est_chips_olw_supermarket = est_linear(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153,brand = "Olw",gamma = 100)
est_chips_olw_convenience = est_linear(df,format = "convenience",category ="Chips & Salty snacks",nweek=153,brand = "Olw",gamma = 100)

#Pringles
est_chips_pringles_hypermarket = est_linear(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "Pringles",gamma = 100)
est_chips_pringles_supermarket = est_linear(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153,brand = "Pringles",gamma = 100)

#Lantchips
est_chips_lantchips_hypermarket = est_linear(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153,brand = "LantChips",gamma = 100)


chips_estimation = rbind(est_chips_estrella_convenience,est_chips_ICA_supermarket,est_chips_ICA_convenience,est_chips_ICAbasic_hypermarket,est_chips_olw_supermarket,est_chips_olw_convenience,est_chips_pringles_hypermarket,est_chips_pringles_supermarket,est_chips_lantchips_hypermarket)
```

```{r Chocolates}
#Fazer
est_choco_fazer_hypermarket = est_linear(df,format = "hypermarket",category ="Chocolate",nweek=153,brand = "Fazer",gamma = 100) 
est_choco_fazer_supermarket = est_linear(df,format = "supermarket",category ="Chocolate",nweek=153,brand = "Fazer",gamma = 100) 
#est_choco_fazer_convenience = est_compgap(df,format = "convenience",category ="Chocolate",nweek=153,brand = "Fazer",gamma = 100)#requires further examinaton system is exactly U[3,3] = 0

#Marabou
# est_choco_marabou_hypermarket = est_compgap(df,format = "hypermarket",category ="Chocolate",nweek=153,brand = "Marabou",gamma = 100)  #requires further examinaton system is exactly U[3,3]
est_choco_marabou_supermarket = est_fullnonlinear(df,format = "supermarket",category ="Chocolate",nweek=153,brand = "Marabou",gamma = 100)
est_choco_marabou_convenience = est_linear(df,format = "convenience",category ="Chocolate",nweek=153,brand = "Marabou",gamma = 100)

#Cloetta
est_choco_cloetta_hypermarket = est_fullnonlinear(df,format = "hypermarket",category ="Chocolate",nweek=153,brand = "Cloetta",gamma = 100)
est_choco_cloetta_supermarket = est_linear(df,format = "supermarket",category ="Chocolate",nweek=153,brand = "Cloetta",gamma = 100)
est_choco_cloetta_convenience = est_linear(df,format = "convenience",category ="Chocolate",nweek=153,brand = "Cloetta",gamma = 100)

#Oboy
# est_choco_oboy_hypermarket = est_histgap(df,format = "hypermarket",category ="Chocolate",nweek=153,brand = "Oboy",gamma = 100) #requires further examinaton system is exactly U[3,3]
est_choco_oboy_supermarket = est_histgap(df,format = "supermarket",category ="Chocolate",nweek=153,brand = "Oboy",gamma = 100)

#Lindt
est_choco_lindt_hypermarket = est_linear(df,format = "hypermarket",category ="Chocolate",nweek=153,brand = "Lindt",gamma = 100)
# est_choco_lindt_supermarket = est_compgap(df,format = "supermarket",category ="Chocolate",nweek=153,brand = "Lindt",gamma = 100) #requires further examinaton system is exactly U[5,5]

choco_estimation = rbind(est_choco_fazer_hypermarket,est_choco_fazer_supermarket,est_choco_marabou_supermarket,est_choco_marabou_convenience,est_choco_cloetta_hypermarket,est_choco_cloetta_supermarket,est_choco_cloetta_convenience,est_choco_oboy_supermarket,est_choco_lindt_hypermarket)
```


```{r Yogurt}
#ICA
# est_yogurt_ICA_hypermarket = est_histgap(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "ICA",gamma = 100) #ALWAYS ON CAMPAIGN
est_yogurt_ICA_supermarket = est_linear(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "ICA",gamma = 100) 
est_yogurt_ICA_convenience = est_linear(df,format = "convenience",category ="Yogurt",nweek=153,brand = "ICA",gamma = 100)

#Valio
est_yogurt_valio_hypermarket = est_histgap(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Valio",gamma = 100)
est_yogurt_valio_supermarket = est_fullnonlinear(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Valio",gamma = 100)
est_yogurt_valio_convenience = est_linear(df,format = "convenience",category ="Yogurt",nweek=153,brand = "Valio",gamma = 100)

#Arla Ko
# est_yogurt_arlako_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Arla Ko",gamma = 100) #ALWAYS ON CAMPAIGN
est_yogurt_arlako_supermarket = est_linear(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Arla Ko",gamma = 100) 
est_yogurt_arlako_convenience = est_linear(df,format = "convenience",category ="Yogurt",nweek=153,brand = "Arla Ko",gamma = 100) 

#Yoggi
est_yogurt_yoggi_hypermarket = est_histgap(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Yoggi",gamma = 100)
est_yogurt_yoggi_supermarket = est_histgap(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Yoggi",gamma = 100)
est_yogurt_yoggi_convenience = est_histgap(df,format = "convenience",category ="Yogurt",nweek=153,brand = "Yoggi",gamma = 100)

#Verum
est_yogurt_verum_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Verum",gamma = 100)
est_yogurt_verum_supermarket = est_linear(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Verum",gamma = 100)
est_yogurt_verum_convenience = est_linear(df,format = "convenience",category ="Yogurt",nweek=153,brand = "Verum",gamma = 100)

#Yoplait
est_yogurt_yoplait_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Yoplait",gamma = 100)
# est_yogurt_yoplait_supermarket = est_histgap(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Yoplait",gamma = 100)  #requires further examinaton system is exactly U[3,3]

#Fjallfill
est_yogurt_fjallfill_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "FjÃ¤llfil",gamma = 100)
est_yogurt_fjallfill_supermarket = est_histgap(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "FjÃ¤llfil",gamma = 100)

#otherbrand
est_yogurt_Danonino_hypermarket = est_histgap(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Danonino",gamma = 100)
est_yogurt_skonemejeri_hypermarket = est_histgap(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "SkÃ¥nemejerier",gamma = 100)
est_yogurt_Gefleortens_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Gefleortens",gamma = 100)
est_yogurt_Tiger_hypermarket = est_linear(df,format = "hypermarket",category ="Yogurt",nweek=153,brand = "Tiger",gamma = 100)
est_yogurt_Activia_supermarket = est_linear(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "Activia",gamma = 100)
# est_yogurt_falkping_supermarket = est_histgap(df,format = "supermarket",category ="Yogurt",nweek=153,brand = "FalkÃ¶pings Mejeri",gamma = 100) #requires further examinaton system is exactly U[3,3]


yogurt_estimation = rbind(est_yogurt_ICA_supermarket,est_yogurt_ICA_convenience,est_yogurt_valio_hypermarket,est_yogurt_valio_supermarket,est_yogurt_valio_convenience,est_yogurt_arlako_supermarket,est_yogurt_arlako_convenience,est_yogurt_yoggi_hypermarket,est_yogurt_yoggi_supermarket,est_yogurt_yoggi_convenience,est_yogurt_verum_hypermarket,est_yogurt_verum_supermarket,est_yogurt_verum_convenience,est_yogurt_yoplait_hypermarket,est_yogurt_fjallfill_hypermarket,est_yogurt_fjallfill_supermarket,est_yogurt_Danonino_hypermarket,est_yogurt_skonemejeri_hypermarket,est_yogurt_Gefleortens_hypermarket,est_yogurt_Tiger_hypermarket,est_yogurt_Activia_supermarket)
```

```{r summarize}
est_results <- rbind(bottle_water_estimation,butter_estimation,chips_estimation,choco_estimation,yogurt_estimation)

write.csv(est_results,"C:/Users/TA.4621/Desktop/2021/DiscountThreshold/WorkingRepo/src/analysis/nonlinear_byformat/price threshold/prelimestimation_230520.csv", row.names = TRUE)
```


```{r for check, eval=FALSE, include=FALSE}
format = "supermarket"
category ="Butter"
nweek=153
brand = "LÃ¤tta"
gamma = 100
df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgfinalprice*I(dlogavgcompfinalprice^2) + campaign + et_hat+ holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)


logL_nonlinearfull <- function(parvec){
  
  F_H_G <- 1/(1+exp(gamma*(brand_data$hgap - parvec[4])))
  F_H_L <- 1/(1+exp(-gamma*(brand_data$hgap - parvec[6])))
  
  F_C_G <- 1/(1+exp(gamma*(brand_data$cgap - parvec[8])))
  F_C_L <- 1/(1+exp(-gamma*(brand_data$cgap - parvec[10])))
  
  ut <- brand_data$dlogtotalvolume - (parvec[1] + (parvec[2] 
                                         + parvec[3]*F_H_G + parvec[5]*F_H_L 
                                         + parvec[7]*F_C_G + parvec[9]*F_C_L)*brand_data$dlogavgfinalprice 
                            + parvec[11]*brand_data$campaign
                            + parvec[12]*brand_data$et_hat +  parvec[13]*brand_data$holiday
                            + parvec[14]*brand_data$cop_logfinalprice +  parvec[15]*brand_data$cop_logavgcompfinalprice)
  logL <- sum (-0.5* log(parvec[16]) - 0.5*ut^2/parvec[16] )
  return(-logL)
  }
#starting value = c(1:constant, 2:price_elas ,3:hgap_gain_slope,4:hgap_gain_threshold,5:hgap_loss_slope,6:hgap_loss_threshold
#                   7:cgap_gain_slope,8:cgap_gain_threshold,9:cgap_loss_slope,10:cgap_loss_threshold)
  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- -0.91 #mean estimate from Pauwels et al. (2007)
  parvec_4 <- -0.23 #mean estimate from Pauwels et al. (2007)
  parvec_5 <- 0.32 #mean estimate from Pauwels et al. (2007)
  parvec_6 <-  0.15 #mean estimate from Pauwels et al. (2007)
  parvec_7 <- 0.49 #mean estimate from Pauwels et al. (2007)
  parvec_8 <- -0.15 #mean estimate from Pauwels et al. (2007)
  parvec_9 <- 0.63 #mean estimate from Pauwels et al. (2007)
  parvec_10 <-  0.17 #mean estimate from Pauwels et al. (2007)
  parvec_11 <- summary(lm_linear)$coefficients[7,1]
  parvec_12 <- summary(lm_linear)$coefficients[8,1]
  parvec_13 <- summary(lm_linear)$coefficients[9,1]
  parvec_14 <- summary(lm_linear)$coefficients[10,1]
  parvec_15 <- summary(lm_linear)$coefficients[11,1]
  parvec_16 <- 1.0 #standard se
  Start_v <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8,
               parvec_9,parvec_10,parvec_11,parvec_12,parvec_13,parvec_14,parvec_15,parvec_16)
  
MLE_logL_nonlinearfull = optim(Start_v,
                  fn = logL_nonlinearfull, # function to maximize
                  method = "BFGS",
                  #method = "SANN",
                  control = list(fnscale = 1), # minimize the function
                  hessian = T # calculate Hessian matrix because we will need for confidence intervals
                  
)

par.est<-MLE_logL_nonlinearfull$par
#par.est
# Calculating the Hessian. Needed to compute std. for estimates
OI<-solve(MLE_logL_nonlinearfull$hessian)

# Calculating std. and t-values for the estimates
par.se<-sqrt(diag(OI))
#par.se
par_name <- c("constant", "price_elas" ,"cgap_gain_slope","cgap_gain_threshold","cgap_loss_slope","cgap_loss_threshold",
                   "compprice","nonpricecampaign","pricecampaign","ethat","holiday","cop_price",
              "cop_compprice","model_SE")
par <- data.table(cbind(par_name,par.est,par.se))
par$tstat <- as.numeric(par$par.est)/as.numeric(par$par.se)
par$category <- category
par$format <- format
par$brand <- brand

```

```{r}
format = "hypermarket"
category ="Yogurt"
nweek=153
brand = "Arla Ko"
gamma = 100

df_formatcat <- brandfiltering_format(df,format,category,nweek)
agg_df_formatcat <- genrelevantvar(df_formatcat)

brand_data <- agg_df_formatcat[agg_df_formatcat$brand == brand,]

  
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

lm_linear <- lm(dlogtotalvolume ~ dlogavgfinalprice + dlogavgcompfinalprice + campaign + et_hat + holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)

  parvec_1 <- summary(lm_linear)$coefficients[1,1]
  parvec_2 <- summary(lm_linear)$coefficients[2,1]
  parvec_3 <- summary(lm_linear)$coefficients[3,1]
  parvec_4 <- summary(lm_linear)$coefficients[4,1]
  parvec_5 <- summary(lm_linear)$coefficients[5,1]
  parvec_6 <- summary(lm_linear)$coefficients[6,1]
  parvec_7 <- summary(lm_linear)$coefficients[7,1]
  parvec_8 <- summary(lm_linear)$coefficients[8,1]
  par.est <- c(parvec_1,parvec_2,parvec_3,parvec_4,parvec_5,parvec_6,parvec_7,parvec_8)
  
  se_1 <- summary(lm_linear)$coefficients[1,2]
  se_2 <- summary(lm_linear)$coefficients[2,2]
  se_3 <- summary(lm_linear)$coefficients[3,2]
  se_4 <- summary(lm_linear)$coefficients[4,2]
  se_5 <- summary(lm_linear)$coefficients[5,2]
  se_6 <- summary(lm_linear)$coefficients[6,2]
  se_7 <- summary(lm_linear)$coefficients[7,2]
  se_8 <- summary(lm_linear)$coefficients[8,2]
  par.se <- c(se_1,se_2,se_3,se_4,se_5,se_6,se_7,se_8)
```

```{r}
df_byformat <- setDT(df)[, .(LL=uniqueN(produkt_id),avgfinalprice=mean(finalspending/sales_volume)), .(category,format)]
write.csv(df_byformat,"C:/Users/TA.4621/Desktop/2021/DiscountThreshold/WorkingRepo/src/analysis/nonlinear_byformat/price threshold/data_cummary.csv", row.names = TRUE)
```

