---
title: "Managebrandandcategorydata"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand
library(car) #function for testing coefficient equivalence
library(lmtest) #function for testing nonlinearity
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_butikid.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```

```{r rename all brand, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
            #bakingingredient
              "Dr.OETKER"="Dr.Oetker",
              "KUNG MARKATTA" = "Kung markatta",
              "ODENSE" = "Odense",
            #bathproducts
              "DEPEND"="Depend",
              "DETTOL" = "Dettol",
              "Dove Men Care" = "Dove",
              "HAWAIIAN TROPIC" = "Hawaiian Tropic",
              "NEEDS" = "Needs",
              "NIVEA" = "Nivea",
              "Nivea Body" = "Nivea",
              "Nivea Face" = "Nivea",
              "NIVEA FACE" = "Nivea",
              "Nivea Lip" = "Nivea",
              "Nivea Men" = "Nivea",
              "Nivea Shower" = "Nivea",
              "OLAY" = "Olay",
              "PALMETTEN" = "Palmetten",
              "PALMOLIVE" = "Palmolive",
            #Bottled water
              "BONAQUA SILVER"="bonaqua silver",
            #Canned Soup
              "FELIX"="felix",
              "HEINZ" = "Heinz",
            #Canned Vegg
              "FONTANA"="Fontana",
            #Cereals
              "HONEY MONSTER"="Honey Monster",
              "KUNG MARKATTA"="Kung markatta",
              "Paulun"="Pauluns",
              "QUAKER"="Quaker",
              "RenÃ©e Voltaire"="ReneeVoltaire", "RENÃ‰E VOLTAIRE"="ReneeVoltaire",
            #Chips
              "CRISPY"="Crispy",
              "ESTRELLA" = "Estrella",
              "GÃ…RDSCHIPS" = "GÃ¥rdschips",
              "OLW" = "Olw",
              "PRIMA" = "Prima",
              "ROOTFRUIT" = "Rootfruit",
            #Chocolate
              "Droste"="DROSTE",
              "FAZER" = "Fazer",
              "LINDT" = "Lindt",
              "MALTESERS" = "Maltesers",
              "MARABOU" = "Marabou",
              "PLAMIL" = "Plamil",
              "QUICK MILK" = "Quick Milk",
              "RITTER SPORT" = "Ritter Sport",
            #cleaningProducts
              "AIR WICK"="Air Wick",
              "CILLIT BANG" = "Cillit Bang",
              "TOMIK" = "Tomik",
            #Coffees
              "DOLCE GUSTO"="Dolce Gusto",
              "LÃ–FBERGS" = "LÃ¶fbergs",
              "LAVAZZA" = "Lavazza",
            #cookies
              "MC VITIES"="Mc Vities",
              "MARYLAND" = "Maryland",
            #cream
              "ARLA"="Arla",
              "LINDAHLS" = "Lindahls",
            #Dishwasher & washing up
              "FINISH"="Finish",
            #FrozenPizza
              "BILLYS"="Billys",
            #Fruitjuice
              "FONTANA"="Fontana",
              "BRAVO" = "Bravo",
              "Froosh" = "Froosh",
              "GLOCKENGOLD" = "glockengold",
              "GLOCKEN GOLD" = "glockengold",
              "KIVIKS" = "Kiviks",
              "Loviseberg" = "LOVISEBERG",
              "PURE" = "Pure",
              "RYNKEBY" = "Runkeby",
            #Icecream
              "Ã–STERHAGENGLASS"="Ã–STERHAGEN",
              "ALVESTAGLASS" = "ALVESTA GLASS",
              "BEN & JERRYS" = "Ben & Jerrys",
              "CORNETTO" = "Cornetto",
              "GB GLACE" = "GB Glace",
              "HÃ„AGEN DAZS" = "HÃ¤agen Dazs",
              "HÃ„AGEN-DAZS" = "HÃ¤agen Dazs",
              "KLINGS" = "KLING",
              "KLINGS GLASS" = "KLING", 
              "SIA" = "SIA Glass",
              "TRIUMF GLASS" = "Triumf Glass",
              "Yollibox" = "YOLLIBOX",
            #Jam
              "SKIPPY"="Skippy",
            #Laundry
              "SOFTLAN"="Softlan",
            #ReadyMadeMeal
              "BIOFOOD"="Biofood",
              "MONINI" = "Monini",
            #Softdrinks
              "COCA-COLA"="Coca-Cola",
              "COCA COLA"="Coca-Cola",
              "Coca-Cola life"="Coca-Cola",
              "FANTA" = "Fanta",
              "Fanta Zero" = "Fanta",
              "MOUNTAIN DEW" = "Mountain Dew",
              "PEPSI" = "Pepsi",
              "SAN PELLEGRINO"="San Pellegrino",
              "Sodastream EXTERN" = "Sodastream",
              "Sprite Zero"="Sprite",
              "Three Hearts"="THREE HEARTS",
            #Sweetandcandies
              "BUBS"="Bubs",
              "Carletti"="CARLETTI",
              "COTE D OR"="Cote d Or",
              "EKORRENS" = "Ekorrens",
              "FAZER" = "Fazer",
              "HARIBO" = "Haribo",
              "KONFEKTA" = "Konfekta",
              "KOUVOLAN"="Kouvolan",
              "LINDT" = "Lindt",
              "MARABOU"="Marabou",
              "MARS"="Mars",
              "NESTLE" = "Nestle",
              "SNICKERS" = "Snickers",
              "TWIX" = "Twix",
              "TOMS" = "Toms",
            #Tobacco
              "BIC"="Bic",
              "BLEND"="Blend",
              "CAMEL"="Camel",
              "CRICKET" = "Cricket",
              "GÃ–TEBORGS" = "GÃ¶teborgs",
              "GÃ¶teborgs" = "Gateborgs",
              "GENERAL" = "General",
              "JOHN SILVER" = "John Silver",
              "KALIBER"="Kaliber",
              "LEVEL" = "Level",
              "MARLBORO"="Marlboro",
              "PRINCE"="Prince",
              "RIGHT" = "Right",
              "WINSTON" = "Winston",
            #Toiletries
              "EKULF"="Ekulf",
              "JORDAN"="Jordan",
              "LISTERINE"="Listerine",
              "PEPSODENT" = "Pepsodent",
              "SENSODYNE" = "Sensodyne",
            #yogurt
              "ARLA KO"="Arla Ko",
              "FjÃ¤llyoghurt"="FjÃ¤llfil"
              ))
```



```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df_offline[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```

#Function of filtering brand

```{r define function for filtering brand with complete (153) observations}
brandfiltering_format <- function(df,format,category,nweek){
  df_format_category <- df[df$category == category & df$format == format,]
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand=droplevels(brand))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand)
message(paste("# of remaining brands for",category,"in",format,":", dim(brandcompleteweek)[1],"(from",length(unique(df_format_category$brand)),")"))

df_format_category_complete <- df_format_category[df_format_category$brand %in% brandcompleteweek$brand, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand=droplevels(brand))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]
message(paste("% of obs. maintain:", (nobsafterdrop/nobsbeforedrop)*100))

return(df_format_category_complete)
}
```

#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar <- function(df){
  
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign)), .(vecka,brand,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info


distinctbrandcomplete <- unique(df$brand)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 19 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dlognondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))


return(df_bybrand)
}

```



#Function of testing nonlinearity

This function returns p-value for likelihood ratio test when non-linearity term (or quadratic term) is added and conclusion whether which fuction should be performed. 


However, we still need to create another function that skip some lm in case of all brands have significant discount parameters and vice versa (LATER).

```{r}

test_nonlinearity_onlyfinalprice <- function(aggregate_df){
  
  distinctbrand_finalprice <- unique(aggregate_df$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  
   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 5 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){  
  
lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])


lm_finalprice_priceprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1)+ trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])

lm_finalprice_compgap <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign + pricecampaign + log(totalvolume1) + log(LL1) +log(avgfinalprice1)+ trend + holiday ,data=aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],])

test_price1 <-lrtest(lm_finalprice, lm_finalprice_priceprice)
test_price2 <-lrtest(lm_finalprice, lm_finalprice_compgap)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_price1$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_price2$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = summary(lm_finalprice)$coefficients[3,1]
df_finalprice_lr[i,5] = summary(lm_finalprice)$coefficients[3,2]
}  
  
colnames(df_finalprice_lr) <- c('brand','p-value-pricehist','p-value-pricecom','Coef Price','Sd Price')


return(df_finalprice_lr)
  
}
```


#Function for testing source of non-linearity

This function returns p-value for likelihood ratio test when HBP/D (historical benchmark price/discount) and CBP/D (competitive benchmark price/discount) are added.


However, we still need to create another function that skip some lm in case of all brands have only one type of nonlinearity.

```{r}
test_sourceofnonlinearity_onlyfinal <- function(aggregate_df,nonlinearity_result){
  
  df_merge_result <- merge(aggregate_df,nonlinearity_result, by=c("brand"))
  
  df_finalprice <- df_merge_result[df_merge_result$nonlinearitydecision == 'finalpricenonlinearity', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  df_finalprice$hbp <- log(df_finalprice$avgfinalprice)-log(df_finalprice$avgfinalprice1)
  df_finalprice$cbp <- (df_finalprice$avgfinalprice - df_finalprice$avgcompfinalprice)/df_finalprice$avgfinalprice

   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){

lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_cbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbpcbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])


test_hbp<-lrtest(lm_finalprice, lm_finalprice_hbp)
test_cbp<-lrtest(lm_finalprice, lm_finalprice_cbp)
test_hbpcbp<-lrtest(lm_finalprice, lm_finalprice_hbpcbp)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_hbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_cbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = round(test_hbpcbp$`Pr(>Chisq)`[2],4)
}  
  
df_sourcenonlinearity_test <- df_finalprice_lr
colnames(df_sourcenonlinearity_test) <- c('brand','p-value-hbp','p-value-cbp','p-value-hbp&cbp')

return(df_sourcenonlinearity_test)
  
}

df_7 <- test_sourceofnonlinearity_onlyfinal(aggregate_df = df_chips_super, nonlinearity_result = nonlinear_test_chips_super)

test_sourceofnonlinearity_onlypricebefore<- function(aggregate_df,nonlinearity_result){
  
  df_merge_result <- merge(aggregate_df,nonlinearity_result, by=c("brand"))
  
  df_pricebefore <- df_merge_result[df_merge_result$nonlinearitydecision == 'pricebeforenonlinearity', ]
  df_finalprice <- df_finalprice %>% mutate(brand=droplevels(brand))
  distinctbrand_finalprice <- unique(df_finalprice$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  df_finalprice$hbp <- log(df_finalprice$avgfinalprice)-log(df_finalprice$avgfinalprice1)
  df_finalprice$cbp <- (df_finalprice$avgfinalprice - df_finalprice$avgcompfinalprice)/df_finalprice$avgfinalprice

   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 4 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){

lm_finalprice <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + dlogavgcompLL + dlogavgcompfinalprice  + nonpricecampaign log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_cbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])

lm_finalprice_hbpcbp <- lm(dlogtotalvolume ~ dlogLL + dlogavgfinalprice + (dlogavgfinalprice*hbp) + (dlogavgfinalprice*cbp) + dlogavgcompLL + dlogavgcompfinalprice  + log(totalvolume1) + log(LL1) +log(avgfinalprice1) + holiday ,data=df_finalprice[df_finalprice$brand == distinctbrand_finalprice[i],])



test_hbp<-lrtest(lm_finalprice, lm_finalprice_hbp)
test_cbp<-lrtest(lm_finalprice, lm_finalprice_cbp)
test_hbpcbp<-lrtest(lm_finalprice, lm_finalprice_hbpcbp)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_hbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_cbp$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = round(test_hbpcbp$`Pr(>Chisq)`[2],4)
}  
df_sourcenonlinearity_test <- df_finalprice_lr
colnames(df_sourcenonlinearity_test) <- c('brand','p-value-hbp','p-value-cbp','p-value-hbp&cbp')

return(df_sourcenonlinearity_test)
  
}


test_sourceofnonlinearity_onlypricebeforeanddiscount


test_sourceofnonlinearity_finaldiscount
test_sourceofnonlinearity_finalpricebefore 



test_sourceofnonlinearity_finaldiscountpricebefore


```


#Empirical Test for nonlinearity
```{r Bottled Water}
#Get seperate dataframe
bottledwater_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Bottled water",nweek=153)
bottledwater_super <- brandfiltering_format(df,format = "supermarket",category ="Bottled water",nweek=153)
bottledwater_conve <- brandfiltering_format(df,format = "convenience",category ="Bottled water",nweek=153)

#Create aggregate dataframe
df_bottledwater_hyper <- genrelevantvar(df=bottledwater_hyper)
df_bottledwater_super <- genrelevantvar(df=bottledwater_super)
df_bottledwater_conve <- genrelevantvar(df=bottledwater_conve)

#test discount coefficient
nonlinear_test_bottledwater_hyper <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_hyper)
nonlinear_test_bottledwater_super <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_super)
nonlinear_test_bottledwater_conve <- test_nonlinearity_onlyfinalprice(aggregate_df = df_bottledwater_conve)

#test nonlinearity
nonlinear_test_bottledwater_hyper <- test_nonlinearity_onlydiscount(aggregate_df = df_bottledwater_hyper,discount_coef_result = discount_test_bottledwater_hyper)
nonlinear_test_bottledwater_super <- test_nonlinearity_both(aggregate_df = df_bottledwater_super,discount_coef_result = discount_test_bottledwater_super)
nonlinear_test_bottledwater_conve <- test_nonlinearity_both(aggregate_df = df_bottledwater_conve,discount_coef_result = discount_test_bottledwater_conve)

#conclude nonlinearitytest
nonlinear_test_bottledwater_hyper$format <- "hypermarket"
nonlinear_test_bottledwater_super$format <- "supermarket"
nonlinear_test_bottledwater_conve$format <- "convenience"
nonlinearity_bottledwater_result <- rbind(nonlinear_test_bottledwater_hyper[,-(2:5)],nonlinear_test_bottledwater_super[,-(2:5)],nonlinear_test_bottledwater_conve[,-(2:5)])

#test source of nonlinearity
```


```{r Baking ingredients}
#Get seperate dataframe
bakingingredient_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Baking ingredients",nweek=153)
bakingingredient_super <- brandfiltering_format(df,format = "supermarket",category ="Baking ingredients",nweek=153)
bakingingredient_conve <- brandfiltering_format(df,format = "convenience",category ="Baking ingredients",nweek=153)

#Too few observation left
```

```{r Bathproduct}
#Get seperate dataframe
bathproduct_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Bath Products",nweek=153)
bathproduct_super <- brandfiltering_format(df,format = "supermarket",category ="Bath Products",nweek=153)
bathproduct_conve <- brandfiltering_format(df,format = "convenience",category ="Bath Products",nweek=153)

#Too few observation left
```

```{r Biscuits}
#Get seperate dataframe
biscuits_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Biscuits",nweek=153)
biscuits_super <- brandfiltering_format(df,format = "supermarket",category ="Biscuits",nweek=153)
biscuits_conve <- brandfiltering_format(df,format = "convenience",category ="Biscuits",nweek=153)

#Too few observation left
```

```{r Butter}
#Get seperate dataframe
butter_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Butter",nweek=153)
butter_super <- brandfiltering_format(df,format = "supermarket",category ="Butter",nweek=153)
butter_conve <- brandfiltering_format(df,format = "convenience",category ="Butter",nweek=153)

#Create aggregate dataframe
df_butter_hyper <- genrelevantvar(df=butter_hyper)
df_butter_super <- genrelevantvar(df=butter_super)
df_butter_conve <- genrelevantvar(df=butter_conve)

#test discount coefficient
discount_test_butter_hyper <- test_discount_coef(aggregate_df = df_butter_hyper)
discount_test_butter_super <- test_discount_coef(aggregate_df = df_butter_super)
discount_test_butter_conve <- test_discount_coef(aggregate_df = df_butter_conve)

#test nonlinearity
nonlinear_test_butter_hyper <- test_nonlinearity_both(aggregate_df = df_butter_hyper,discount_coef_result = discount_test_butter_hyper)
nonlinear_test_butter_super <- test_nonlinearity_both(aggregate_df = df_butter_super,discount_coef_result = discount_test_butter_super)
nonlinear_test_butter_conve <- test_nonlinearity_both(aggregate_df = df_butter_conve,discount_coef_result = discount_test_butter_conve)

#conclude nonlinearitytest
nonlinear_test_butter_hyper$format <- "hypermarket"
nonlinear_test_butter_super$format <- "supermarket"
nonlinear_test_butter_conve$format <- "convenience"
nonlinearity_butter_result <- rbind(nonlinear_test_butter_hyper[,-(2:5)],nonlinear_test_butter_super[,-(2:5)],nonlinear_test_butter_conve[,-(2:5)])
```

```{r CannedSoup}
#Get seperate dataframe
cannedsoup_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Canned soup",nweek=153)
cannedsoup_super <- brandfiltering_format(df,format = "supermarket",category ="Canned soup",nweek=153)
cannedsoup_conve <- brandfiltering_format(df,format = "convenience",category ="Canned soup",nweek=153)

#Too few observation left
```

```{r CannedVegg}
#Get seperate dataframe
cannedvegg_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Canned vegetables",nweek=153)
cannedvegg_super <- brandfiltering_format(df,format = "supermarket",category ="Canned vegetables",nweek=153)
cannedvegg_conve <- brandfiltering_format(df,format = "convenience",category ="Canned vegetables",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cannedvegg_hyper <- genrelevantvar(df=cannedvegg_hyper)
df_cannedvegg_super <- genrelevantvar(df=cannedvegg_super)

#test discount coefficient
discount_test_cannedvegg_hyper <- test_discount_coef(aggregate_df = df_cannedvegg_hyper)
discount_test_cannedvegg_super <- test_discount_coef(aggregate_df = df_cannedvegg_super)

#test nonlinearity
nonlinear_test_cannedvegg_hyper <- test_nonlinearity_both(aggregate_df = df_cannedvegg_hyper,discount_coef_result = discount_test_cannedvegg_hyper)
nonlinear_test_cannedvegg_super <- test_nonlinearity_both(aggregate_df = df_cannedvegg_super,discount_coef_result = discount_test_cannedvegg_super)

#conclude nonlinearitytest
nonlinear_test_cannedvegg_hyper$format <- "hypermarket"
nonlinear_test_cannedvegg_super$format <- "supermarket"
nonlinearity_cannedvegg_result <- rbind(nonlinear_test_cannedvegg_hyper[,-(2:5)],nonlinear_test_cannedvegg_super[,-(2:5)])
```

```{r Cereal}
#Get seperate dataframe
cereal_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cereals",nweek=153)
cereal_super <- brandfiltering_format(df,format = "supermarket",category ="Cereals",nweek=153)
cereal_conve <- brandfiltering_format(df,format = "convenience",category ="Cereals",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cereal_hyper <- genrelevantvar(df=cereal_hyper)
df_cereal_super <- genrelevantvar(df=cereal_super)

#test discount coefficient
discount_test_cereal_hyper <- test_discount_coef(aggregate_df = df_cereal_hyper)
discount_test_cereal_super <- test_discount_coef(aggregate_df = df_cereal_super)

#test nonlinearity
nonlinear_test_cereal_hyper <- test_nonlinearity_both(aggregate_df = df_cereal_hyper,discount_coef_result = discount_test_cereal_hyper)
nonlinear_test_cereal_super <- test_nonlinearity_both(aggregate_df = df_cereal_super,discount_coef_result = discount_test_cereal_super)

#conclude nonlinearitytest
nonlinear_test_cereal_hyper$format <- "hypermarket"
nonlinear_test_cereal_super$format <- "supermarket"
nonlinearity_cereal_result <- rbind(nonlinear_test_cereal_hyper[,-(2:5)],nonlinear_test_cereal_super[,-(2:5)])
```
```{r Chips}
#Get seperate dataframe
chips_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153)
chips_super <- brandfiltering_format(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153)
chips_conve <- brandfiltering_format(df,format = "convenience",category ="Chips & Salty snacks",nweek=153)

#Create aggregate dataframe
df_chips_hyper <- genrelevantvar(df=chips_hyper)
df_chips_super <- genrelevantvar(df=chips_super)
df_chips_conve <- genrelevantvar(df=chips_conve)

#test discount coefficient
discount_test_chips_hyper <- test_discount_coef(aggregate_df = df_chips_hyper)
discount_test_chips_super <- test_discount_coef(aggregate_df = df_chips_super)
discount_test_chips_conve <- test_discount_coef(aggregate_df = df_chips_conve)

#test nonlinearity
nonlinear_test_chips_hyper <- test_nonlinearity_both(aggregate_df = df_chips_hyper,discount_coef_result = discount_test_chips_hyper)
nonlinear_test_chips_super <- test_nonlinearity_both(aggregate_df = df_chips_super,discount_coef_result = discount_test_chips_super)
nonlinear_test_chips_conve <- test_nonlinearity_both(aggregate_df = df_chips_conve,discount_coef_result = discount_test_chips_conve)

#conclude nonlinearitytest
nonlinear_test_chips_hyper$format <- "hypermarket"
nonlinear_test_chips_super$format <- "supermarket"
nonlinear_test_chips_conve$format <- "convenience"
nonlinearity_chips_result <- rbind(nonlinear_test_chips_hyper[,-(2:5)],nonlinear_test_chips_super[,-(2:5)],nonlinear_test_chips_conve[,-(2:5)])
```

```{r Chocolate}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chocolate",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Chocolate",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Chocolate",nweek=153)

#Create aggregate dataframe
df_choco_hyper <- genrelevantvar(df=choco_hyper)
df_choco_super <- genrelevantvar(df=choco_super)
df_choco_conve <- genrelevantvar(df=choco_conve)

#test discount coefficient
discount_test_choco_hyper <- test_discount_coef(aggregate_df = df_choco_hyper)
discount_test_choco_super <- test_discount_coef(aggregate_df = df_choco_super)
discount_test_choco_conve <- test_discount_coef(aggregate_df = df_choco_conve)

#test nonlinearity
nonlinear_test_choco_hyper <- test_nonlinearity_both(aggregate_df = df_choco_hyper,discount_coef_result = discount_test_choco_hyper)
nonlinear_test_choco_super <- test_nonlinearity_both(aggregate_df = df_choco_super,discount_coef_result = discount_test_choco_super)
nonlinear_test_choco_conve <- test_nonlinearity_both(aggregate_df = df_choco_conve,discount_coef_result = discount_test_choco_conve)

#conclude nonlinearitytest
nonlinear_test_choco_hyper$format <- "hypermarket"
nonlinear_test_choco_super$format <- "supermarket"
nonlinear_test_choco_conve$format <- "convenience"
nonlinearity_choco_result <- rbind(nonlinear_test_choco_hyper[,-(2:5)],nonlinear_test_choco_super[,-(2:5)],nonlinear_test_choco_conve[,-(2:5)])
```

```{r Cleaningproducts}
#Get seperate dataframe
cleaningprod_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cleaning products",nweek=153)
cleaningprod_super <- brandfiltering_format(df,format = "supermarket",category ="Cleaning products",nweek=153)
cleaningprod_conve <- brandfiltering_format(df,format = "convenience",category ="Cleaning products",nweek=153)

#Too few observation left
```


```{r Coffee}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Coffee",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Coffee",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Coffee",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Cookie}
#Get seperate dataframe
cookie_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cookies",nweek=153)
cookie_super <- brandfiltering_format(df,format = "supermarket",category ="Cookies",nweek=153)
cookie_conve <- brandfiltering_format(df,format = "convenience",category ="Cookies",nweek=153)

#Too few observation left
```

```{r Cream}
#Get seperate dataframe
cream_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Cream",nweek=153)
cream_super <- brandfiltering_format(df,format = "supermarket",category ="Cream",nweek=153)
cream_conve <- brandfiltering_format(df,format = "convenience",category ="Cream",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_cream_hyper <- genrelevantvar(df=cream_hyper)
df_cream_super <- genrelevantvar(df=cream_super)

#test discount coefficient
discount_test_cream_hyper <- test_discount_coef(aggregate_df = df_cream_hyper)
discount_test_cream_super <- test_discount_coef(aggregate_df = df_cream_super)

#test nonlinearity
nonlinear_test_cream_hyper <- test_nonlinearity_both(aggregate_df = df_cream_hyper,discount_coef_result = discount_test_cream_hyper)
nonlinear_test_cream_super <- test_nonlinearity_both(aggregate_df = df_cream_super,discount_coef_result = discount_test_cream_super)

#conclude nonlinearitytest
nonlinear_test_cream_hyper$format <- "hypermarket"
nonlinear_test_cream_super$format <- "supermarket"
nonlinearity_cream_result <- rbind(nonlinear_test_cream_hyper[,-(2:5)],nonlinear_test_cream_super[,-(2:5)])
```

```{r washingproducts}
#Get seperate dataframe
dishandwashing_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Dishwasher & washing up",nweek=153)
dishandwashing_super <- brandfiltering_format(df,format = "supermarket",category ="Dishwasher & washing up",nweek=153)
dishandwashing_conve <- brandfiltering_format(df,format = "convenience",category ="Dishwasher & washing up",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r frozenpizza}
#Get seperate dataframe
frozenpizza_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Frozen Pizza Snacks",nweek=153)
frozenpizza_super <- brandfiltering_format(df,format = "supermarket",category ="Frozen Pizza Snacks",nweek=153)
frozenpizza_conve <- brandfiltering_format(df,format = "convenience",category ="Frozen Pizza Snacks",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r fruit juice}
#Get seperate dataframe
juice_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Fruit Juice",nweek=153)
juice_super <- brandfiltering_format(df,format = "supermarket",category ="Fruit Juice",nweek=153)
juice_conve <- brandfiltering_format(df,format = "convenience",category ="Fruit Juice",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r household utensilts}
#Get seperate dataframe
hhutensils_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Household utensils",nweek=153)
hhutensils_super <- brandfiltering_format(df,format = "supermarket",category ="Household utensils",nweek=153)
hhutensils_conve <- brandfiltering_format(df,format = "convenience",category ="Household utensils",nweek=153)

#We don't even have a household utensils purchased in these three stores
```

```{r ice cream}
#Get seperate dataframe
icecream_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Ice cream",nweek=153)
icecream_super <- brandfiltering_format(df,format = "supermarket",category ="Ice cream",nweek=153)
icecream_conve <- brandfiltering_format(df,format = "convenience",category ="Ice cream",nweek=153)

#Only supermarket pass the criteria. What should we do?
```

```{r Jam}
#Get seperate dataframe
jam_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Jam",nweek=153)
jam_super <- brandfiltering_format(df,format = "supermarket",category ="Jam",nweek=153)
jam_conve <- brandfiltering_format(df,format = "convenience",category ="Jam",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Lactose Free}
#Get seperate dataframe
lactosefree_hyper <- brandfiltering_format(df,format = "hypermarket",category ="LactoseFree",nweek=153)
lactosefree_super <- brandfiltering_format(df,format = "supermarket",category ="LactoseFree",nweek=153)
lactosefree_conve <- brandfiltering_format(df,format = "convenience",category ="LactoseFree",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_lactosefree_hyper <- genrelevantvar(df=lactosefree_hyper)
df_lactosefree_super <- genrelevantvar(df=lactosefree_super)

#test discount coefficient
discount_test_lactosefree_hyper <- test_discount_coef(aggregate_df = df_lactosefree_hyper)
discount_test_lactosefree_super <- test_discount_coef(aggregate_df = df_lactosefree_super)

#test nonlinearity
nonlinear_test_lactosefree_hyper <- test_nonlinearity_both(aggregate_df = df_lactosefree_hyper,discount_coef_result = discount_test_lactosefree_hyper)
nonlinear_test_lactosefree_super <- test_nonlinearity_both(aggregate_df = df_lactosefree_super,discount_coef_result = discount_test_lactosefree_super)

#conclude nonlinearitytest
nonlinear_test_lactosefree_hyper$format <- "hypermarket"
nonlinear_test_lactosefree_super$format <- "supermarket"
nonlinearity_lactosefree_result <- rbind(nonlinear_test_lactosefree_hyper[,-(2:5)],nonlinear_test_lactosefree_super[,-(2:5)])
```

```{r Laundry}
#Get seperate dataframe
laundry_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Laundry",nweek=153)
laundry_super <- brandfiltering_format(df,format = "supermarket",category ="Laundry",nweek=153)
laundry_conve <- brandfiltering_format(df,format = "convenience",category ="Laundry",nweek=153)

#Only hypermarket pass the criteria. What should we do?
```

```{r Milk}
#Get seperate dataframe
milk_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Milk",nweek=153)
milk_super <- brandfiltering_format(df,format = "supermarket",category ="Milk",nweek=153)
milk_conve <- brandfiltering_format(df,format = "convenience",category ="Milk",nweek=153)

#Too few observation left
```
```{r Pasta}
#Get seperate dataframe
pasta_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Pasta",nweek=153)
pasta_super <- brandfiltering_format(df,format = "supermarket",category ="Pasta",nweek=153)
pasta_conve <- brandfiltering_format(df,format = "convenience",category ="Pasta",nweek=153)

#We can run for convenience and hypermarket
#Create aggregate dataframe
df_pasta_hyper <- genrelevantvar(df=pasta_hyper)
df_pasta_conve <- genrelevantvar(df=pasta_conve)

#test discount coefficient
discount_test_pasta_hyper <- test_discount_coef(aggregate_df = df_pasta_hyper)
discount_test_pasta_conve <- test_discount_coef(aggregate_df = df_pasta_conve)

#test nonlinearity
nonlinear_test_pasta_hyper <- test_nonlinearity_both(aggregate_df = df_pasta_hyper,discount_coef_result = discount_test_pasta_hyper)
nonlinear_test_pasta_conve <- test_nonlinearity_both(aggregate_df = df_pasta_conve,discount_coef_result = discount_test_pasta_conve)

#conclude nonlinearitytest
nonlinear_test_pasta_hyper$format <- "hypermarket"
nonlinear_test_pasta_conve$format <- "conveniencestore"
nonlinearity_pasta_result <- rbind(nonlinear_test_pasta_hyper[,-(2:5)],nonlinear_test_pasta_conve[,-(2:5)])
```

```{r Pastry}
#Get seperate dataframe
pastry_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Pastry",nweek=153)
pastry_super <- brandfiltering_format(df,format = "supermarket",category ="Pastry",nweek=153)
pastry_conve <- brandfiltering_format(df,format = "convenience",category ="Pastry",nweek=153)

#Too few observation left
```
```{r Readymade Meal}
#Get seperate dataframe
readymademeal_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Ready-made meals",nweek=153)
readymademeal_super <- brandfiltering_format(df,format = "supermarket",category ="Ready-made meals",nweek=153)
readymademeal_conve <- brandfiltering_format(df,format = "convenience",category ="Ready-made meals",nweek=153)

#Too few observation left
```
```{r Rice}
#Get seperate dataframe
rice_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Rice",nweek=153)
rice_super <- brandfiltering_format(df,format = "supermarket",category ="Rice",nweek=153)
rice_conve <- brandfiltering_format(df,format = "convenience",category ="Rice",nweek=153)

#Only Hypermarket pass the criteria (super almost!)
```
```{r Seasoning}
#Get seperate dataframe
seasoning_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Seasoning",nweek=153)
seasoning_super <- brandfiltering_format(df,format = "supermarket",category ="Seasoning",nweek=153)
seasoning_conve <- brandfiltering_format(df,format = "convenience",category ="Seasoning",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_seasoning_hyper <- genrelevantvar(df=seasoning_hyper)
df_seasoning_super <- genrelevantvar(df=seasoning_super)

#test discount coefficient
discount_test_seasoning_hyper <- test_discount_coef(aggregate_df = df_seasoning_hyper)
discount_test_seasoning_super <- test_discount_coef(aggregate_df = df_seasoning_super)

#test nonlinearity
nonlinear_test_seasoning_hyper <- test_nonlinearity_both(aggregate_df = df_seasoning_hyper,discount_coef_result = discount_test_seasoning_hyper)
nonlinear_test_seasoning_super <- test_nonlinearity_both(aggregate_df = df_seasoning_super,discount_coef_result = discount_test_seasoning_super)

#conclude nonlinearitytest
nonlinear_test_seasoning_hyper$format <- "hypermarket"
nonlinear_test_seasoning_super$format <- "supermarket"
nonlinearity_seasoning_result <- rbind(nonlinear_test_seasoning_hyper[,-(2:5)],nonlinear_test_seasoning_super[,-(2:5)])
```
```{r Softdrink}
#Get seperate dataframe
softdrink_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Soft drinks",nweek=153)
softdrink_super <- brandfiltering_format(df,format = "supermarket",category ="Soft drinks",nweek=153)
softdrink_conve <- brandfiltering_format(df,format = "convenience",category ="Soft drinks",nweek=153)

#Too few observation left
```

```{r Sweets and candies}
#Get seperate dataframe
sweets_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Sweets & Candy",nweek=153)
sweets_super <- brandfiltering_format(df,format = "supermarket",category ="Sweets & Candy",nweek=153)
sweets_conve <- brandfiltering_format(df,format = "convenience",category ="Sweets & Candy",nweek=153)

#Too few observation left
```

```{r Tobacco}
#Get seperate dataframe
tobacco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Tobacco",nweek=153)
tobacco_super <- brandfiltering_format(df,format = "supermarket",category ="Tobacco",nweek=153)
tobacco_conve <- brandfiltering_format(df,format = "convenience",category ="Tobacco",nweek=153)

#Too few observation left
```

```{r Tobacco}
#Get seperate dataframe
toiletpaper_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Toilet tissue",nweek=153)
toiletpaper_super <- brandfiltering_format(df,format = "supermarket",category ="Toilet tissue",nweek=153)
toiletpaper_conve <- brandfiltering_format(df,format = "convenience",category ="Toilet tissue",nweek=153)

#We can run for supermarket and hypermarket
#Create aggregate dataframe
df_toiletpaper_hyper <- genrelevantvar(df=toiletpaper_hyper)
df_toiletpaper_super <- genrelevantvar(df=toiletpaper_super)

#test discount coefficient
discount_test_toiletpaper_hyper <- test_discount_coef(aggregate_df = df_toiletpaper_hyper)
discount_test_toiletpaper_super <- test_discount_coef(aggregate_df = df_toiletpaper_super)

#test nonlinearity
nonlinear_test_toiletpaper_hyper <- test_nonlinearity_both(aggregate_df = df_toiletpaper_hyper,discount_coef_result = discount_test_toiletpaper_hyper)
nonlinear_test_toiletpaper_super <- test_nonlinearity_both(aggregate_df = df_toiletpaper_super,discount_coef_result = discount_test_toiletpaper_super)

#conclude nonlinearitytest
nonlinear_test_toiletpaper_hyper$format <- "hypermarket"
nonlinear_test_toiletpaper_super$format <- "supermarket"
nonlinearity_toiletpaper_result <- rbind(nonlinear_test_toiletpaper_hyper[,-(2:5)],nonlinear_test_toiletpaper_super[,-(2:5)])
```

```{r Toiletries}
#Get seperate dataframe
toiletries_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Toiletries",nweek=153)
toiletries_super <- brandfiltering_format(df,format = "supermarket",category ="Toiletries",nweek=153)
toiletries_conve <- brandfiltering_format(df,format = "convenience",category ="Toiletries",nweek=153)

#Only Hypermarket pass the criteria (super almost!)
```

```{r Yoghurt}
#Get seperate dataframe
yoghurt_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Yogurt",nweek=153)
yoghurt_super <- brandfiltering_format(df,format = "supermarket",category ="Yogurt",nweek=153)
yoghurt_conve <- brandfiltering_format(df,format = "convenience",category ="Yogurt",nweek=153)

#We can run for supermarket and hypermarket (Almost for convenience, 74.06%)
#Create aggregate dataframe
df_yoghurt_hyper <- genrelevantvar(df=yoghurt_hyper)
df_yoghurt_super <- genrelevantvar(df=yoghurt_super)

#test discount coefficient
discount_test_yoghurt_hyper <- test_discount_coef(aggregate_df = df_yoghurt_hyper)
discount_test_yoghurt_super <- test_discount_coef(aggregate_df = df_yoghurt_super)

#test nonlinearity
nonlinear_test_yoghurt_hyper <- test_nonlinearity_both(aggregate_df = df_yoghurt_hyper,discount_coef_result = discount_test_yoghurt_hyper)
nonlinear_test_yoghurt_super <- test_nonlinearity_both(aggregate_df = df_yoghurt_super,discount_coef_result = discount_test_yoghurt_super)

#conclude nonlinearitytest
nonlinear_test_yoghurt_hyper$format <- "hypermarket"
nonlinear_test_yoghurt_super$format <- "supermarket"
nonlinearity_yoghurt_result <- rbind(nonlinear_test_yoghurt_hyper[,-(2:5)],nonlinear_test_yoghurt_super[,-(2:5)])
```

```{r preliminary result}
Prelim_table<- rbind(nonlinearity_bottledwater_result,nonlinearity_butter_result,nonlinearity_cannedvegg_result,nonlinearity_cereal_result,nonlinearity_chips_result,nonlinearity_choco_result,nonlinearity_cream_result,nonlinearity_lactosefree_result,nonlinearity_pasta_result,nonlinearity_seasoning_result,nonlinearity_toiletpaper_result,nonlinearity_yoghurt_result)

```

