---
title: "Managebrandandcategorydata for (aggregate model) discount loss threshold"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(dplyr) #for mutate factor level of brand
library(data.table) #for set DT checking brand
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_discount_threshold.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```


```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```


#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar_perSKU`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

genrelevantvar_perSKU <- function(df,format,category){
  df <- df[df$category == category & df$format == format,]
  
  
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalvolume=sum(sales_volume),LL=uniqueN(produkt_id),avgpricebefore=mean(pricebeforeperunit),avgfinalprice=mean(finalpriceperunit),avgdiscount=mean(discountperunit),totalcampaign=.N,totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand_PLNB,format)] #this will return n brand x 3 formats x 153 weeks

weeklysalesbybrand_PL <- weeklysalesbybrand[weeklysalesbybrand$brand_PLNB == "PL",]
weeklysalesbybrand_NB <- weeklysalesbybrand[weeklysalesbybrand$brand_PLNB == "NB",]

#choose NB price as comp price
colnames(weeklysalesbybrand_NB)[colnames(weeklysalesbybrand_NB) == "avgfinalprice"] ="avgcompfinalprice"
relevant_NB <- weeklysalesbybrand_NB[,c("vecka","avgcompfinalprice")]

df_bybrand <- merge(weeklysalesbybrand_PL,relevant_NB, by=c("vecka"))

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#Campaign
df_bybrand$pricecampaignintensity <- ((df_bybrand$totalpricecampaign/df_bybrand$totalcampaign)*100)

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand_PLNB,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgcompfinalprice, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$pricecampaignintensity1 <- ave(df_bybrand$pricecampaignintensity, df_bybrand$brand_PLNB, FUN= lag_1)
df_bybrand$logavgdiscount <- log(df_bybrand$avgdiscount+1)
df_bybrand$logavgdiscount1 <- ave(df_bybrand$logavgdiscount, df_bybrand$brand_PLNB, FUN= lag_1)

#create the first difference of (log) variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dtotalvolume <- (df_bybrand$totalvolume)-(df_bybrand$totalvolume1)
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$davgfinalprice <- (df_bybrand$avgfinalprice)-(df_bybrand$avgfinalprice1)
df_bybrand$davgpricebefore <- (df_bybrand$avgpricebefore)-(df_bybrand$avgpricebefore1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$davgcompfinalprice = (df_bybrand$avgcompfinalprice) - (df_bybrand$avgcompfinalprice1)
df_bybrand$davgdiscount <- (df_bybrand$avgdiscount)-(df_bybrand$avgdiscount1)
df_bybrand$dlogavgdiscount <- log(df_bybrand$avgdiscount+1)-log(df_bybrand$avgdiscount1+1)
df_bybrand$dnondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlognondepth <- log(df_bybrand$nondepth)-log(df_bybrand$nondepth1)
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)
df_bybrand$dpricecampaignintensity = df_bybrand$pricecampaignintensity - df_bybrand$pricecampaignintensity1


df_bybrand$logtotalvolume <- log(df_bybrand$totalvolume)
df_bybrand$logavgpricebefore <- log(df_bybrand$avgpricebefore)
df_bybrand$logavgcompfinalprice <- log(df_bybrand$avgcompfinalprice)
df_bybrand$logavgfinalprice <- log(df_bybrand$avgfinalprice)

#create copula
make_copula <- function(x) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-.0000001), qnorm(ecdf(x)(x))))}
#This functions transforms a variable (condition: non-normally distributed) to its copula-correction term which can be entered in model estimation. See Park and Gupta (2012, Marketing Science)
df_bybrand$cop_logavgpricebefore <- make_copula(log((df_bybrand$avgpricebefore)))
df_bybrand$cop_logdiscount <- make_copula(df_bybrand$logavgdiscount)
df_bybrand$cop_avgpricebefore <- make_copula((df_bybrand$avgpricebefore))
df_bybrand$cop_discount <- make_copula(df_bybrand$avgdiscount)
df_bybrand$cop_lognondepth<- make_copula(log(df_bybrand$nondepth))
df_bybrand$cop_logavgfinalprice<- make_copula(log(df_bybrand$avgfinalprice))

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand $vecka <- as.factor(df_bybrand$vecka)

df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))

#convert format back
df_bybrand$format <- format
df_bybrand$category <- category


return(df_bybrand)
}

```



#Prepare data for estimating aggregate
```{r}
baking_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Baking ingredients")
baking_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Baking ingredients")
baking_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Baking ingredients")

biscuit_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Biscuits")
biscuit_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Biscuits")
# biscuit_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Biscuits") #there are several weeks ICA is not sold in convenient store

butter_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Butter")
butter_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Butter")
butter_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Butter")

bottledwater_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Bottled water")
bottledwater_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Bottled water")
# bottledwater_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Bottled water") #there is one week ICA is not sold in convenient store

cereals_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Cereals")
cereals_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Cereals")
# cereals_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Cereals") #there is one week ICA is not sold in convenient store

chips_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Chips & Salty snacks")
chips_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Chips & Salty snacks")
chips_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Chips & Salty snacks")

coffee_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Coffee")
coffee_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Coffee")
#coffee_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Coffee") #there are several weeks ICA is not sold in convenient store

cookie_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Cookies")
cookie_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Cookies")
# cookie_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Cookies") #there is one week ICA is not sold in convenient store

cream_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Cream")
cream_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Cream")
cream_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Cream")

frozenpizz_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Frozen Pizza Snacks")
# frozenpizz_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store
# frozenpizz_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Frozen Pizza Snacks") #there are several weeks ICA is not sold in convenient store

juice_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Fruit Juice")
juice_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Fruit Juice")
# juice_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Fruit Juice") #there is one week ICA is not sold in convenient

icecream_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Ice cream")
icecream_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Ice cream")
# icecream_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Ice cream") #there are several weeks ICA is not sold in convenient store

jam_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Jam")
jam_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Jam")
jam_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Jam")

lactosefree_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="LactoseFree")
lactosefree_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="LactoseFree")
lactosefree_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="LactoseFree")

pastry_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Pastry")
pastry_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Pastry")
#pastry_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Pastry") #there are several weeks ICA is not sold in convenient store

readymeal_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Ready-made meals")
readymeal_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Ready-made meals")
readymeal_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Ready-made meals")

rice_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Rice")
rice_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Rice")
#rice_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Rice") #there are several weeks ICA is not sold in convenient store

seasoning_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Seasoning")
seasoning_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Seasoning")
#seasoning_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Seasoning") #there is one week ICA is not sold in convenient

softdrink_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Soft drinks")
softdrink_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Soft drinks")
#softdrink_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Soft drinks") #there is one week ICA is not sold in convenient

yoghurt_hyper_PL <- genrelevantvar_perSKU(df,format = "hypermarket",category ="Yogurt")
yoghurt_super_PL <- genrelevantvar_perSKU(df,format = "supermarket",category ="Yogurt")
yoghurt_conve_PL <- genrelevantvar_perSKU(df,format = "convenience",category ="Yogurt")
```

#Estimate Nonlinear Model
```{r eval=FALSE, include=FALSE}

baking_hyper_PL_est <- discountnonlinearest_PL(df = baking_hyper_PL)
baking_super_PL_est <- discountnonlinearest_PL(df = baking_super_PL)
baking_conve_PL_est <- discountnonlinearest_PL(df = baking_conve_PL)

biscuit_hyper_PL_est <- discountnonlinearest_PL(df = biscuit_hyper_PL)
biscuit_super_PL_est <- discountnonlinearest_PL(df = biscuit_super_PL)


butter_hyper_PL_est <- discountnonlinearest_PL(df = butter_hyper_PL)
butter_super_PL_est <- discountnonlinearest_PL(df = butter_super_PL)
butter_conve_PL_est <- discountnonlinearest_PL(df = butter_conve_PL)

bottledwater_hyper_PL_est <- discountnonlinearest_PL(df = bottledwater_hyper_PL)
bottledwater_super_PL_est <- discountnonlinearest_PL(df = bottledwater_super_PL)


cereals_hyper_PL_est <- discountnonlinearest_PL(df = cereals_hyper_PL)
cereals_super_PL_est <- discountnonlinearest_PL(df = cereals_super_PL)


chips_hyper_PL_est <- discountnonlinearest_PL(df = chips_hyper_PL)
chips_super_PL_est <- discountnonlinearest_PL(df = chips_super_PL)
chips_conve_PL_est <- discountnonlinearest_PL(df = chips_conve_PL)

coffee_hyper_PL_est <- discountnonlinearest_PL(df = coffee_hyper_PL)
coffee_super_PL_est <- discountnonlinearest_PL(df = coffee_super_PL)


cookie_hyper_PL_est <- discountnonlinearest_PL(df = cookie_hyper_PL)
cookie_super_PL_est <- discountnonlinearest_PL(df = cookie_super_PL)


cream_hyper_PL_est <- discountnonlinearest_PL(df = cream_hyper_PL)
cream_super_PL_est <- discountnonlinearest_PL(df = cream_super_PL)
cream_conve_PL_est <- discountnonlinearest_PL(df = cream_conve_PL)

frozenpizz_hyper_PL_est <- discountnonlinearest_PL(df = frozenpizz_hyper_PL)

juice_hyper_PL_est <- discountnonlinearest_PL(df = juice_hyper_PL)
juice_super_PL_est <- discountnonlinearest_PL(df = juice_super_PL)


icecream_hyper_PL_est <- discountnonlinearest_PL(df = icecream_hyper_PL)
icecream_super_PL_est <- discountnonlinearest_PL(df = icecream_super_PL)

jam_hyper_PL_est <- discountnonlinearest_PL(df = jam_hyper_PL)
jam_super_PL_est <- discountnonlinearest_PL(df = jam_super_PL)
jam_conve_PL_est <- discountnonlinearest_PL(df = jam_conve_PL)

lactosefree_hyper_PL_est <- discountnonlinearest_PL(df = lactosefree_hyper_PL)
lactosefree_super_PL_est <- discountnonlinearest_PL(df = lactosefree_super_PL)
lactosefree_conve_PL_est <- discountnonlinearest_PL(df = lactosefree_conve_PL)

pastry_hyper_PL_est <- discountnonlinearest_PL(df = pastry_hyper_PL)
pastry_super_PL_est <- discountnonlinearest_PL(df = pastry_super_PL)


readymeal_hyper_PL_est <- discountnonlinearest_PL(df = readymeal_hyper_PL)
readymeal_super_PL_est <- discountnonlinearest_PL(df = readymeal_super_PL)
readymeal_conve_PL_est <- discountnonlinearest_PL(df = readymeal_conve_PL)

rice_hyper_PL_est <- discountnonlinearest_PL(df = rice_hyper_PL)
rice_super_PL_est <- discountnonlinearest_PL(df = rice_super_PL)


seasoning_hyper_PL_est <- discountnonlinearest_PL(df = seasoning_hyper_PL)
seasoning_super_PL_est <- discountnonlinearest_PL(df = seasoning_super_PL)


softdrink_hyper_PL_est <- discountnonlinearest_PL(df = softdrink_hyper_PL)
softdrink_super_PL_est <- discountnonlinearest_PL(df = softdrink_super_PL)


yoghurt_hyper_PL_est <- discountnonlinearest_PL(df = yoghurt_hyper_PL)
yoghurt_super_PL_est <- discountnonlinearest_PL(df = yoghurt_super_PL)
yoghurt_conve_PL_est <- discountnonlinearest_PL(df = yoghurt_conve_PL)
```

```{r plot explore}
Combined_Dataset <- rbind(baking_hyper_PL,baking_super_PL,baking_conve_PL, 
                          biscuit_hyper_PL,biscuit_super_PL,
                          butter_hyper_PL,butter_super_PL,butter_conve_PL,
                          bottledwater_hyper_PL,bottledwater_super_PL,
                          cereals_hyper_PL,cereals_super_PL,
                          chips_hyper_PL,chips_super_PL,chips_conve_PL,
                          coffee_hyper_PL,coffee_super_PL,
                          cookie_hyper_PL,cookie_super_PL,
                          cream_hyper_PL,cream_super_PL,cream_conve_PL,
                          frozenpizz_hyper_PL,
                          juice_hyper_PL,juice_super_PL,
                          icecream_hyper_PL,icecream_super_PL,
                          jam_hyper_PL,jam_super_PL,jam_conve_PL,
                          lactosefree_hyper_PL,lactosefree_super_PL,lactosefree_conve_PL,
                          pastry_hyper_PL,pastry_super_PL,
                          readymeal_hyper_PL,readymeal_super_PL,readymeal_conve_PL,
                          rice_hyper_PL,rice_super_PL,
                          seasoning_hyper_PL,seasoning_super_PL,
                          softdrink_hyper_PL,softdrink_super_PL,
                          yoghurt_hyper_PL,yoghurt_super_PL,yoghurt_conve_PL)


Combined_Dataset_PL <- Combined_Dataset[Combined_Dataset$brand_PLNB == "PL",]



data_PL_hypermarket <- Combined_Dataset_PL[Combined_Dataset_PL$format == "hypermarket",]
distinctcategory_hyper <- unique(data_PL_hypermarket$category)
ncategory_hyper<-length(distinctcategory_hyper)

data_PL_supermarket <- Combined_Dataset_PL[Combined_Dataset_PL$format == "supermarket",]
distinctcategory_super <- unique(data_PL_supermarket$category)
ncategory_super<-length(distinctcategory_super)

data_PL_conve <- Combined_Dataset_PL[Combined_Dataset_PL$format == "convenience",]
distinctcategory_conve <- unique(data_PL_conve$category)
ncategory_conve<-length(distinctcategory_conve)

par(mfrow = c(3,2))
for (i in 1:length(distinctcategory_hyper)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],], main = paste("ICA Hypermarket",distinctcategory_hyper[i]), col="pink")
  hist(data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],]$dlogavgpricebefore,main = paste("ICA Hypermarket",distinctcategory_hyper[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_hypermarket[data_PL_hypermarket$category == distinctcategory_hyper[i],]$dlognondepth,main = paste("ICA Hypermarket",distinctcategory_hyper[i]),xlab = "dlognondepth")
}

for (i in 1:length(distinctcategory_super)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],], main = paste("ICA Supermarket",distinctcategory_super[i]), col="pink")
  hist(data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],]$dlogavgpricebefore,main = paste("ICA Supermarket",distinctcategory_super[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_supermarket[data_PL_supermarket$category == distinctcategory_super[i],]$dlognondepth,main = paste("ICA Supermarket",distinctcategory_super[i]),xlab = "dlognondepth")
}

for (i in 1:length(distinctcategory_conve)){
plot(dtotalvolume ~ davgpricebefore, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="blue")
  plot(dlogtotalvolume ~ dlogavgpricebefore, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="green")
plot(dtotalvolume ~ dnondepth, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="red")
  plot(dlogtotalvolume ~ dlognondepth, data=data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],], main = paste("ICA Convenience",distinctcategory_conve[i]), col="pink")
  hist(data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],]$dlogavgpricebefore,main = paste("ICA Convenience",distinctcategory_conve[i]),xlab = "dlogavgpricebefore")
  hist(data_PL_conve[data_PL_conve$category == distinctcategory_conve[i],]$dlognondepth,main = paste("ICA Convenience",distinctcategory_conve[i]),xlab = "dlognondepth")
}

```

#Estimate Nonlinear Model WITH LEVEL
```{r eval=FALSE, include=FALSE}

baking_hyper_PL_est <- discountnonlinearest_PL_leveldiscount(df = baking_hyper_PL)
baking_super_PL_est <- discountnonlinearest_PL_leveldiscount(df = baking_super_PL)
baking_conve_PL_est <- discountnonlinearest_PL_leveldiscount(df = baking_conve_PL)

biscuit_hyper_PL_est <- discountnonlinearest_PL_level(df = biscuit_hyper_PL)
biscuit_super_PL_est <- discountnonlinearest_PL_level(df = biscuit_super_PL)


butter_hyper_PL_est <- discountnonlinearest_PL_level(df = butter_hyper_PL)
butter_super_PL_est <- discountnonlinearest_PL_level(df = butter_super_PL)
butter_conve_PL_est <- discountnonlinearest_PL_level(df = butter_conve_PL)

bottledwater_hyper_PL_est <- discountnonlinearest_PL_level(df = bottledwater_hyper_PL)
#bottledwater_super_PL_est <- discountnonlinearest_PL_level(df = bottledwater_super_PL)


cereals_hyper_PL_est <- discountnonlinearest_PL_level(df = cereals_hyper_PL)
cereals_super_PL_est <- discountnonlinearest_PL_level(df = cereals_super_PL)


chips_hyper_PL_est <- discountnonlinearest_PL_level(df = chips_hyper_PL)
chips_super_PL_est <- discountnonlinearest_PL_level(df = chips_super_PL)
chips_conve_PL_est <- discountnonlinearest_PL_level(df = chips_conve_PL)

coffee_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = coffee_hyper_PL)
coffee_super_PL_est <- discountnonlinearest_PL_level_noprice(df = coffee_super_PL)


cookie_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = cookie_hyper_PL)
cookie_super_PL_est <- discountnonlinearest_PL_level_noprice(df = cookie_super_PL)


cream_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = cream_hyper_PL)
cream_super_PL_est <- discountnonlinearest_PL_level_noprice(df = cream_super_PL)
cream_conve_PL_est <- discountnonlinearest_PL_level_noprice(df = cream_conve_PL)

frozenpizz_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = frozenpizz_hyper_PL)

juice_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = juice_hyper_PL)
juice_super_PL_est <- discountnonlinearest_PL_level_noprice(df = juice_super_PL)


icecream_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = icecream_hyper_PL)
icecream_super_PL_est <- discountnonlinearest_PL_level_noprice(df = icecream_super_PL)

jam_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = jam_hyper_PL)
jam_super_PL_est <- discountnonlinearest_PL_level_noprice(df = jam_super_PL)
jam_conve_PL_est <- discountnonlinearest_PL_level_noprice(df = jam_conve_PL)

lactosefree_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = lactosefree_hyper_PL)
lactosefree_super_PL_est <- discountnonlinearest_PL_level_noprice(df = lactosefree_super_PL)
lactosefree_conve_PL_est <- discountnonlinearest_PL_level_noprice(df = lactosefree_conve_PL)

pastry_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = pastry_hyper_PL)
pastry_super_PL_est <- discountnonlinearest_PL_level_noprice(df = pastry_super_PL)


readymeal_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = readymeal_hyper_PL)
readymeal_super_PL_est <- discountnonlinearest_PL_level_noprice(df = readymeal_super_PL)
readymeal_conve_PL_est <- discountnonlinearest_PL_level_noprice(df = readymeal_conve_PL)

rice_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = rice_hyper_PL)
rice_super_PL_est <- discountnonlinearest_PL_level_noprice(df = rice_super_PL)


seasoning_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = seasoning_hyper_PL)
seasoning_super_PL_est <- discountnonlinearest_PL_level_noprice(df = seasoning_super_PL)


softdrink_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = softdrink_hyper_PL)
softdrink_super_PL_est <- discountnonlinearest_PL_level_noprice(df = softdrink_super_PL)


yoghurt_hyper_PL_est <- discountnonlinearest_PL_level_noprice(df = yoghurt_hyper_PL)
yoghurt_super_PL_est <- discountnonlinearest_PL_level_noprice(df = yoghurt_super_PL)
yoghurt_conve_PL_est <- discountnonlinearest_PL_level_noprice(df = yoghurt_conve_PL)
```

#Estimate Nonlinear Model ONLY FINAL PRICE
```{r eval=FALSE, include=FALSE}
 #Selected the relevant ones
#baking_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_hyper_PL)
#baking_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_super_PL)
#baking_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = baking_conve_PL)

biscuit_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = biscuit_hyper_PL)
biscuit_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = biscuit_super_PL)


butter_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_hyper_PL)
butter_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_super_PL)
butter_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = butter_conve_PL)

bottledwater_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = bottledwater_hyper_PL)
bottledwater_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = bottledwater_super_PL)


cereals_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cereals_hyper_PL)
cereals_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cereals_super_PL)


chips_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_hyper_PL)
chips_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_super_PL)
chips_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = chips_conve_PL)

coffee_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = coffee_hyper_PL)
coffee_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = coffee_super_PL)


cookie_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cookie_hyper_PL)
cookie_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cookie_super_PL)


cream_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_hyper_PL)
cream_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_super_PL)
cream_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = cream_conve_PL)

frozenpizz_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = frozenpizz_hyper_PL)

juice_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = juice_hyper_PL)
juice_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = juice_super_PL)


icecream_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = icecream_hyper_PL)
icecream_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = icecream_super_PL)

jam_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_hyper_PL)
jam_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_super_PL)
jam_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = jam_conve_PL)

lactosefree_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_hyper_PL)
lactosefree_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_super_PL)
lactosefree_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = lactosefree_conve_PL)

pastry_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = pastry_hyper_PL)
pastry_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = pastry_super_PL)


readymeal_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_hyper_PL)
readymeal_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_super_PL)
readymeal_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = readymeal_conve_PL)

rice_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = rice_hyper_PL)
rice_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = rice_super_PL)


seasoning_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = seasoning_hyper_PL)
seasoning_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = seasoning_super_PL)


softdrink_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = softdrink_hyper_PL)
softdrink_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = softdrink_super_PL)


yoghurt_hyper_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_hyper_PL)
yoghurt_super_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_super_PL)
yoghurt_conve_PL_est_discount <- discountnonlinearest_PL_nothreshold(df = yoghurt_conve_PL)
```

```{r eval=FALSE, include=FALSE}
baking_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_hyper_PL)
baking_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_super_PL)
baking_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = baking_conve_PL)

biscuit_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_hyper_PL)
biscuit_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = biscuit_super_PL)


butter_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_hyper_PL)
butter_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_super_PL)
butter_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = butter_conve_PL)

bottledwater_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_hyper_PL)
bottledwater_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = bottledwater_super_PL)


cereals_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_hyper_PL)
cereals_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cereals_super_PL)


chips_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_hyper_PL)
chips_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_super_PL)
chips_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = chips_conve_PL)

coffee_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_hyper_PL)
coffee_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = coffee_super_PL)


cookie_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_hyper_PL)
cookie_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cookie_super_PL)


cream_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_hyper_PL)
cream_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_super_PL)
cream_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = cream_conve_PL)

frozenpizz_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = frozenpizz_hyper_PL)

juice_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_hyper_PL)
juice_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = juice_super_PL)


icecream_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_hyper_PL)
icecream_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = icecream_super_PL)

jam_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_hyper_PL)
jam_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_super_PL)
jam_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = jam_conve_PL)

lactosefree_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_hyper_PL)
lactosefree_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_super_PL)
lactosefree_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = lactosefree_conve_PL)

pastry_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_hyper_PL)
pastry_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = pastry_super_PL)


readymeal_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_hyper_PL)
readymeal_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_super_PL)
readymeal_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = readymeal_conve_PL)

rice_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_hyper_PL)
rice_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = rice_super_PL)


seasoning_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_hyper_PL)
seasoning_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = seasoning_super_PL)


softdrink_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_hyper_PL)
softdrink_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = softdrink_super_PL)


yoghurt_hyper_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_hyper_PL)
yoghurt_super_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_super_PL)
yoghurt_conve_PL_est_onlyprice <- discountnonlinearest_PL_nothreshold_onlyprice(df = yoghurt_conve_PL)
```
