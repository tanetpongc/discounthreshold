---
title: "Managebrandandcategorydata"
author: "Ned"
date: "22/12/2021"
output: pdf_document
---

```{r setup and require library, include=FALSE, WARNING = FALSE}
library(plyr) #for revalue function for brand
library(dplyr) #for mutate factor level of brand and shapiro-wilk test
library("ggpubr")
library(data.table) #for set DT checking brand
library(car) #function for testing coefficient equivalence
library(lmtest) #function for testing nonlinearity
require(nnet) #for multinomial regression
```

```{r read data, include=FALSE}
df_scanner <- read.csv("../../../../data/df_scanner_butikid.csv")
df_holiday <- read.csv("../../../../data/weeklyholiday.csv")
```

```{r rename all brand, include=FALSE}
df_scanner$brand<- revalue(df_scanner$brand, c(
            #bakingingredient
              "Dr.OETKER"="Dr.Oetker",
              "KUNG MARKATTA" = "Kung markatta",
              "ODENSE" = "Odense",
            #bathproducts
              "DEPEND"="Depend",
              "DETTOL" = "Dettol",
              "Dove Men Care" = "Dove",
              "HAWAIIAN TROPIC" = "Hawaiian Tropic",
              "NEEDS" = "Needs",
              "NIVEA" = "Nivea",
              "Nivea Body" = "Nivea",
              "Nivea Face" = "Nivea",
              "NIVEA FACE" = "Nivea",
              "Nivea Lip" = "Nivea",
              "Nivea Men" = "Nivea",
              "Nivea Shower" = "Nivea",
              "OLAY" = "Olay",
              "PALMETTEN" = "Palmetten",
              "PALMOLIVE" = "Palmolive",
            #Bottled water
              "BONAQUA SILVER"="bonaqua silver",
            #Canned Soup
              "FELIX"="felix",
              "HEINZ" = "Heinz",
            #Canned Vegg
              "FONTANA"="Fontana",
            #Cereals
              "HONEY MONSTER"="Honey Monster",
              "KUNG MARKATTA"="Kung markatta",
              "Paulun"="Pauluns",
              "QUAKER"="Quaker",
              "RenÃ©e Voltaire"="ReneeVoltaire", "RENÃ‰E VOLTAIRE"="ReneeVoltaire",
            #Chips
              "CRISPY"="Crispy",
              "ESTRELLA" = "Estrella",
              "GÃ…RDSCHIPS" = "GÃ¥rdschips",
              "OLW" = "Olw",
              "PRIMA" = "Prima",
              "ROOTFRUIT" = "Rootfruit",
            #Chocolate
              "Droste"="DROSTE",
              "FAZER" = "Fazer",
              "LINDT" = "Lindt",
              "MALTESERS" = "Maltesers",
              "MARABOU" = "Marabou",
              "PLAMIL" = "Plamil",
              "QUICK MILK" = "Quick Milk",
              "RITTER SPORT" = "Ritter Sport",
            #cleaningProducts
              "AIR WICK"="Air Wick",
              "CILLIT BANG" = "Cillit Bang",
              "TOMIK" = "Tomik",
            #Coffees
              "DOLCE GUSTO"="Dolce Gusto",
              "LÃ–FBERGS" = "LÃ¶fbergs",
              "LAVAZZA" = "Lavazza",
            #cookies
              "MC VITIES"="Mc Vities",
              "MARYLAND" = "Maryland",
            #cream
              "ARLA"="Arla",
              "LINDAHLS" = "Lindahls",
            #Dishwasher & washing up
              "FINISH"="Finish",
            #FrozenPizza
              "BILLYS"="Billys",
            #Fruitjuice
              "FONTANA"="Fontana",
              "BRAVO" = "Bravo",
              "Froosh" = "Froosh",
              "GLOCKENGOLD" = "glockengold",
              "GLOCKEN GOLD" = "glockengold",
              "KIVIKS" = "Kiviks",
              "Loviseberg" = "LOVISEBERG",
              "PURE" = "Pure",
              "RYNKEBY" = "Runkeby",
            #Icecream
              "Ã–STERHAGENGLASS"="Ã–STERHAGEN",
              "ALVESTAGLASS" = "ALVESTA GLASS",
              "BEN & JERRYS" = "Ben & Jerrys",
              "CORNETTO" = "Cornetto",
              "GB GLACE" = "GB Glace",
              "HÃ„AGEN DAZS" = "HÃ¤agen Dazs",
              "HÃ„AGEN-DAZS" = "HÃ¤agen Dazs",
              "KLINGS" = "KLING",
              "KLINGS GLASS" = "KLING", 
              "SIA" = "SIA Glass",
              "TRIUMF GLASS" = "Triumf Glass",
              "Yollibox" = "YOLLIBOX",
            #Jam
              "SKIPPY"="Skippy",
            #Laundry
              "SOFTLAN"="Softlan",
            #ReadyMadeMeal
              "BIOFOOD"="Biofood",
              "MONINI" = "Monini",
            #Softdrinks
              "COCA-COLA"="Coca-Cola",
              "COCA COLA"="Coca-Cola",
              "Coca-Cola life"="Coca-Cola",
              "FANTA" = "Fanta",
              "Fanta Zero" = "Fanta",
              "MOUNTAIN DEW" = "Mountain Dew",
              "PEPSI" = "Pepsi",
              "SAN PELLEGRINO"="San Pellegrino",
              "Sodastream EXTERN" = "Sodastream",
              "Sprite Zero"="Sprite",
              "Three Hearts"="THREE HEARTS",
            #Sweetandcandies
              "BUBS"="Bubs",
              "Carletti"="CARLETTI",
              "COTE D OR"="Cote d Or",
              "EKORRENS" = "Ekorrens",
              "FAZER" = "Fazer",
              "HARIBO" = "Haribo",
              "KONFEKTA" = "Konfekta",
              "KOUVOLAN"="Kouvolan",
              "LINDT" = "Lindt",
              "MARABOU"="Marabou",
              "MARS"="Mars",
              "NESTLE" = "Nestle",
              "SNICKERS" = "Snickers",
              "TWIX" = "Twix",
              "TOMS" = "Toms",
            #Tobacco
              "BIC"="Bic",
              "BLEND"="Blend",
              "CAMEL"="Camel",
              "CRICKET" = "Cricket",
              "GÃ–TEBORGS" = "GÃ¶teborgs",
              "GÃ¶teborgs" = "Gateborgs",
              "GENERAL" = "General",
              "JOHN SILVER" = "John Silver",
              "KALIBER"="Kaliber",
              "LEVEL" = "Level",
              "MARLBORO"="Marlboro",
              "PRINCE"="Prince",
              "RIGHT" = "Right",
              "WINSTON" = "Winston",
            #Toiletries
              "EKULF"="Ekulf",
              "JORDAN"="Jordan",
              "LISTERINE"="Listerine",
              "PEPSODENT" = "Pepsodent",
              "SENSODYNE" = "Sensodyne",
            #yogurt
              "ARLA KO"="Arla Ko",
              "FjÃ¤llyoghurt"="FjÃ¤llfil"
              ))
```



```{r select offline and drop unexplainablevalue}
df_online <- subset(df_scanner, saljkanal == 1)
message(paste("The total number of weekly online sold:", dim(df_online)[1]))
df_offline <- subset(df_scanner, saljkanal == 0)
message(paste("The total number of weekly offline sold:", dim(df_offline)[1]))
#dropdecimal and non-integer

df <- df_offline[df_offline$sales_volume>=1,]
df <- df_offline[!df$sales_volume%%1,]

message(paste("The total n before dropping decimal and non-integer:", dim(df_offline)[1]))
message(paste("The total n after dropping decimal and non-integer:", dim(df)[1]))


remove(list=c("df_scanner", "df_online","df_offline"))

```

#Function of filtering brand

```{r define function for filtering brand with complete (153) observations}
brandfiltering_format <- function(df,format,category,nweek){
  df_format_category <- df[df$category == category & df$format == format,]
  brandsalecount<-setDT(df_format_category)[, .N, .(vecka,brand,format)]
  brandweeksalestime<-setDT(brandsalecount)[, .N, .(brand,format)]#we count if the brand got shown in the scanner 
  brandcompleteweek<-subset(brandweeksalestime, N >= nweek)
  brandcompleteweek <- brandcompleteweek %>% mutate(brand=droplevels(brand))
  
distinctbrandcomplete<-unique(brandcompleteweek$brand)
message(paste("# of remaining brands for",category,"in",format,":", dim(brandcompleteweek)[1],"(from",length(unique(df_format_category$brand)),")"))

df_format_category_complete <- df_format_category[df_format_category$brand %in% brandcompleteweek$brand, ]
df_format_category_complete <- df_format_category_complete %>% mutate(brand=droplevels(brand))
nobsbeforedrop <- dim(df_format_category)[1]
nobsafterdrop <- dim(df_format_category_complete)[1]
message(paste("% of obs. maintain:", (nobsafterdrop/nobsbeforedrop)*100))

return(df_format_category_complete)
}
```


#Function of creating relevant variables

```{r create trend variable, include=FALSE}
#very bad way of doing
df_holiday<-df_holiday [order(df_holiday$vecka),]
df_holiday$trend <- seq(1:length(unique(df_holiday$vecka)))
```

  We create a function ``genrelevantvar`` that generates 1) calculate aggregate brand price/discount/unit sales of each brand from sales-weighted average across its SKUs sold in period t 2) calculated (aggregated) competitive variables and 3) generate lag variable 4) first difference of log of relevant variables (dropped the t = 1) 5) generate holiday (0/1)
  

```{r calculate the brand price related variables and linelength or our main IV, echo=FALSE}

make_copula <- function(x) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-.0000001), qnorm(ecdf(x)(x))))}

genrelevantvar <- function(df){
  
#create own price
#Price of brand b in period t, computed as a sales-weighted average across its SKUs sold in period t
df$pricebeforeperunit <- df$spendingbeforedisc/df$sales_volume
df$finalpriceperunit <- df$finalspending/df$sales_volume
df$discountperunit <- df$totaldiscount/df$sales_volume
df$nonpricecampaign <- ifelse(df$totaldiscount == 0 & df$week_campaign > 0, 1, 0)
df$pricecampaign <- ifelse(df$totaldiscount != 0 & df$week_campaign > 0, 1, 0)
#calculated weight
weeklysalesbybrand<-setDT(df)[, .(totalsales=sum(sales_volume),LL=uniqueN(produkt_id),totalnonpricecampaign=sum(nonpricecampaign),totalpricecampaign=sum(pricecampaign)), .(vecka,brand,format)] #this will return n brand x 3 formats x 153 weeks
df_weightcalc <- merge(df,weeklysalesbybrand, by=c("vecka","brand","format"))
df_weightcalc$wp <- df_weightcalc$sales_volume/df_weightcalc$totalsales
    # check<-setDT(df_weightcalc)[, .(totalwp=sum(wp)), .(vecka,brand,format)] #check if weight sum to 1
df_weightcalc$avgpricebefore <- df_weightcalc$pricebeforeperunit*df_weightcalc$wp
df_weightcalc$avgfinalprice <- df_weightcalc$finalpriceperunit*df_weightcalc$wp
df_weightcalc$avgdiscount <- df_weightcalc$discountperunit*df_weightcalc$wp
df_bybrand <- setDT(df_weightcalc)[, .(totalvolume=sum(sales_volume),totalvalue=sum(finalspending),LL=mean(LL),avgpricebefore=sum(avgpricebefore),avgfinalprice=sum(avgfinalprice),avgdiscount=sum(avgdiscount),totalnonpricecampaign=sum(totalnonpricecampaign),totalpricecampaign=sum(totalpricecampaign)), .(vecka,brand,format)]
df_bybrand$nonpricecampaign <- ifelse(df_bybrand$totalnonpricecampaign > 0, 1, 0)
df_bybrand$pricecampaign <- ifelse(df_bybrand$totalpricecampaign > 0, 1, 0)

#create own depth
df_bybrand$depth <- df_bybrand$avgdiscount/df_bybrand$avgpricebefore
df_bybrand$nondepth <- (1-df_bybrand$depth)

#create competitive info


distinctbrandcomplete <- unique(df$brand)
nbrand<-length(distinctbrandcomplete)
nweek<-length(unique(df$vecka))

df_rep <- data.frame(matrix(NA, ncol = 19 , nrow = ((nbrand)*(nweek)))) #create an empty table for iteration information of each brand

#We calculate competitors info for each brand and then replace in the df_rep (rbind each brand)
for (i in 1:length(distinctbrandcomplete)){
df_competitor=df_bybrand[df_bybrand$brand != distinctbrandcomplete[i],]
weeklysalesbycompetingbrand<-setDT(df_competitor)[, .(totalmarketvalue=sum(totalvalue)), .(vecka)]
df_competitorweightcalc <- merge(df_competitor,weeklysalesbycompetingbrand, by=c("vecka"))
df_competitorweightcalc$wp <- df_competitorweightcalc$totalvalue/df_competitorweightcalc$totalmarketvalue
  # check<-setDT(df_competitorweightcalc)[, .(totalwp=sum(wp)), .(vecka)] #check if weight sum to 1
df_competitorweightcalc$avgcompLL <- df_competitorweightcalc$LL*df_competitorweightcalc$wp
df_competitorweightcalc$avgcomppricebefore <- df_competitorweightcalc$avgpricebefore*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompfinalprice <- df_competitorweightcalc$avgfinalprice*df_competitorweightcalc$wp
df_competitorweightcalc$avgcompdiscount <- df_competitorweightcalc$avgdiscount*df_competitorweightcalc$wp
df_competitorinfo <- setDT(df_competitorweightcalc)[, .(avgcompLL=sum(avgcompLL),avgcomppricebefore=sum(avgcomppricebefore), avgcompfinalprice=sum(avgcompfinalprice), avgcompdiscount=sum(avgcompdiscount)), .(vecka)]
df_own=df_bybrand[df_bybrand$brand == distinctbrandcomplete[i],]
df_own <- merge(df_own,df_competitorinfo, by=c("vecka"))
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),] = df_own
df_rep[(1+((i-1)*153)):(153+((i-1)*153)),2] <- toString(distinctbrandcomplete[i])
}
colnames(df_rep) <- colnames(df_own) #replace empty table column name with the original column name
df_rep[,1] <- df_own[,1] #the vecka infor is not replaced so we have to replace from the original table
df_rep$brand<-as.factor(df_rep$brand)
df_bybrand <- df_rep

#generate lag variables
lag_1 <- function(x, k = 1) head(c(rep(NA, k), x), length(x))
df_bybrand<-df_bybrand [order(df_bybrand$brand,df_bybrand$vecka),]
df_bybrand$totalvolume1 <- ave(df_bybrand$totalvolume, df_bybrand$brand, FUN= lag_1)
df_bybrand$totalvalue1 <- ave(df_bybrand$totalvalue, df_bybrand$brand, FUN= lag_1)
df_bybrand$LL1 <- ave(df_bybrand$LL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgfinalprice1 <- ave(df_bybrand$avgfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgpricebefore1 <- ave(df_bybrand$avgpricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgdiscount1 <- ave(df_bybrand$avgdiscount, df_bybrand$brand, FUN= lag_1)
df_bybrand$nondepth1 <- ave(df_bybrand$nondepth, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompLL1 <- ave(df_bybrand$avgcompLL, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompfinalprice1 <- ave(df_bybrand$avgcompfinalprice, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcomppricebefore1 <- ave(df_bybrand$avgcomppricebefore, df_bybrand$brand, FUN= lag_1)
df_bybrand$avgcompdiscount1 <- ave(df_bybrand$avgcompdiscount, df_bybrand$brand, FUN= lag_1)

#create the first difference of log variables
df_bybrand <- na.omit(df_bybrand) #We drop week 0
df_bybrand$dlogtotalvolume <- log(df_bybrand$totalvolume)-log(df_bybrand$totalvolume1)
df_bybrand$dlogavgfinalprice <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$dlogavgpricebefore <- log(df_bybrand$avgpricebefore)-log(df_bybrand$avgpricebefore1)
df_bybrand$dlognondepth <- df_bybrand$nondepth-df_bybrand$nondepth1
df_bybrand$dlogLL = log(df_bybrand$LL) - log(df_bybrand$LL1)
df_bybrand$dlogavgcompLL = log(df_bybrand$avgcompLL) - log(df_bybrand$avgcompLL1)
df_bybrand$dlogavgcompfinalprice = log(df_bybrand$avgcompfinalprice) - log(df_bybrand$avgcompfinalprice1)

#create copula for marketing mix
df_bybrand$cop_finalprice <- make_copula(df_bybrand$avgfinalprice)
df_bybrand$cop_avgcompfinalprice <- make_copula(df_bybrand$avgcompfinalprice)
df_bybrand$cop_logfinalprice <- make_copula(log((df_bybrand$avgfinalprice)))
df_bybrand$cop_logavgcompfinalprice <- make_copula(log(df_bybrand$avgcompfinalprice))

#Gap measure
df_bybrand$hgap <- log(df_bybrand$avgfinalprice)-log(df_bybrand$avgfinalprice1)
df_bybrand$cgap <- ((df_bybrand$avgfinalprice - df_bybrand$avgcompfinalprice)/df_bybrand$avgcompfinalprice)

#create a holiday variable
df_holiday$vecka <- as.factor(df_holiday$vecka)
df_bybrand <- merge(df_bybrand,df_holiday[,2:4], by=c("vecka"))

#add campaign regardless price or nonprice
df_bybrand$campaign <- ifelse(df_bybrand$totalpricecampaign + df_bybrand$totalnonpricecampaign > 0, 1, 0)

return(df_bybrand)
}
```

#Function of testing normality of marketing-mix variable
To see if we need to add copula term to independent variable (namely price)
```{r}
checknormality_price <- function(df){
norm_finalprice <- shapiro.test(df_bottledwater_hyper$avgfinalprice)
message(paste("P-value for normality test of price < 0.05 indicating non-normality:", norm_finalprice$p.value < 0.05))
norm_finalcompprice <- shapiro.test(df_bottledwater_hyper$avgcompfinalprice)
message(paste("P-value for normality test of competitor price < 0.05 indicating non-normality:", norm_finalcompprice$p.value < 0.05))  
}
```

#Function of testing nonlinearity

```{r}
test_nonlinearity_onlyfinalprice_copula <- function(aggregate_df){
  
  distinctbrand_finalprice <- unique(aggregate_df$brand)
  nbrand_finalprice<-length(distinctbrand_finalprice)
  
   
 df_finalprice_lr <- data.frame(matrix(NA, ncol = 8 , nrow = (nbrand_finalprice)))  
  for (i in 1:length(distinctbrand_finalprice)){  
    
#Predicted Long-Run (LR) equilibrium: st_1 = cons + phi1 * pt_1 + et and Estimate the ADL(1,1)-EC model
brand_data = aggregate_df[aggregate_df$brand == distinctbrand_finalprice[i],]
LR_sp <- lm(log(totalvolume1) ~ log(avgfinalprice1), data = brand_data) 
brand_data$et_hat = residuals(LR_sp)

  
lm_finalprice <- lm(dlogtotalvolume ~ dlogavgfinalprice + dlogavgcompfinalprice + campaign + et_hat + holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)


lm_finalprice_priceprice <- lm(dlogtotalvolume ~ dlogavgfinalprice + I(dlogavgfinalprice^2)+ I(dlogavgfinalprice^3) + dlogavgcompfinalprice  + campaign + et_hat+ holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)

lm_finalprice_compgap <- lm(dlogtotalvolume ~ dlogavgfinalprice + dlogavgfinalprice*dlogavgcompfinalprice + dlogavgfinalprice*I(dlogavgcompfinalprice^2) + dlogavgcompfinalprice  + campaign + et_hat + holiday + cop_logfinalprice + cop_logavgcompfinalprice ,data=brand_data)

test_price1 <-lrtest(lm_finalprice, lm_finalprice_priceprice)
test_price2 <-lrtest(lm_finalprice, lm_finalprice_compgap)

df_finalprice_lr[i,1] <- toString(distinctbrand_finalprice[i])
df_finalprice_lr[i,2] = round(test_price1$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,3] = round(test_price2$`Pr(>Chisq)`[2],4)
df_finalprice_lr[i,4] = summary(lm_finalprice)$coefficients[2,1]
df_finalprice_lr[i,5] = summary(lm_finalprice)$coefficients[2,2]
#df_finalprice_lr[i,6] = round(summary(lm_finalprice)$coefficients[10,1]/summary(lm_finalprice)$coefficients[8,1],4)
df_finalprice_lr[i,6] = round(summary(lm_finalprice)$r.squared,4)
#df_finalprice_lr[i,8] = summary(lm_finalprice)$coefficients[4,1]
#df_finalprice_lr[i,9] = summary(lm_finalprice)$coefficients[4,2]
df_finalprice_lr[i,7] = round(summary(lm_finalprice_priceprice)$r.squared,4)
df_finalprice_lr[i,8] = round(summary(lm_finalprice_compgap)$r.squared,4)
}  
  
colnames(df_finalprice_lr) <- c('brand','p-value-LRhist','p-value-LRcomp','Coef Price','Sd Price','RsqLinear','RsqHist','RsqComp')

 #colnames(df_finalprice_lr) <- c('brand','p-value-pricehist','p-value-pricecom','Coef Price','Sd Price','Coef Long','RsqLinearmod','coefprice2','sdprice2')


return(df_finalprice_lr)
  
}
```


#Empirical Test for nonlinearity
```{r Bottled Water}
#Get seperate dataframe
bottledwater_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Bottled water",nweek=153)
bottledwater_super <- brandfiltering_format(df,format = "supermarket",category ="Bottled water",nweek=153)
bottledwater_conve <- brandfiltering_format(df,format = "convenience",category ="Bottled water",nweek=153)

#Create aggregate dataframe
df_bottledwater_hyper <- genrelevantvar(df=bottledwater_hyper)
df_bottledwater_super <- genrelevantvar(df=bottledwater_super)
df_bottledwater_conve <- genrelevantvar(df=bottledwater_conve)

#test nonnormalityfor price
checknormality_price(df=bottledwater_hyper) #can use copula for two
checknormality_price(df=bottledwater_super) #can use copula for two
checknormality_price(df=bottledwater_conve) #can use copula for two

#test nonlinearity
nonlinear_test_bottledwater_hyper <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_bottledwater_hyper)
nonlinear_test_bottledwater_super <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_bottledwater_super)
nonlinear_test_bottledwater_conve <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_bottledwater_conve)

#conclude nonlinearitytest
nonlinear_test_bottledwater_hyper$format <- "hypermarket"
nonlinear_test_bottledwater_super$format <- "supermarket"
nonlinear_test_bottledwater_conve$format <- "convenience"
nonlinearity_bottledwater_result <- rbind(nonlinear_test_bottledwater_hyper,nonlinear_test_bottledwater_super,nonlinear_test_bottledwater_conve)
nonlinearity_bottledwater_result$category <- "Bottled water"
```

```{r Butter}
#Get seperate dataframe
butter_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Butter",nweek=153)
butter_super <- brandfiltering_format(df,format = "supermarket",category ="Butter",nweek=153)
butter_conve <- brandfiltering_format(df,format = "convenience",category ="Butter",nweek=153)

#Create aggregate dataframe
df_butter_hyper <- genrelevantvar(df=butter_hyper)
df_butter_super <- genrelevantvar(df=butter_super)
df_butter_conve <- genrelevantvar(df=butter_conve)

#test nonnormalityfor price
checknormality_price(df=butter_hyper) #can use copula for two
checknormality_price(df=butter_super) #can use copula for two
checknormality_price(df=butter_conve) #can use copula for two

#test nonlinearity
nonlinear_test_butter_hyper <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_butter_hyper)
nonlinear_test_butter_super <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_butter_super)
nonlinear_test_butter_conve <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_butter_conve)


#conclude nonlinearitytest
nonlinear_test_butter_hyper$format <- "hypermarket"
nonlinear_test_butter_super$format <- "supermarket"
nonlinear_test_butter_conve$format <- "convenience"
nonlinearity_butter_result <- rbind(nonlinear_test_butter_hyper,nonlinear_test_butter_super,nonlinear_test_butter_conve)
nonlinearity_butter_result$category <- "Butter"
```

```{r Chips}
#Get seperate dataframe
chips_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chips & Salty snacks",nweek=153)
chips_super <- brandfiltering_format(df,format = "supermarket",category ="Chips & Salty snacks",nweek=153)
chips_conve <- brandfiltering_format(df,format = "convenience",category ="Chips & Salty snacks",nweek=153)

#Create aggregate dataframe
df_chips_hyper <- genrelevantvar(df=chips_hyper)
df_chips_super <- genrelevantvar(df=chips_super)
df_chips_conve <- genrelevantvar(df=chips_conve)

#test nonnormalityfor price
checknormality_price(df=chips_hyper) #can use copula for two
checknormality_price(df=chips_super) #can use copula for two
checknormality_price(df=chips_conve) #can use copula for two

#test nonlinearity
nonlinear_test_chips_hyper <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_chips_hyper)
nonlinear_test_chips_super <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_chips_super)
nonlinear_test_chips_conve <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_chips_conve)

#conclude nonlinearitytest
nonlinear_test_chips_hyper$format <- "hypermarket"
nonlinear_test_chips_super$format <- "supermarket"
nonlinear_test_chips_conve$format <- "convenience"
nonlinearity_chips_result <- rbind(nonlinear_test_chips_hyper,nonlinear_test_chips_super,nonlinear_test_chips_conve)
nonlinearity_chips_result$category <- "Chips & Salty snacks"
```



```{r Chocolate}
#Get seperate dataframe
choco_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Chocolate",nweek=153)
choco_super <- brandfiltering_format(df,format = "supermarket",category ="Chocolate",nweek=153)
choco_conve <- brandfiltering_format(df,format = "convenience",category ="Chocolate",nweek=153)

#Create aggregate dataframe
df_choco_hyper <- genrelevantvar(df=choco_hyper)
df_choco_super <- genrelevantvar(df=choco_super)
df_choco_conve <- genrelevantvar(df=choco_conve)

#test nonnormalityfor price
checknormality_price(df=choco_hyper) #can use copula for two
checknormality_price(df=choco_super) #can use copula for two
checknormality_price(df=choco_conve) #can use copula for two

#test nonlinearity
nonlinear_test_choco_hyper <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_choco_hyper)
nonlinear_test_choco_super <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_choco_super)
nonlinear_test_choco_conve <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_choco_conve)


#conclude nonlinearitytest
nonlinear_test_choco_hyper$format <- "hypermarket"
nonlinear_test_choco_super$format <- "supermarket"
nonlinear_test_choco_conve$format <- "convenience"
nonlinearity_choco_result <- rbind(nonlinear_test_choco_hyper,nonlinear_test_choco_super,nonlinear_test_choco_conve)
nonlinearity_choco_result$category <- "Chocolate"
```

```{r Yoghurt}
#Get seperate dataframe
yoghurt_hyper <- brandfiltering_format(df,format = "hypermarket",category ="Yogurt",nweek=153)
yoghurt_super <- brandfiltering_format(df,format = "supermarket",category ="Yogurt",nweek=153)
yoghurt_conve <- brandfiltering_format(df,format = "convenience",category ="Yogurt",nweek=153)

#We can run for supermarket and hypermarket (Almost for convenience, 74.06%)
#Create aggregate dataframe
df_yoghurt_hyper <- genrelevantvar(df=yoghurt_hyper)
df_yoghurt_super <- genrelevantvar(df=yoghurt_super)
df_yoghurt_conve <- genrelevantvar(df=yoghurt_conve)

#test nonnormalityfor price
checknormality_price(df=yoghurt_hyper) #can use copula for two
checknormality_price(df=yoghurt_super) #can use copula for two
checknormality_price(df=yoghurt_conve) #can use copula for two

#test nonlinearity
nonlinear_test_yoghurt_hyper <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_yoghurt_hyper)
nonlinear_test_yoghurt_super <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_yoghurt_super)
nonlinear_test_yoghurt_conve <- test_nonlinearity_onlyfinalprice_copula(aggregate_df = df_yoghurt_conve)

#conclude nonlinearitytest
nonlinear_test_yoghurt_hyper$format <- "hypermarket"
nonlinear_test_yoghurt_super$format <- "supermarket"
nonlinear_test_yoghurt_conve$format <- "convenience"
nonlinearity_yoghurt_result <- rbind(nonlinear_test_yoghurt_hyper,nonlinear_test_yoghurt_super,nonlinear_test_yoghurt_conve)

nonlinearity_yoghurt_result$category <- "Yogurt"
```

```{r preliminary result of nonlinearity}
Prelim_table<- rbind(nonlinearity_bottledwater_result,nonlinearity_butter_result,nonlinearity_chips_result,nonlinearity_choco_result,nonlinearity_yoghurt_result)

#add decision making
Prelim_table$modeldecision <- "linearity"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` < 0.10 & Prelim_table$`p-value-LRcomp` < 0.10] <- "fullmodel"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` < 0.10 & Prelim_table$`p-value-LRcomp` >= 0.10] <- "histgap"
Prelim_table$modeldecision[Prelim_table$`p-value-LRhist` >= 0.10 & Prelim_table$`p-value-LRcomp` < 0.10] <- "compgap"

write.csv(Prelim_table,"C:/Users/TA.4621/Desktop/2021/DiscountThreshold/WorkingRepo/src/analysis/nonlinear_byformat/price threshold/prelimnonlinear_10per_230520.csv", row.names = TRUE)

Summary <- setDT(Prelim_table)[, .N, by=.(modeldecision,format,category)]

summary_format <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision,format)]
summary_category <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision,category)]
summary_total <- setDT(Summary)[, .(total=sum(N)), by=.(modeldecision)]
```
